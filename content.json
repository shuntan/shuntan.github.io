{"meta":{"title":"Shawntan's Blog","subtitle":"Segmentfault","description":"shawntan@tencent.com","author":"Shawntan","url":"https://shuntan.github.io"},"pages":[{},{},{}],"posts":[{"title":"test TOC","date":"2019-06-22T06:16:57.000Z","path":"posts/test/","text":"This is H1test H1 This is H1fftest H1 This is H2test H2 This is H3 std::mutex std::recursive_mutex std::time_mutex std::recursive_timed_mutex This is H4test H4","raw":"---\ntitle: test TOC\nabbrlink: '46e17093'\ndate: 2019-06-22 14:16:57\ncopyright: true\ntags:\ncategories:\ndescription:\n---\n\n## This is H1\n\ntest H1\n\n## This is H1ff\n\ntest H1\n\n## This is H2\n\ntest H2\n\n### This is  H3\n\n- std::mutex\n\n- std::recursive_mutex\n\n- std::time_mutex\n\n- std::recursive_timed_mutex\n\n<!-- more -->\n\n####  This is  H4\n\ntest H4\n","content":"<h2 id=\"This-is-H1\">This is H1<a href=\"post/test#This-is-H1\"></a></h2><p>test H1</p>\n<h2 id=\"This-is-H1ff\">This is H1ff<a href=\"post/test#This-is-H1ff\"></a></h2><p>test H1</p>\n<h2 id=\"This-is-H2\">This is H2<a href=\"post/test#This-is-H2\"></a></h2><p>test H2</p>\n<h3 id=\"This-is-H3\">This is  H3<a href=\"post/test#This-is-H3\"></a></h3><ul>\n<li><p>std::mutex</p>\n</li>\n<li><p>std::recursive_mutex</p>\n</li>\n<li><p>std::time_mutex</p>\n</li>\n<li><p>std::recursive_timed_mutex</p>\n</li>\n</ul>\n<a id=\"more\"></a>\n\n<h4 id=\"This-is-H4\">This is  H4<a href=\"post/test#This-is-H4\"></a></h4><p>test H4</p>\n","slug":"test","updated":"2019-06-30T01:36:34.197Z","comments":true,"link":"post/test","permalink":"https://shuntan.github.io/posts/test/","excerpt":"This is H1test H1 This is H1fftest H1 This is H2test H2 This is H3 std::mutex std::recursive_mutex std::time_mutex std::recursive_timed_mutex","categories":[],"tags":[]},{"title":"mutexå¤´æ–‡ä»¶ä»‹ç»","date":"2019-06-14T03:00:47.000Z","path":"posts/Mutexä»‹ç»/","text":"HeadMutex åˆç§°äº’æ–¥é‡ï¼ŒC++ 11ä¸­ä¸ Mutex ç›¸å…³çš„ç±»ï¼ˆåŒ…æ‹¬é”ç±»å‹ï¼‰å’Œå‡½æ•°éƒ½å£°æ˜åœ¨ å¤´æ–‡ä»¶ä¸­ï¼Œæ‰€ä»¥å¦‚æœä½ éœ€è¦ä½¿ç”¨ std::mutexï¼Œå°±å¿…é¡»åŒ…å« å¤´æ–‡ä»¶ã€‚ å¤´æ–‡ä»¶ä»‹ç»ewde2e Mutex ç³»åˆ—ç±»(å››ç§) std::mutexï¼Œæœ€åŸºæœ¬çš„ Mutex ç±»ã€‚ std::recursive_mutexï¼Œé€’å½’ Mutex ç±»ã€‚ std::time_mutexï¼Œå®šæ—¶ Mutex ç±»ã€‚ std::recursive_timed_mutexï¼Œå®šæ—¶é€’å½’ Mutex ç±»ã€‚ Lock ç±»ï¼ˆä¸¤ç§ï¼‰ std::lock_guardï¼Œä¸ Mutex RAII ç›¸å…³ï¼Œæ–¹ä¾¿çº¿ç¨‹å¯¹äº’æ–¥é‡ä¸Šé”ã€‚ std::unique_lockï¼Œä¸ Mutex RAII ç›¸å…³ï¼Œæ–¹ä¾¿çº¿ç¨‹å¯¹äº’æ–¥é‡ä¸Šé”ï¼Œä½†æä¾›äº†æ›´å¥½çš„ä¸Šé”å’Œè§£é”æ§åˆ¶ã€‚ å…¶ä»–ç±»å‹ std::once_flag std::adopt_lock_t std::defer_lock_t std::try_to_lock_t å‡½æ•° std::try_lockï¼Œå°è¯•åŒæ—¶å¯¹å¤šä¸ªäº’æ–¥é‡ä¸Šé”ã€‚ std::lockï¼Œå¯ä»¥åŒæ—¶å¯¹å¤šä¸ªäº’æ–¥é‡ä¸Šé”ã€‚ std::call_onceï¼Œå¦‚æœå¤šä¸ªçº¿ç¨‹éœ€è¦åŒæ—¶è°ƒç”¨æŸä¸ªå‡½æ•°ï¼Œcall_once å¯ä»¥ä¿è¯å¤šä¸ªçº¿ç¨‹å¯¹è¯¥å‡½æ•°åªè°ƒç”¨ä¸€æ¬¡ã€‚ std::mutex ä»‹ç»ä¸‹é¢ä»¥ std::mutex ä¸ºä¾‹ä»‹ç» C++11 ä¸­çš„äº’æ–¥é‡ç”¨æ³•ã€‚ std::mutex æ˜¯C++11 ä¸­æœ€åŸºæœ¬çš„äº’æ–¥é‡ï¼Œstd::mutex å¯¹è±¡æä¾›äº†ç‹¬å æ‰€æœ‰æƒçš„ç‰¹æ€§â€”â€”å³ä¸æ”¯æŒé€’å½’åœ°å¯¹ std::mutex å¯¹è±¡ä¸Šé”ï¼Œè€Œ std::recursive_lock åˆ™å¯ä»¥é€’å½’åœ°å¯¹äº’æ–¥é‡å¯¹è±¡ä¸Šé”ã€‚ std::mutex çš„æˆå‘˜å‡½æ•° æ„é€ å‡½æ•°ï¼Œstd::mutexä¸å…è®¸æ‹·è´æ„é€ ï¼Œä¹Ÿä¸å…è®¸ move æ‹·è´ï¼Œæœ€åˆäº§ç”Ÿçš„ mutex å¯¹è±¡æ˜¯å¤„äº unlocked çŠ¶æ€çš„ã€‚ lock()ï¼Œè°ƒç”¨çº¿ç¨‹å°†é”ä½è¯¥äº’æ–¥é‡ã€‚çº¿ç¨‹è°ƒç”¨è¯¥å‡½æ•°ä¼šå‘ç”Ÿä¸‹é¢ 3 ç§æƒ…å†µï¼š(1). å¦‚æœè¯¥äº’æ–¥é‡å½“å‰æ²¡æœ‰è¢«é”ä½ï¼Œåˆ™è°ƒç”¨çº¿ç¨‹å°†è¯¥äº’æ–¥é‡é”ä½ï¼Œç›´åˆ°è°ƒç”¨ unlockä¹‹å‰ï¼Œè¯¥çº¿ç¨‹ä¸€ç›´æ‹¥æœ‰è¯¥é”ã€‚(2). å¦‚æœå½“å‰äº’æ–¥é‡è¢«å…¶ä»–çº¿ç¨‹é”ä½ï¼Œåˆ™å½“å‰çš„è°ƒç”¨çº¿ç¨‹è¢«é˜»å¡ä½ã€‚(3). å¦‚æœå½“å‰äº’æ–¥é‡è¢«å½“å‰è°ƒç”¨çº¿ç¨‹é”ä½ï¼Œåˆ™ä¼šäº§ç”Ÿæ­»é”(deadlock)ã€‚ unlock()ï¼Œ è§£é”ï¼Œé‡Šæ”¾å¯¹äº’æ–¥é‡çš„æ‰€æœ‰æƒã€‚ try_lock()ï¼Œå°è¯•é”ä½äº’æ–¥é‡ï¼Œå¦‚æœäº’æ–¥é‡è¢«å…¶ä»–çº¿ç¨‹å æœ‰ï¼Œåˆ™å½“å‰çº¿ç¨‹ä¹Ÿä¸ä¼šè¢«é˜»å¡ã€‚çº¿ç¨‹è°ƒç”¨è¯¥å‡½æ•°ä¹Ÿä¼šå‡ºç°ä¸‹é¢ 3 ç§æƒ…å†µï¼Œ(1). å¦‚æœå½“å‰äº’æ–¥é‡æ²¡æœ‰è¢«å…¶ä»–çº¿ç¨‹å æœ‰ï¼Œåˆ™è¯¥çº¿ç¨‹é”ä½äº’æ–¥é‡ï¼Œç›´åˆ°è¯¥çº¿ç¨‹è°ƒç”¨ unlock é‡Šæ”¾äº’æ–¥é‡ã€‚(2). å¦‚æœå½“å‰äº’æ–¥é‡è¢«å…¶ä»–çº¿ç¨‹é”ä½ï¼Œåˆ™å½“å‰è°ƒç”¨çº¿ç¨‹è¿”å› falseï¼Œè€Œå¹¶ä¸ä¼šè¢«é˜»å¡æ‰ã€‚(3). å¦‚æœå½“å‰äº’æ–¥é‡è¢«å½“å‰è°ƒç”¨çº¿ç¨‹é”ä½ï¼Œåˆ™ä¼šäº§ç”Ÿæ­»é”(deadlock)ã€‚ ä¸‹é¢ç»™å‡ºä¸€ä¸ªä¸ std::mutex çš„å°ä¾‹å­ï¼ˆå‚è€ƒï¼‰ 1234567891011121314151617181920212223242526#include &lt;iostream&gt; // std::cout#include &lt;thread&gt; // std::thread#include &lt;mutex&gt; // std::mutexvolatile int counter(0); // non-atomic counterstd::mutex mtx; // locks access to countervoid attempt_10k_increases() &#123; for (int i=0; i&lt;10000; ++i) &#123; if (mtx.try_lock()) &#123; // only increase if currently not locked: ++counter; mtx.unlock(); &#125; &#125;&#125;int main (int argc, const char* argv[]) &#123; std::thread threads[10]; for (int i=0; i&lt;10; ++i) threads[i] = std::thread(attempt_10k_increases); for (auto&amp; th : threads) th.join(); std::cout &lt;&lt; counter &lt;&lt; \" successful increases of the counter.\\n\"; return 0;&#125; è¾“å‡ºç»“æœï¼š 123$g++ -lpthread -std=c++11 -o main *.cpp$main9012 successful increases of the counter. å¯ä»¥çœ‹å‡ºæœ‰å¾ˆå¤šæ¬¡mtx.try_lock()è¿”å›äº†falseï¼Œå¹¶æ²¡æœ‰æ‰§è¡Œ++counteræ“ä½œã€‚ å¦‚æœæŠŠmtx.try_lock()æ”¹æˆmtx.lock()ï¼Œåˆ™å¿…å®šä¼šé˜»å¡å…¶ä»–çº¿ç¨‹ã€‚ è¾“å‡ºç»“æœ2: 123$g++ -lpthread -std=c++11 -o main *.cpp$main100000 successful increases of the counter. std::recursive_mutex ä»‹ç»std::recursive_mutex ä¸ std::mutex ä¸€æ ·ï¼Œä¹Ÿæ˜¯ä¸€ç§å¯ä»¥è¢«ä¸Šé”çš„å¯¹è±¡ï¼Œä½†æ˜¯å’Œ std::mutex ä¸åŒçš„æ˜¯ï¼Œstd::recursive_mutex å…è®¸åŒä¸€ä¸ªçº¿ç¨‹å¯¹äº’æ–¥é‡å¤šæ¬¡ä¸Šé”ï¼ˆå³é€’å½’ä¸Šé”ï¼‰ï¼Œæ¥è·å¾—å¯¹äº’æ–¥é‡å¯¹è±¡çš„å¤šå±‚æ‰€æœ‰æƒï¼Œstd::recursive_mutex é‡Šæ”¾äº’æ–¥é‡æ—¶éœ€è¦è°ƒç”¨ä¸è¯¥é”å±‚æ¬¡æ·±åº¦ç›¸åŒæ¬¡æ•°çš„ unlock()ï¼Œå¯ç†è§£ä¸º lock() æ¬¡æ•°å’Œ unlock() æ¬¡æ•°ç›¸åŒï¼Œé™¤æ­¤ä¹‹å¤–ï¼Œstd::recursive_mutex çš„ç‰¹æ€§å’Œ std::mutex å¤§è‡´ç›¸åŒã€‚ 12345678910111213141516171819202122232425#include &lt;iostream&gt; // std::cout#include &lt;thread&gt; // std::thread#include &lt;mutex&gt; // std::mutexvolatile int counter(0); // non-atomic counterstd::recursive_mutex rmtx; // locks access to countervoid attempt_1k_increases() &#123; for (int i=0; i&lt;10000; ++i) &#123; rmtx.lock(); ++counter; &#125; for (int i=0; i&lt;10000; ++i) &#123; counter-=2; rmtx.unlock(); &#125;&#125;int main (int argc, const char* argv[]) &#123; auto th = std::thread(attempt_1k_increases); th.join(); std::cout &lt;&lt; counter &lt;&lt; \" successful increases of the counter.\\n\"; return 0;&#125; è¾“å‡ºç»“æœï¼š 123$g++ -lpthread -o main *.cpp$main-10000 successful increases of the counter. std::time_mutex ä»‹ç»std::time_mutex æ¯” std::mutex å¤šäº†ä¸¤ä¸ªæˆå‘˜å‡½æ•°ï¼Œtry_lock_for()ï¼Œtry_lock_until()ã€‚ try_lock_for å‡½æ•°æ¥å—ä¸€ä¸ªæ—¶é—´èŒƒå›´ï¼Œè¡¨ç¤ºåœ¨è¿™ä¸€æ®µæ—¶é—´èŒƒå›´ä¹‹å†…çº¿ç¨‹å¦‚æœæ²¡æœ‰è·å¾—é”åˆ™è¢«é˜»å¡ä½ï¼ˆä¸ std::mutex çš„ try_lock() ä¸åŒï¼Œtry_lock å¦‚æœè¢«è°ƒç”¨æ—¶æ²¡æœ‰è·å¾—é”åˆ™ç›´æ¥è¿”å› falseï¼‰ï¼Œå¦‚æœåœ¨æ­¤æœŸé—´å…¶ä»–çº¿ç¨‹é‡Šæ”¾äº†é”ï¼Œåˆ™è¯¥çº¿ç¨‹å¯ä»¥è·å¾—å¯¹äº’æ–¥é‡çš„é”ï¼Œå¦‚æœè¶…æ—¶ï¼ˆå³åœ¨æŒ‡å®šæ—¶é—´å†…è¿˜æ˜¯æ²¡æœ‰è·å¾—é”ï¼‰ï¼Œåˆ™è¿”å› falseã€‚ try_lock_until å‡½æ•°åˆ™æ¥å—ä¸€ä¸ªæ—¶é—´ç‚¹ä½œä¸ºå‚æ•°ï¼Œåœ¨æŒ‡å®šæ—¶é—´ç‚¹æœªåˆ°æ¥ä¹‹å‰çº¿ç¨‹å¦‚æœæ²¡æœ‰è·å¾—é”åˆ™è¢«é˜»å¡ä½ï¼Œå¦‚æœåœ¨æ­¤æœŸé—´å…¶ä»–çº¿ç¨‹é‡Šæ”¾äº†é”ï¼Œåˆ™è¯¥çº¿ç¨‹å¯ä»¥è·å¾—å¯¹äº’æ–¥é‡çš„é”ï¼Œå¦‚æœè¶…æ—¶ï¼ˆå³åœ¨æŒ‡å®šæ—¶é—´å†…è¿˜æ˜¯æ²¡æœ‰è·å¾—é”ï¼‰ï¼Œåˆ™è¿”å› falseã€‚ ä¸‹é¢çš„å°ä¾‹å­è¯´æ˜äº† std::time_mutex çš„ç”¨æ³•ï¼ˆå‚è€ƒï¼‰ã€‚ 1234567891011121314151617181920212223242526272829#include &lt;iostream&gt; // std::cout#include &lt;chrono&gt; // std::chrono::milliseconds#include &lt;thread&gt; // std::thread#include &lt;mutex&gt; // std::timed_mutexstd::timed_mutex mtx;void fireworks() &#123; // waiting to get a lock: each thread prints \"-\" every 200ms: while (!mtx.try_lock_for(std::chrono::milliseconds(200))) &#123; std::cout &lt;&lt; \"-\"; &#125; // got a lock! - wait for 1s, then this thread prints \"*\" std::this_thread::sleep_for(std::chrono::milliseconds(1000)); std::cout &lt;&lt; \"*\\n\"; mtx.unlock();&#125;int main ()&#123; std::thread threads[10]; // spawn 10 threads: for (int i=0; i&lt;10; ++i) threads[i] = std::thread(fireworks); for (auto&amp; th : threads) th.join(); return 0;&#125; è¾“å‡ºç»“æœï¼š çº¿ç¨‹è¾“å‡º*è¡¨ç¤ºè¯¥çº¿ç¨‹å·²ç»æ­£å¸¸é€€å‡ºï¼Œå¹¶ä¸”é‡Šæ”¾è¯¥é”ã€‚å¦åˆ™å°†æ¯200mså°è¯•è·å–mutexğŸ”’ï¼Œç›´åˆ°æˆåŠŸä¸ºæ­¢ã€‚ std::recursive_timed_mutex ä»‹ç»å’Œ std:recursive_mutex ä¸ std::mutex çš„å…³ç³»ä¸€æ ·ï¼Œstd::recursive_timed_mutex çš„ç‰¹æ€§ä¹Ÿå¯ä»¥ä» std::timed_mutex æ¨å¯¼å‡ºæ¥ï¼Œæ„Ÿå…´è¶£çš„åŒé‹å¯ä»¥è‡ªè¡ŒæŸ¥é˜…ã€‚ ;-) std::lock_guard ä»‹ç»ä¸ Mutex RAII ç›¸å…³ï¼Œæ–¹ä¾¿çº¿ç¨‹å¯¹äº’æ–¥é‡ä¸Šé”ã€‚ä¾‹å­ï¼ˆå‚è€ƒï¼‰: 1.std::lock_guard åœ¨æ„é€ å‡½æ•°ä¸­è¿›è¡ŒåŠ é”ï¼Œææ„å‡½æ•°ä¸­è¿›è¡Œè§£é”ã€‚ 2.é”åœ¨å¤šçº¿ç¨‹ç¼–ç¨‹ä¸­ï¼Œä½¿ç”¨è¾ƒå¤šï¼Œå› æ­¤c++11æä¾›äº†lock_guardæ¨¡æ¿ç±»ï¼›åœ¨å®é™…ç¼–ç¨‹ä¸­ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥æ ¹æ®è‡ªå·±çš„åœºæ™¯ç¼–å†™resource_guard RAIIç±»ï¼Œé¿å…å¿˜æ‰é‡Šæ”¾èµ„æºã€‚ 12345678910111213141516171819202122232425262728293031323334#include &lt;iostream&gt; // std::cout#include &lt;thread&gt; // std::thread#include &lt;mutex&gt; // std::mutex, std::lock_guard#include &lt;stdexcept&gt; // std::logic_errorstd::mutex mtx;void print_even (int x) &#123; if (x%2==0) std::cout &lt;&lt; x &lt;&lt; \" is even\\n\"; else throw (std::logic_error(\"not even\"));&#125;void print_thread_id (int id) &#123; try &#123; // using a local lock_guard to lock mtx guarantees unlocking on destruction / exception: std::lock_guard&lt;std::mutex&gt; lck (mtx); print_even(id); &#125; catch (std::logic_error&amp;) &#123; std::cout &lt;&lt; \"[exception caught]\\n\"; &#125;&#125;int main ()&#123; std::thread threads[10]; // spawn 10 threads: for (int i=0; i&lt;10; ++i) threads[i] = std::thread(print_thread_id,i+1); for (auto&amp; th : threads) th.join(); return 0;&#125; è¾“å‡ºç»“æœï¼š 123456789101112$g++ -lpthread -o main *.cpp$main[exception caught]4 is even[exception caught]2 is even[exception caught]6 is even8 is even[exception caught][exception caught]10 is even std::unique_lock ä»‹ç»ä¸ Mutex RAII ç›¸å…³ï¼Œæ–¹ä¾¿çº¿ç¨‹å¯¹äº’æ–¥é‡ä¸Šé”ï¼Œä½†æä¾›äº†æ›´å¥½çš„ä¸Šé”å’Œè§£é”æ§åˆ¶ã€‚ä¾‹å­ï¼ˆå‚è€ƒï¼‰ï¼š 1.ç±» unique_lock æ˜¯é€šç”¨äº’æ–¥åŒ…è£…å™¨ï¼Œå…è®¸å»¶è¿Ÿé”å®šã€é”å®šçš„æœ‰æ—¶é™å°è¯•ã€é€’å½’é”å®šã€æ‰€æœ‰æƒè½¬ç§»å’Œä¸æ¡ä»¶å˜é‡ä¸€åŒä½¿ç”¨ã€‚ 2.unique_lockæ¯”lock_guardä½¿ç”¨æ›´åŠ çµæ´»ï¼ŒåŠŸèƒ½æ›´åŠ å¼ºå¤§ã€‚ä½¿ç”¨unique_lockéœ€è¦ä»˜å‡ºæ›´å¤šçš„æ—¶é—´ã€æ€§èƒ½æˆæœ¬ã€‚ 12345678910111213141516171819202122232425#include &lt;iostream&gt; // std::cout#include &lt;thread&gt; // std::thread#include &lt;mutex&gt; // std::mutex, std::unique_lockstd::mutex mtx; // mutex for critical sectionvoid print_block (int n, char c) &#123; // critical section (exclusive access to std::cout signaled by lifetime of lck): std::unique_lock&lt;std::mutex&gt; lck (mtx); for (int i=0; i&lt;n; ++i) &#123; std::cout &lt;&lt; c; &#125; std::cout &lt;&lt; '\\n';&#125;int main ()&#123; std::thread th1 (print_block,50,'*'); std::thread th2 (print_block,50,'$'); th1.join(); th2.join(); return 0;&#125; è¾“å‡ºç»“æœï¼š 1234$g++ -lpthread -o main *.cpp$main**************************************************$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$ å¥½äº†ï¼Œæœ¬æ–‡æš‚æ—¶è®²åˆ°è¿™é‡Œï¼Œè¿˜å‰©ä¸‹ std::try_lockï¼Œstd::lockï¼Œstd::call_once ä¸‰ä¸ªå‡½æ•°æ²¡æœ‰è®²åˆ°ï¼Œç•™åœ¨ä¸‹ä¸€ç¯‡åšå®¢ä¸­è®²å§ ;-)","raw":"---\ntitle: mutexå¤´æ–‡ä»¶ä»‹ç»\ntags:\n  - C++\n  - Mutex\ncategories: C++\nthumbnail: images/background.jpg\nabbrlink: e32ad4fc\ndate: 2019-06-14 11:00:47\n---\n\n## Head\n\nMutex åˆç§°äº’æ–¥é‡ï¼ŒC++ 11ä¸­ä¸ Mutex ç›¸å…³çš„ç±»ï¼ˆåŒ…æ‹¬é”ç±»å‹ï¼‰å’Œå‡½æ•°éƒ½å£°æ˜åœ¨ <mutex> å¤´æ–‡ä»¶ä¸­ï¼Œæ‰€ä»¥å¦‚æœä½ éœ€è¦ä½¿ç”¨ std::mutexï¼Œå°±å¿…é¡»åŒ…å« <mutex> å¤´æ–‡ä»¶ã€‚\n\n## <mutex> å¤´æ–‡ä»¶ä»‹ç»\n\newde2e\t\n\n### Mutex ç³»åˆ—ç±»(å››ç§)\n\n- std::mutexï¼Œæœ€åŸºæœ¬çš„ Mutex ç±»ã€‚\n\n- std::recursive_mutexï¼Œé€’å½’ Mutex ç±»ã€‚\n\n- std::time_mutexï¼Œå®šæ—¶ Mutex ç±»ã€‚\n\n- std::recursive_timed_mutexï¼Œå®šæ—¶é€’å½’ Mutex ç±»ã€‚\n\n<!-- more -->\n\n### Lock ç±»ï¼ˆä¸¤ç§ï¼‰\n\n- std::lock_guardï¼Œä¸ Mutex RAII ç›¸å…³ï¼Œæ–¹ä¾¿çº¿ç¨‹å¯¹äº’æ–¥é‡ä¸Šé”ã€‚\n- std::unique_lockï¼Œä¸ Mutex RAII ç›¸å…³ï¼Œæ–¹ä¾¿çº¿ç¨‹å¯¹äº’æ–¥é‡ä¸Šé”ï¼Œä½†æä¾›äº†æ›´å¥½çš„ä¸Šé”å’Œè§£é”æ§åˆ¶ã€‚\n\n### å…¶ä»–ç±»å‹\n\n- std::once_flag\n- std::adopt_lock_t\n- std::defer_lock_t\n- std::try_to_lock_t\n\n## å‡½æ•°\n\n- std::try_lockï¼Œå°è¯•åŒæ—¶å¯¹å¤šä¸ªäº’æ–¥é‡ä¸Šé”ã€‚\n- std::lockï¼Œå¯ä»¥åŒæ—¶å¯¹å¤šä¸ªäº’æ–¥é‡ä¸Šé”ã€‚\n- std::call_onceï¼Œå¦‚æœå¤šä¸ªçº¿ç¨‹éœ€è¦åŒæ—¶è°ƒç”¨æŸä¸ªå‡½æ•°ï¼Œcall_once å¯ä»¥ä¿è¯å¤šä¸ªçº¿ç¨‹å¯¹è¯¥å‡½æ•°åªè°ƒç”¨ä¸€æ¬¡ã€‚\n\n### std::mutex ä»‹ç»\n\nä¸‹é¢ä»¥ std::mutex ä¸ºä¾‹ä»‹ç» C++11 ä¸­çš„äº’æ–¥é‡ç”¨æ³•ã€‚\n\nstd::mutex æ˜¯C++11 ä¸­æœ€åŸºæœ¬çš„äº’æ–¥é‡ï¼Œstd::mutex å¯¹è±¡æä¾›äº†ç‹¬å æ‰€æœ‰æƒçš„ç‰¹æ€§â€”â€”å³ä¸æ”¯æŒé€’å½’åœ°å¯¹ std::mutex å¯¹è±¡ä¸Šé”ï¼Œè€Œ std::recursive_lock åˆ™å¯ä»¥é€’å½’åœ°å¯¹äº’æ–¥é‡å¯¹è±¡ä¸Šé”ã€‚\n\n### std::mutex çš„æˆå‘˜å‡½æ•°\n\n- æ„é€ å‡½æ•°ï¼Œstd::mutexä¸å…è®¸æ‹·è´æ„é€ ï¼Œä¹Ÿä¸å…è®¸ move æ‹·è´ï¼Œæœ€åˆäº§ç”Ÿçš„ mutex å¯¹è±¡æ˜¯å¤„äº unlocked çŠ¶æ€çš„ã€‚\n- lock()ï¼Œè°ƒç”¨çº¿ç¨‹å°†é”ä½è¯¥äº’æ–¥é‡ã€‚çº¿ç¨‹è°ƒç”¨è¯¥å‡½æ•°ä¼šå‘ç”Ÿä¸‹é¢ 3 ç§æƒ…å†µï¼š(1). å¦‚æœè¯¥äº’æ–¥é‡å½“å‰æ²¡æœ‰è¢«é”ä½ï¼Œåˆ™è°ƒç”¨çº¿ç¨‹å°†è¯¥äº’æ–¥é‡é”ä½ï¼Œç›´åˆ°è°ƒç”¨ unlockä¹‹å‰ï¼Œè¯¥çº¿ç¨‹ä¸€ç›´æ‹¥æœ‰è¯¥é”ã€‚(2). å¦‚æœå½“å‰äº’æ–¥é‡è¢«å…¶ä»–çº¿ç¨‹é”ä½ï¼Œåˆ™å½“å‰çš„è°ƒç”¨çº¿ç¨‹è¢«é˜»å¡ä½ã€‚(3). å¦‚æœå½“å‰äº’æ–¥é‡è¢«å½“å‰è°ƒç”¨çº¿ç¨‹é”ä½ï¼Œåˆ™ä¼šäº§ç”Ÿæ­»é”(deadlock)ã€‚\n- unlock()ï¼Œ è§£é”ï¼Œé‡Šæ”¾å¯¹äº’æ–¥é‡çš„æ‰€æœ‰æƒã€‚\n- try_lock()ï¼Œå°è¯•é”ä½äº’æ–¥é‡ï¼Œå¦‚æœäº’æ–¥é‡è¢«å…¶ä»–çº¿ç¨‹å æœ‰ï¼Œåˆ™å½“å‰çº¿ç¨‹ä¹Ÿä¸ä¼šè¢«é˜»å¡ã€‚çº¿ç¨‹è°ƒç”¨è¯¥å‡½æ•°ä¹Ÿä¼šå‡ºç°ä¸‹é¢ 3 ç§æƒ…å†µï¼Œ(1). å¦‚æœå½“å‰äº’æ–¥é‡æ²¡æœ‰è¢«å…¶ä»–çº¿ç¨‹å æœ‰ï¼Œåˆ™è¯¥çº¿ç¨‹é”ä½äº’æ–¥é‡ï¼Œç›´åˆ°è¯¥çº¿ç¨‹è°ƒç”¨ unlock é‡Šæ”¾äº’æ–¥é‡ã€‚(2). å¦‚æœå½“å‰äº’æ–¥é‡è¢«å…¶ä»–çº¿ç¨‹é”ä½ï¼Œåˆ™å½“å‰è°ƒç”¨çº¿ç¨‹è¿”å› falseï¼Œè€Œå¹¶ä¸ä¼šè¢«é˜»å¡æ‰ã€‚(3). å¦‚æœå½“å‰äº’æ–¥é‡è¢«å½“å‰è°ƒç”¨çº¿ç¨‹é”ä½ï¼Œåˆ™ä¼šäº§ç”Ÿæ­»é”(deadlock)ã€‚\n\nä¸‹é¢ç»™å‡ºä¸€ä¸ªä¸ std::mutex çš„å°ä¾‹å­ï¼ˆ[å‚è€ƒ](http://www.cplusplus.com/reference/mutex/mutex/try_lock/)ï¼‰\n\n```c++\n#include <iostream>       // std::cout\n#include <thread>         // std::thread\n#include <mutex>          // std::mutex\n\nvolatile int counter(0); // non-atomic counter\nstd::mutex mtx;           // locks access to counter\n\nvoid attempt_10k_increases() {\n    for (int i=0; i<10000; ++i) {\n        if (mtx.try_lock()) {   // only increase if currently not locked:\n            ++counter;\n            mtx.unlock();\n        }\n    }\n}\n\nint main (int argc, const char* argv[]) {\n    std::thread threads[10];\n    for (int i=0; i<10; ++i)\n        threads[i] = std::thread(attempt_10k_increases);\n\n    for (auto& th : threads) th.join();\n    std::cout << counter << \" successful increases of the counter.\\n\";\n\n    return 0;\n}\n```\n\nè¾“å‡ºç»“æœï¼š\n\n```c++\n$g++ -lpthread -std=c++11 -o main *.cpp\n$main\n9012 successful increases of the counter.\n```\n\n> å¯ä»¥çœ‹å‡ºæœ‰å¾ˆå¤šæ¬¡mtx.try_lock()è¿”å›äº†falseï¼Œå¹¶æ²¡æœ‰æ‰§è¡Œ++counteræ“ä½œã€‚\n>\n> å¦‚æœæŠŠmtx.try_lock()æ”¹æˆmtx.lock()ï¼Œåˆ™å¿…å®šä¼šé˜»å¡å…¶ä»–çº¿ç¨‹ã€‚\n\nè¾“å‡ºç»“æœ2:\n\n```c++\n$g++ -lpthread -std=c++11 -o main *.cpp\n$main\n100000 successful increases of the counter.\n```\n\n## std::recursive_mutex ä»‹ç»\n\nstd::recursive_mutex ä¸ std::mutex ä¸€æ ·ï¼Œä¹Ÿæ˜¯ä¸€ç§å¯ä»¥è¢«ä¸Šé”çš„å¯¹è±¡ï¼Œä½†æ˜¯å’Œ std::mutex ä¸åŒçš„æ˜¯ï¼Œstd::recursive_mutex å…è®¸åŒä¸€ä¸ªçº¿ç¨‹å¯¹äº’æ–¥é‡å¤šæ¬¡ä¸Šé”ï¼ˆå³é€’å½’ä¸Šé”ï¼‰ï¼Œæ¥è·å¾—å¯¹äº’æ–¥é‡å¯¹è±¡çš„å¤šå±‚æ‰€æœ‰æƒï¼Œstd::recursive_mutex é‡Šæ”¾äº’æ–¥é‡æ—¶éœ€è¦è°ƒç”¨ä¸è¯¥é”å±‚æ¬¡æ·±åº¦ç›¸åŒæ¬¡æ•°çš„ unlock()ï¼Œå¯ç†è§£ä¸º lock() æ¬¡æ•°å’Œ unlock() æ¬¡æ•°ç›¸åŒï¼Œé™¤æ­¤ä¹‹å¤–ï¼Œstd::recursive_mutex çš„ç‰¹æ€§å’Œ std::mutex å¤§è‡´ç›¸åŒã€‚\n\n```c++\n#include <iostream>       // std::cout\n#include <thread>         // std::thread\n#include <mutex>          // std::mutex\n\nvolatile int counter(0); // non-atomic counter\nstd::recursive_mutex  rmtx;           // locks access to counter\n\nvoid attempt_1k_increases() {\n    for (int i=0; i<10000; ++i) {\n        rmtx.lock();   \n        ++counter; \n    }\n    for (int i=0; i<10000; ++i) { \n        counter-=2; \n        rmtx.unlock();\n    }\n}\n\nint main (int argc, const char* argv[]) {\n    auto th = std::thread(attempt_1k_increases);\n    th.join();\n    std::cout << counter << \" successful increases of the counter.\\n\";\n\n    return 0;\n}\n```\n\nè¾“å‡ºç»“æœï¼š\n\n```c++\n$g++ -lpthread -o main *.cpp\n$main\n-10000 successful increases of the counter.\n```\n\n## std::time_mutex ä»‹ç»\n\nstd::time_mutex æ¯” std::mutex å¤šäº†ä¸¤ä¸ªæˆå‘˜å‡½æ•°ï¼Œtry_lock_for()ï¼Œtry_lock_until()ã€‚\n\ntry_lock_for å‡½æ•°æ¥å—ä¸€ä¸ªæ—¶é—´èŒƒå›´ï¼Œè¡¨ç¤ºåœ¨è¿™ä¸€æ®µæ—¶é—´èŒƒå›´ä¹‹å†…çº¿ç¨‹å¦‚æœæ²¡æœ‰è·å¾—é”åˆ™è¢«é˜»å¡ä½ï¼ˆä¸ std::mutex çš„ try_lock() ä¸åŒï¼Œtry_lock å¦‚æœè¢«è°ƒç”¨æ—¶æ²¡æœ‰è·å¾—é”åˆ™ç›´æ¥è¿”å› falseï¼‰ï¼Œå¦‚æœåœ¨æ­¤æœŸé—´å…¶ä»–çº¿ç¨‹é‡Šæ”¾äº†é”ï¼Œåˆ™è¯¥çº¿ç¨‹å¯ä»¥è·å¾—å¯¹äº’æ–¥é‡çš„é”ï¼Œå¦‚æœè¶…æ—¶ï¼ˆå³åœ¨æŒ‡å®šæ—¶é—´å†…è¿˜æ˜¯æ²¡æœ‰è·å¾—é”ï¼‰ï¼Œåˆ™è¿”å› falseã€‚\n\ntry_lock_until å‡½æ•°åˆ™æ¥å—ä¸€ä¸ªæ—¶é—´ç‚¹ä½œä¸ºå‚æ•°ï¼Œåœ¨æŒ‡å®šæ—¶é—´ç‚¹æœªåˆ°æ¥ä¹‹å‰çº¿ç¨‹å¦‚æœæ²¡æœ‰è·å¾—é”åˆ™è¢«é˜»å¡ä½ï¼Œå¦‚æœåœ¨æ­¤æœŸé—´å…¶ä»–çº¿ç¨‹é‡Šæ”¾äº†é”ï¼Œåˆ™è¯¥çº¿ç¨‹å¯ä»¥è·å¾—å¯¹äº’æ–¥é‡çš„é”ï¼Œå¦‚æœè¶…æ—¶ï¼ˆå³åœ¨æŒ‡å®šæ—¶é—´å†…è¿˜æ˜¯æ²¡æœ‰è·å¾—é”ï¼‰ï¼Œåˆ™è¿”å› falseã€‚\n\nä¸‹é¢çš„å°ä¾‹å­è¯´æ˜äº† std::time_mutex çš„ç”¨æ³•ï¼ˆ[å‚è€ƒ](http://www.cplusplus.com/reference/mutex/timed_mutex/try_lock_for/)ï¼‰ã€‚\n\n```c++\n#include <iostream>       // std::cout\n#include <chrono>         // std::chrono::milliseconds\n#include <thread>         // std::thread\n#include <mutex>          // std::timed_mutex\n\nstd::timed_mutex mtx;\n\nvoid fireworks() {\n  // waiting to get a lock: each thread prints \"-\" every 200ms:\n  while (!mtx.try_lock_for(std::chrono::milliseconds(200))) {\n    std::cout << \"-\";\n  }\n  // got a lock! - wait for 1s, then this thread prints \"*\"\n  std::this_thread::sleep_for(std::chrono::milliseconds(1000));\n  std::cout << \"*\\n\";\n  mtx.unlock();\n}\n\nint main ()\n{\n  std::thread threads[10];\n  // spawn 10 threads:\n  for (int i=0; i<10; ++i)\n    threads[i] = std::thread(fireworks);\n\n  for (auto& th : threads) th.join();\n\n  return 0;\n}\n```\n\nè¾“å‡ºç»“æœï¼š\n\n> çº¿ç¨‹è¾“å‡º*è¡¨ç¤ºè¯¥çº¿ç¨‹å·²ç»æ­£å¸¸é€€å‡ºï¼Œå¹¶ä¸”é‡Šæ”¾è¯¥é”ã€‚å¦åˆ™å°†æ¯200mså°è¯•è·å–mutexğŸ”’ï¼Œç›´åˆ°æˆåŠŸä¸ºæ­¢ã€‚\n\n## std::recursive_timed_mutex ä»‹ç»\n\nå’Œ std:recursive_mutex ä¸ std::mutex çš„å…³ç³»ä¸€æ ·ï¼Œstd::recursive_timed_mutex çš„ç‰¹æ€§ä¹Ÿå¯ä»¥ä» std::timed_mutex æ¨å¯¼å‡ºæ¥ï¼Œæ„Ÿå…´è¶£çš„åŒé‹å¯ä»¥è‡ªè¡ŒæŸ¥é˜…ã€‚ ;-)\n\n## std::lock_guard ä»‹ç»\n\nä¸ Mutex RAII ç›¸å…³ï¼Œæ–¹ä¾¿çº¿ç¨‹å¯¹äº’æ–¥é‡ä¸Šé”ã€‚ä¾‹å­ï¼ˆ[å‚è€ƒ](http://www.cplusplus.com/reference/mutex/lock_guard/)ï¼‰:\n\n* 1.std::lock_guard åœ¨æ„é€ å‡½æ•°ä¸­è¿›è¡ŒåŠ é”ï¼Œææ„å‡½æ•°ä¸­è¿›è¡Œè§£é”ã€‚\n* 2.é”åœ¨å¤šçº¿ç¨‹ç¼–ç¨‹ä¸­ï¼Œä½¿ç”¨è¾ƒå¤šï¼Œå› æ­¤c++11æä¾›äº†lock_guardæ¨¡æ¿ç±»ï¼›åœ¨å®é™…ç¼–ç¨‹ä¸­ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥æ ¹æ®è‡ªå·±çš„åœºæ™¯ç¼–å†™`resource_guard` RAIIç±»ï¼Œé¿å…å¿˜æ‰é‡Šæ”¾èµ„æºã€‚\n\n```c++\n#include <iostream>       // std::cout\n#include <thread>         // std::thread\n#include <mutex>          // std::mutex, std::lock_guard\n#include <stdexcept>      // std::logic_error\n\nstd::mutex mtx;\n\nvoid print_even (int x) {\n    if (x%2==0) std::cout << x << \" is even\\n\";\n    else throw (std::logic_error(\"not even\"));\n}\n\nvoid print_thread_id (int id) {\n    try {\n        // using a local lock_guard to lock mtx guarantees unlocking on destruction / exception:\n        std::lock_guard<std::mutex> lck (mtx);\n        print_even(id);\n    }\n    catch (std::logic_error&) {\n        std::cout << \"[exception caught]\\n\";\n    }\n}\n\nint main ()\n{\n    std::thread threads[10];\n    // spawn 10 threads:\n    for (int i=0; i<10; ++i)\n        threads[i] = std::thread(print_thread_id,i+1);\n\n    for (auto& th : threads) th.join();\n\n    return 0;\n}\n```\n\nè¾“å‡ºç»“æœï¼š\n\n```c++\n$g++ -lpthread -o main *.cpp\n$main\n[exception caught]\n4 is even\n[exception caught]\n2 is even\n[exception caught]\n6 is even\n8 is even\n[exception caught]\n[exception caught]\n10 is even\n```\n\n## std::unique_lock ä»‹ç»\n\nä¸ Mutex RAII ç›¸å…³ï¼Œæ–¹ä¾¿çº¿ç¨‹å¯¹äº’æ–¥é‡ä¸Šé”ï¼Œä½†æä¾›äº†æ›´å¥½çš„ä¸Šé”å’Œè§£é”æ§åˆ¶ã€‚ä¾‹å­ï¼ˆ[å‚è€ƒ](http://www.cplusplus.com/reference/mutex/unique_lock/)ï¼‰ï¼š\n\n* 1.ç±» unique_lock æ˜¯é€šç”¨äº’æ–¥åŒ…è£…å™¨ï¼Œå…è®¸`å»¶è¿Ÿé”å®šã€é”å®šçš„æœ‰æ—¶é™å°è¯•ã€é€’å½’é”å®šã€æ‰€æœ‰æƒè½¬ç§»å’Œä¸æ¡ä»¶å˜é‡ä¸€åŒä½¿ç”¨`ã€‚\n* 2.unique_lockæ¯”lock_guardä½¿ç”¨æ›´åŠ çµæ´»ï¼ŒåŠŸèƒ½æ›´åŠ å¼ºå¤§ã€‚\n  ä½¿ç”¨unique_lockéœ€è¦ä»˜å‡ºæ›´å¤šçš„æ—¶é—´ã€æ€§èƒ½æˆæœ¬ã€‚\n\n```c++\n#include <iostream>       // std::cout\n#include <thread>         // std::thread\n#include <mutex>          // std::mutex, std::unique_lock\n\nstd::mutex mtx;           // mutex for critical section\n\nvoid print_block (int n, char c) {\n    // critical section (exclusive access to std::cout signaled by lifetime of lck):\n    std::unique_lock<std::mutex> lck (mtx);\n    for (int i=0; i<n; ++i) {\n        std::cout << c;\n    }\n    std::cout << '\\n';\n}\n\nint main ()\n{\n    std::thread th1 (print_block,50,'*');\n    std::thread th2 (print_block,50,'$');\n\n    th1.join();\n    th2.join();\n\n    return 0;\n}\n```\n\nè¾“å‡ºç»“æœï¼š\n\n```c++\n$g++ -lpthread -o main *.cpp\n$main\n**************************************************\n$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$\n```\n\n\n\nå¥½äº†ï¼Œæœ¬æ–‡æš‚æ—¶è®²åˆ°è¿™é‡Œï¼Œè¿˜å‰©ä¸‹ std::try_lockï¼Œstd::lockï¼Œstd::call_once ä¸‰ä¸ªå‡½æ•°æ²¡æœ‰è®²åˆ°ï¼Œç•™åœ¨ä¸‹ä¸€ç¯‡åšå®¢ä¸­è®²å§ ;-)","content":"<h2 id=\"Head\">Head<a href=\"post/Mutexä»‹ç»#Head\"></a></h2><p>Mutex åˆç§°äº’æ–¥é‡ï¼ŒC++ 11ä¸­ä¸ Mutex ç›¸å…³çš„ç±»ï¼ˆåŒ…æ‹¬é”ç±»å‹ï¼‰å’Œå‡½æ•°éƒ½å£°æ˜åœ¨ <mutex> å¤´æ–‡ä»¶ä¸­ï¼Œæ‰€ä»¥å¦‚æœä½ éœ€è¦ä½¿ç”¨ std::mutexï¼Œå°±å¿…é¡»åŒ…å« <mutex> å¤´æ–‡ä»¶ã€‚</mutex></mutex></p>\n<h2 id=\"å¤´æ–‡ä»¶ä»‹ç»\"><mutex> å¤´æ–‡ä»¶ä»‹ç»</mutex><a href=\"post/Mutexä»‹ç»#å¤´æ–‡ä»¶ä»‹ç»\"></a></h2><p>ewde2e    </p>\n<h3 id=\"Mutex-ç³»åˆ—ç±»-å››ç§\">Mutex ç³»åˆ—ç±»(å››ç§)<a href=\"post/Mutexä»‹ç»#Mutex-ç³»åˆ—ç±»-å››ç§\"></a></h3><ul>\n<li><p>std::mutexï¼Œæœ€åŸºæœ¬çš„ Mutex ç±»ã€‚</p>\n</li>\n<li><p>std::recursive_mutexï¼Œé€’å½’ Mutex ç±»ã€‚</p>\n</li>\n<li><p>std::time_mutexï¼Œå®šæ—¶ Mutex ç±»ã€‚</p>\n</li>\n<li><p>std::recursive_timed_mutexï¼Œå®šæ—¶é€’å½’ Mutex ç±»ã€‚</p>\n</li>\n</ul>\n<a id=\"more\"></a>\n\n<h3 id=\"Lock-ç±»ï¼ˆä¸¤ç§ï¼‰\">Lock ç±»ï¼ˆä¸¤ç§ï¼‰<a href=\"post/Mutexä»‹ç»#Lock-ç±»ï¼ˆä¸¤ç§ï¼‰\"></a></h3><ul>\n<li>std::lock_guardï¼Œä¸ Mutex RAII ç›¸å…³ï¼Œæ–¹ä¾¿çº¿ç¨‹å¯¹äº’æ–¥é‡ä¸Šé”ã€‚</li>\n<li>std::unique_lockï¼Œä¸ Mutex RAII ç›¸å…³ï¼Œæ–¹ä¾¿çº¿ç¨‹å¯¹äº’æ–¥é‡ä¸Šé”ï¼Œä½†æä¾›äº†æ›´å¥½çš„ä¸Šé”å’Œè§£é”æ§åˆ¶ã€‚</li>\n</ul>\n<h3 id=\"å…¶ä»–ç±»å‹\">å…¶ä»–ç±»å‹<a href=\"post/Mutexä»‹ç»#å…¶ä»–ç±»å‹\"></a></h3><ul>\n<li>std::once_flag</li>\n<li>std::adopt_lock_t</li>\n<li>std::defer_lock_t</li>\n<li>std::try_to_lock_t</li>\n</ul>\n<h2 id=\"å‡½æ•°\">å‡½æ•°<a href=\"post/Mutexä»‹ç»#å‡½æ•°\"></a></h2><ul>\n<li>std::try_lockï¼Œå°è¯•åŒæ—¶å¯¹å¤šä¸ªäº’æ–¥é‡ä¸Šé”ã€‚</li>\n<li>std::lockï¼Œå¯ä»¥åŒæ—¶å¯¹å¤šä¸ªäº’æ–¥é‡ä¸Šé”ã€‚</li>\n<li>std::call_onceï¼Œå¦‚æœå¤šä¸ªçº¿ç¨‹éœ€è¦åŒæ—¶è°ƒç”¨æŸä¸ªå‡½æ•°ï¼Œcall_once å¯ä»¥ä¿è¯å¤šä¸ªçº¿ç¨‹å¯¹è¯¥å‡½æ•°åªè°ƒç”¨ä¸€æ¬¡ã€‚</li>\n</ul>\n<h3 id=\"std-mutex-ä»‹ç»\">std::mutex ä»‹ç»<a href=\"post/Mutexä»‹ç»#std-mutex-ä»‹ç»\"></a></h3><p>ä¸‹é¢ä»¥ std::mutex ä¸ºä¾‹ä»‹ç» C++11 ä¸­çš„äº’æ–¥é‡ç”¨æ³•ã€‚</p>\n<p>std::mutex æ˜¯C++11 ä¸­æœ€åŸºæœ¬çš„äº’æ–¥é‡ï¼Œstd::mutex å¯¹è±¡æä¾›äº†ç‹¬å æ‰€æœ‰æƒçš„ç‰¹æ€§â€”â€”å³ä¸æ”¯æŒé€’å½’åœ°å¯¹ std::mutex å¯¹è±¡ä¸Šé”ï¼Œè€Œ std::recursive_lock åˆ™å¯ä»¥é€’å½’åœ°å¯¹äº’æ–¥é‡å¯¹è±¡ä¸Šé”ã€‚</p>\n<h3 id=\"std-mutex-çš„æˆå‘˜å‡½æ•°\">std::mutex çš„æˆå‘˜å‡½æ•°<a href=\"post/Mutexä»‹ç»#std-mutex-çš„æˆå‘˜å‡½æ•°\"></a></h3><ul>\n<li>æ„é€ å‡½æ•°ï¼Œstd::mutexä¸å…è®¸æ‹·è´æ„é€ ï¼Œä¹Ÿä¸å…è®¸ move æ‹·è´ï¼Œæœ€åˆäº§ç”Ÿçš„ mutex å¯¹è±¡æ˜¯å¤„äº unlocked çŠ¶æ€çš„ã€‚</li>\n<li>lock()ï¼Œè°ƒç”¨çº¿ç¨‹å°†é”ä½è¯¥äº’æ–¥é‡ã€‚çº¿ç¨‹è°ƒç”¨è¯¥å‡½æ•°ä¼šå‘ç”Ÿä¸‹é¢ 3 ç§æƒ…å†µï¼š(1). å¦‚æœè¯¥äº’æ–¥é‡å½“å‰æ²¡æœ‰è¢«é”ä½ï¼Œåˆ™è°ƒç”¨çº¿ç¨‹å°†è¯¥äº’æ–¥é‡é”ä½ï¼Œç›´åˆ°è°ƒç”¨ unlockä¹‹å‰ï¼Œè¯¥çº¿ç¨‹ä¸€ç›´æ‹¥æœ‰è¯¥é”ã€‚(2). å¦‚æœå½“å‰äº’æ–¥é‡è¢«å…¶ä»–çº¿ç¨‹é”ä½ï¼Œåˆ™å½“å‰çš„è°ƒç”¨çº¿ç¨‹è¢«é˜»å¡ä½ã€‚(3). å¦‚æœå½“å‰äº’æ–¥é‡è¢«å½“å‰è°ƒç”¨çº¿ç¨‹é”ä½ï¼Œåˆ™ä¼šäº§ç”Ÿæ­»é”(deadlock)ã€‚</li>\n<li>unlock()ï¼Œ è§£é”ï¼Œé‡Šæ”¾å¯¹äº’æ–¥é‡çš„æ‰€æœ‰æƒã€‚</li>\n<li>try_lock()ï¼Œå°è¯•é”ä½äº’æ–¥é‡ï¼Œå¦‚æœäº’æ–¥é‡è¢«å…¶ä»–çº¿ç¨‹å æœ‰ï¼Œåˆ™å½“å‰çº¿ç¨‹ä¹Ÿä¸ä¼šè¢«é˜»å¡ã€‚çº¿ç¨‹è°ƒç”¨è¯¥å‡½æ•°ä¹Ÿä¼šå‡ºç°ä¸‹é¢ 3 ç§æƒ…å†µï¼Œ(1). å¦‚æœå½“å‰äº’æ–¥é‡æ²¡æœ‰è¢«å…¶ä»–çº¿ç¨‹å æœ‰ï¼Œåˆ™è¯¥çº¿ç¨‹é”ä½äº’æ–¥é‡ï¼Œç›´åˆ°è¯¥çº¿ç¨‹è°ƒç”¨ unlock é‡Šæ”¾äº’æ–¥é‡ã€‚(2). å¦‚æœå½“å‰äº’æ–¥é‡è¢«å…¶ä»–çº¿ç¨‹é”ä½ï¼Œåˆ™å½“å‰è°ƒç”¨çº¿ç¨‹è¿”å› falseï¼Œè€Œå¹¶ä¸ä¼šè¢«é˜»å¡æ‰ã€‚(3). å¦‚æœå½“å‰äº’æ–¥é‡è¢«å½“å‰è°ƒç”¨çº¿ç¨‹é”ä½ï¼Œåˆ™ä¼šäº§ç”Ÿæ­»é”(deadlock)ã€‚</li>\n</ul>\n<p>ä¸‹é¢ç»™å‡ºä¸€ä¸ªä¸ std::mutex çš„å°ä¾‹å­ï¼ˆ<a href=\"http://www.cplusplus.com/reference/mutex/mutex/try_lock/\" target=\"_blank\" rel=\"noopener\">å‚è€ƒ</a>ï¼‰</p>\n<figure class=\"highlight c++\"><div><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#<span class=\"meta-keyword\">include</span> <span class=\"meta-string\">&lt;iostream&gt;       // std::cout</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"meta-keyword\">include</span> <span class=\"meta-string\">&lt;thread&gt;         // std::thread</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"meta-keyword\">include</span> <span class=\"meta-string\">&lt;mutex&gt;          // std::mutex</span></span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">volatile</span> <span class=\"keyword\">int</span> <span class=\"title\">counter</span><span class=\"params\">(<span class=\"number\">0</span>)</span></span>; <span class=\"comment\">// non-atomic counter</span></span><br><span class=\"line\"><span class=\"built_in\">std</span>::mutex mtx;           <span class=\"comment\">// locks access to counter</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">void</span> <span class=\"title\">attempt_10k_increases</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">for</span> (<span class=\"keyword\">int</span> i=<span class=\"number\">0</span>; i&lt;<span class=\"number\">10000</span>; ++i) &#123;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (mtx.try_lock()) &#123;   <span class=\"comment\">// only increase if currently not locked:</span></span><br><span class=\"line\">            ++counter;</span><br><span class=\"line\">            mtx.unlock();</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">int</span> <span class=\"title\">main</span> <span class=\"params\">(<span class=\"keyword\">int</span> argc, <span class=\"keyword\">const</span> <span class=\"keyword\">char</span>* argv[])</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"built_in\">std</span>::thread threads[<span class=\"number\">10</span>];</span><br><span class=\"line\">    <span class=\"keyword\">for</span> (<span class=\"keyword\">int</span> i=<span class=\"number\">0</span>; i&lt;<span class=\"number\">10</span>; ++i)</span><br><span class=\"line\">        threads[i] = <span class=\"built_in\">std</span>::thread(attempt_10k_increases);</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">for</span> (<span class=\"keyword\">auto</span>&amp; th : threads) th.join();</span><br><span class=\"line\">    <span class=\"built_in\">std</span>::<span class=\"built_in\">cout</span> &lt;&lt; counter &lt;&lt; <span class=\"string\">\" successful increases of the counter.\\n\"</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"number\">0</span>;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></div></figure>\n\n<p>è¾“å‡ºç»“æœï¼š</p>\n<figure class=\"highlight c++\"><div><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$g++ -lpthread -<span class=\"built_in\">std</span>=c++<span class=\"number\">11</span> -o main *.cpp</span><br><span class=\"line\">$main</span><br><span class=\"line\"><span class=\"number\">9012</span> successful increases of the counter.</span><br></pre></td></tr></table></div></figure>\n\n<blockquote>\n<p>å¯ä»¥çœ‹å‡ºæœ‰å¾ˆå¤šæ¬¡mtx.try_lock()è¿”å›äº†falseï¼Œå¹¶æ²¡æœ‰æ‰§è¡Œ++counteræ“ä½œã€‚</p>\n<p>å¦‚æœæŠŠmtx.try_lock()æ”¹æˆmtx.lock()ï¼Œåˆ™å¿…å®šä¼šé˜»å¡å…¶ä»–çº¿ç¨‹ã€‚</p>\n</blockquote>\n<p>è¾“å‡ºç»“æœ2:</p>\n<figure class=\"highlight c++\"><div><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$g++ -lpthread -<span class=\"built_in\">std</span>=c++<span class=\"number\">11</span> -o main *.cpp</span><br><span class=\"line\">$main</span><br><span class=\"line\"><span class=\"number\">100000</span> successful increases of the counter.</span><br></pre></td></tr></table></div></figure>\n\n<h2 id=\"std-recursive-mutex-ä»‹ç»\">std::recursive_mutex ä»‹ç»<a href=\"post/Mutexä»‹ç»#std-recursive-mutex-ä»‹ç»\"></a></h2><p>std::recursive_mutex ä¸ std::mutex ä¸€æ ·ï¼Œä¹Ÿæ˜¯ä¸€ç§å¯ä»¥è¢«ä¸Šé”çš„å¯¹è±¡ï¼Œä½†æ˜¯å’Œ std::mutex ä¸åŒçš„æ˜¯ï¼Œstd::recursive_mutex å…è®¸åŒä¸€ä¸ªçº¿ç¨‹å¯¹äº’æ–¥é‡å¤šæ¬¡ä¸Šé”ï¼ˆå³é€’å½’ä¸Šé”ï¼‰ï¼Œæ¥è·å¾—å¯¹äº’æ–¥é‡å¯¹è±¡çš„å¤šå±‚æ‰€æœ‰æƒï¼Œstd::recursive_mutex é‡Šæ”¾äº’æ–¥é‡æ—¶éœ€è¦è°ƒç”¨ä¸è¯¥é”å±‚æ¬¡æ·±åº¦ç›¸åŒæ¬¡æ•°çš„ unlock()ï¼Œå¯ç†è§£ä¸º lock() æ¬¡æ•°å’Œ unlock() æ¬¡æ•°ç›¸åŒï¼Œé™¤æ­¤ä¹‹å¤–ï¼Œstd::recursive_mutex çš„ç‰¹æ€§å’Œ std::mutex å¤§è‡´ç›¸åŒã€‚</p>\n<figure class=\"highlight c++\"><div><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#<span class=\"meta-keyword\">include</span> <span class=\"meta-string\">&lt;iostream&gt;       // std::cout</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"meta-keyword\">include</span> <span class=\"meta-string\">&lt;thread&gt;         // std::thread</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"meta-keyword\">include</span> <span class=\"meta-string\">&lt;mutex&gt;          // std::mutex</span></span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">volatile</span> <span class=\"keyword\">int</span> <span class=\"title\">counter</span><span class=\"params\">(<span class=\"number\">0</span>)</span></span>; <span class=\"comment\">// non-atomic counter</span></span><br><span class=\"line\"><span class=\"built_in\">std</span>::recursive_mutex  rmtx;           <span class=\"comment\">// locks access to counter</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">void</span> <span class=\"title\">attempt_1k_increases</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">for</span> (<span class=\"keyword\">int</span> i=<span class=\"number\">0</span>; i&lt;<span class=\"number\">10000</span>; ++i) &#123;</span><br><span class=\"line\">        rmtx.lock();   </span><br><span class=\"line\">        ++counter; </span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"keyword\">for</span> (<span class=\"keyword\">int</span> i=<span class=\"number\">0</span>; i&lt;<span class=\"number\">10000</span>; ++i) &#123; </span><br><span class=\"line\">        counter-=<span class=\"number\">2</span>; </span><br><span class=\"line\">        rmtx.unlock();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">int</span> <span class=\"title\">main</span> <span class=\"params\">(<span class=\"keyword\">int</span> argc, <span class=\"keyword\">const</span> <span class=\"keyword\">char</span>* argv[])</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">auto</span> th = <span class=\"built_in\">std</span>::thread(attempt_1k_increases);</span><br><span class=\"line\">    th.join();</span><br><span class=\"line\">    <span class=\"built_in\">std</span>::<span class=\"built_in\">cout</span> &lt;&lt; counter &lt;&lt; <span class=\"string\">\" successful increases of the counter.\\n\"</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"number\">0</span>;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></div></figure>\n\n<p>è¾“å‡ºç»“æœï¼š</p>\n<figure class=\"highlight c++\"><div><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$g++ -lpthread -o main *.cpp</span><br><span class=\"line\">$main</span><br><span class=\"line\"><span class=\"number\">-10000</span> successful increases of the counter.</span><br></pre></td></tr></table></div></figure>\n\n<h2 id=\"std-time-mutex-ä»‹ç»\">std::time_mutex ä»‹ç»<a href=\"post/Mutexä»‹ç»#std-time-mutex-ä»‹ç»\"></a></h2><p>std::time_mutex æ¯” std::mutex å¤šäº†ä¸¤ä¸ªæˆå‘˜å‡½æ•°ï¼Œtry_lock_for()ï¼Œtry_lock_until()ã€‚</p>\n<p>try_lock_for å‡½æ•°æ¥å—ä¸€ä¸ªæ—¶é—´èŒƒå›´ï¼Œè¡¨ç¤ºåœ¨è¿™ä¸€æ®µæ—¶é—´èŒƒå›´ä¹‹å†…çº¿ç¨‹å¦‚æœæ²¡æœ‰è·å¾—é”åˆ™è¢«é˜»å¡ä½ï¼ˆä¸ std::mutex çš„ try_lock() ä¸åŒï¼Œtry_lock å¦‚æœè¢«è°ƒç”¨æ—¶æ²¡æœ‰è·å¾—é”åˆ™ç›´æ¥è¿”å› falseï¼‰ï¼Œå¦‚æœåœ¨æ­¤æœŸé—´å…¶ä»–çº¿ç¨‹é‡Šæ”¾äº†é”ï¼Œåˆ™è¯¥çº¿ç¨‹å¯ä»¥è·å¾—å¯¹äº’æ–¥é‡çš„é”ï¼Œå¦‚æœè¶…æ—¶ï¼ˆå³åœ¨æŒ‡å®šæ—¶é—´å†…è¿˜æ˜¯æ²¡æœ‰è·å¾—é”ï¼‰ï¼Œåˆ™è¿”å› falseã€‚</p>\n<p>try_lock_until å‡½æ•°åˆ™æ¥å—ä¸€ä¸ªæ—¶é—´ç‚¹ä½œä¸ºå‚æ•°ï¼Œåœ¨æŒ‡å®šæ—¶é—´ç‚¹æœªåˆ°æ¥ä¹‹å‰çº¿ç¨‹å¦‚æœæ²¡æœ‰è·å¾—é”åˆ™è¢«é˜»å¡ä½ï¼Œå¦‚æœåœ¨æ­¤æœŸé—´å…¶ä»–çº¿ç¨‹é‡Šæ”¾äº†é”ï¼Œåˆ™è¯¥çº¿ç¨‹å¯ä»¥è·å¾—å¯¹äº’æ–¥é‡çš„é”ï¼Œå¦‚æœè¶…æ—¶ï¼ˆå³åœ¨æŒ‡å®šæ—¶é—´å†…è¿˜æ˜¯æ²¡æœ‰è·å¾—é”ï¼‰ï¼Œåˆ™è¿”å› falseã€‚</p>\n<p>ä¸‹é¢çš„å°ä¾‹å­è¯´æ˜äº† std::time_mutex çš„ç”¨æ³•ï¼ˆ<a href=\"http://www.cplusplus.com/reference/mutex/timed_mutex/try_lock_for/\" target=\"_blank\" rel=\"noopener\">å‚è€ƒ</a>ï¼‰ã€‚</p>\n<figure class=\"highlight c++\"><div><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#<span class=\"meta-keyword\">include</span> <span class=\"meta-string\">&lt;iostream&gt;       // std::cout</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"meta-keyword\">include</span> <span class=\"meta-string\">&lt;chrono&gt;         // std::chrono::milliseconds</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"meta-keyword\">include</span> <span class=\"meta-string\">&lt;thread&gt;         // std::thread</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"meta-keyword\">include</span> <span class=\"meta-string\">&lt;mutex&gt;          // std::timed_mutex</span></span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"built_in\">std</span>::timed_mutex mtx;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">void</span> <span class=\"title\">fireworks</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">  <span class=\"comment\">// waiting to get a lock: each thread prints \"-\" every 200ms:</span></span><br><span class=\"line\">  <span class=\"keyword\">while</span> (!mtx.try_lock_for(<span class=\"built_in\">std</span>::chrono::milliseconds(<span class=\"number\">200</span>))) &#123;</span><br><span class=\"line\">    <span class=\"built_in\">std</span>::<span class=\"built_in\">cout</span> &lt;&lt; <span class=\"string\">\"-\"</span>;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  <span class=\"comment\">// got a lock! - wait for 1s, then this thread prints \"*\"</span></span><br><span class=\"line\">  <span class=\"built_in\">std</span>::this_thread::sleep_for(<span class=\"built_in\">std</span>::chrono::milliseconds(<span class=\"number\">1000</span>));</span><br><span class=\"line\">  <span class=\"built_in\">std</span>::<span class=\"built_in\">cout</span> &lt;&lt; <span class=\"string\">\"*\\n\"</span>;</span><br><span class=\"line\">  mtx.unlock();</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">int</span> <span class=\"title\">main</span> <span class=\"params\">()</span></span></span><br><span class=\"line\"><span class=\"function\"></span>&#123;</span><br><span class=\"line\">  <span class=\"built_in\">std</span>::thread threads[<span class=\"number\">10</span>];</span><br><span class=\"line\">  <span class=\"comment\">// spawn 10 threads:</span></span><br><span class=\"line\">  <span class=\"keyword\">for</span> (<span class=\"keyword\">int</span> i=<span class=\"number\">0</span>; i&lt;<span class=\"number\">10</span>; ++i)</span><br><span class=\"line\">    threads[i] = <span class=\"built_in\">std</span>::thread(fireworks);</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"keyword\">for</span> (<span class=\"keyword\">auto</span>&amp; th : threads) th.join();</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"keyword\">return</span> <span class=\"number\">0</span>;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></div></figure>\n\n<p>è¾“å‡ºç»“æœï¼š</p>\n<blockquote>\n<p>çº¿ç¨‹è¾“å‡º*è¡¨ç¤ºè¯¥çº¿ç¨‹å·²ç»æ­£å¸¸é€€å‡ºï¼Œå¹¶ä¸”é‡Šæ”¾è¯¥é”ã€‚å¦åˆ™å°†æ¯200mså°è¯•è·å–mutexğŸ”’ï¼Œç›´åˆ°æˆåŠŸä¸ºæ­¢ã€‚</p>\n</blockquote>\n<h2 id=\"std-recursive-timed-mutex-ä»‹ç»\">std::recursive_timed_mutex ä»‹ç»<a href=\"post/Mutexä»‹ç»#std-recursive-timed-mutex-ä»‹ç»\"></a></h2><p>å’Œ std:recursive_mutex ä¸ std::mutex çš„å…³ç³»ä¸€æ ·ï¼Œstd::recursive_timed_mutex çš„ç‰¹æ€§ä¹Ÿå¯ä»¥ä» std::timed_mutex æ¨å¯¼å‡ºæ¥ï¼Œæ„Ÿå…´è¶£çš„åŒé‹å¯ä»¥è‡ªè¡ŒæŸ¥é˜…ã€‚ ;-)</p>\n<h2 id=\"std-lock-guard-ä»‹ç»\">std::lock_guard ä»‹ç»<a href=\"post/Mutexä»‹ç»#std-lock-guard-ä»‹ç»\"></a></h2><p>ä¸ Mutex RAII ç›¸å…³ï¼Œæ–¹ä¾¿çº¿ç¨‹å¯¹äº’æ–¥é‡ä¸Šé”ã€‚ä¾‹å­ï¼ˆ<a href=\"http://www.cplusplus.com/reference/mutex/lock_guard/\" target=\"_blank\" rel=\"noopener\">å‚è€ƒ</a>ï¼‰:</p>\n<ul>\n<li>1.std::lock_guard åœ¨æ„é€ å‡½æ•°ä¸­è¿›è¡ŒåŠ é”ï¼Œææ„å‡½æ•°ä¸­è¿›è¡Œè§£é”ã€‚</li>\n<li>2.é”åœ¨å¤šçº¿ç¨‹ç¼–ç¨‹ä¸­ï¼Œä½¿ç”¨è¾ƒå¤šï¼Œå› æ­¤c++11æä¾›äº†lock_guardæ¨¡æ¿ç±»ï¼›åœ¨å®é™…ç¼–ç¨‹ä¸­ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥æ ¹æ®è‡ªå·±çš„åœºæ™¯ç¼–å†™<code>resource_guard</code> RAIIç±»ï¼Œé¿å…å¿˜æ‰é‡Šæ”¾èµ„æºã€‚</li>\n</ul>\n<figure class=\"highlight c++\"><div><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#<span class=\"meta-keyword\">include</span> <span class=\"meta-string\">&lt;iostream&gt;       // std::cout</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"meta-keyword\">include</span> <span class=\"meta-string\">&lt;thread&gt;         // std::thread</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"meta-keyword\">include</span> <span class=\"meta-string\">&lt;mutex&gt;          // std::mutex, std::lock_guard</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"meta-keyword\">include</span> <span class=\"meta-string\">&lt;stdexcept&gt;      // std::logic_error</span></span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"built_in\">std</span>::mutex mtx;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">void</span> <span class=\"title\">print_even</span> <span class=\"params\">(<span class=\"keyword\">int</span> x)</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (x%<span class=\"number\">2</span>==<span class=\"number\">0</span>) <span class=\"built_in\">std</span>::<span class=\"built_in\">cout</span> &lt;&lt; x &lt;&lt; <span class=\"string\">\" is even\\n\"</span>;</span><br><span class=\"line\">    <span class=\"keyword\">else</span> <span class=\"keyword\">throw</span> (<span class=\"built_in\">std</span>::logic_error(<span class=\"string\">\"not even\"</span>));</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">void</span> <span class=\"title\">print_thread_id</span> <span class=\"params\">(<span class=\"keyword\">int</span> id)</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">        <span class=\"comment\">// using a local lock_guard to lock mtx guarantees unlocking on destruction / exception:</span></span><br><span class=\"line\">        <span class=\"built_in\">std</span>::lock_guard&lt;<span class=\"built_in\">std</span>::mutex&gt; lck (mtx);</span><br><span class=\"line\">        print_even(id);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"keyword\">catch</span> (<span class=\"built_in\">std</span>::logic_error&amp;) &#123;</span><br><span class=\"line\">        <span class=\"built_in\">std</span>::<span class=\"built_in\">cout</span> &lt;&lt; <span class=\"string\">\"[exception caught]\\n\"</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">int</span> <span class=\"title\">main</span> <span class=\"params\">()</span></span></span><br><span class=\"line\"><span class=\"function\"></span>&#123;</span><br><span class=\"line\">    <span class=\"built_in\">std</span>::thread threads[<span class=\"number\">10</span>];</span><br><span class=\"line\">    <span class=\"comment\">// spawn 10 threads:</span></span><br><span class=\"line\">    <span class=\"keyword\">for</span> (<span class=\"keyword\">int</span> i=<span class=\"number\">0</span>; i&lt;<span class=\"number\">10</span>; ++i)</span><br><span class=\"line\">        threads[i] = <span class=\"built_in\">std</span>::thread(print_thread_id,i+<span class=\"number\">1</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">for</span> (<span class=\"keyword\">auto</span>&amp; th : threads) th.join();</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"number\">0</span>;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></div></figure>\n\n<p>è¾“å‡ºç»“æœï¼š</p>\n<figure class=\"highlight c++\"><div><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$g++ -lpthread -o main *.cpp</span><br><span class=\"line\">$main</span><br><span class=\"line\">[exception caught]</span><br><span class=\"line\"><span class=\"number\">4</span> is even</span><br><span class=\"line\">[exception caught]</span><br><span class=\"line\"><span class=\"number\">2</span> is even</span><br><span class=\"line\">[exception caught]</span><br><span class=\"line\"><span class=\"number\">6</span> is even</span><br><span class=\"line\"><span class=\"number\">8</span> is even</span><br><span class=\"line\">[exception caught]</span><br><span class=\"line\">[exception caught]</span><br><span class=\"line\"><span class=\"number\">10</span> is even</span><br></pre></td></tr></table></div></figure>\n\n<h2 id=\"std-unique-lock-ä»‹ç»\">std::unique_lock ä»‹ç»<a href=\"post/Mutexä»‹ç»#std-unique-lock-ä»‹ç»\"></a></h2><p>ä¸ Mutex RAII ç›¸å…³ï¼Œæ–¹ä¾¿çº¿ç¨‹å¯¹äº’æ–¥é‡ä¸Šé”ï¼Œä½†æä¾›äº†æ›´å¥½çš„ä¸Šé”å’Œè§£é”æ§åˆ¶ã€‚ä¾‹å­ï¼ˆ<a href=\"http://www.cplusplus.com/reference/mutex/unique_lock/\" target=\"_blank\" rel=\"noopener\">å‚è€ƒ</a>ï¼‰ï¼š</p>\n<ul>\n<li>1.ç±» unique_lock æ˜¯é€šç”¨äº’æ–¥åŒ…è£…å™¨ï¼Œå…è®¸<code>å»¶è¿Ÿé”å®šã€é”å®šçš„æœ‰æ—¶é™å°è¯•ã€é€’å½’é”å®šã€æ‰€æœ‰æƒè½¬ç§»å’Œä¸æ¡ä»¶å˜é‡ä¸€åŒä½¿ç”¨</code>ã€‚</li>\n<li>2.unique_lockæ¯”lock_guardä½¿ç”¨æ›´åŠ çµæ´»ï¼ŒåŠŸèƒ½æ›´åŠ å¼ºå¤§ã€‚<br>ä½¿ç”¨unique_lockéœ€è¦ä»˜å‡ºæ›´å¤šçš„æ—¶é—´ã€æ€§èƒ½æˆæœ¬ã€‚</li>\n</ul>\n<figure class=\"highlight c++\"><div><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#<span class=\"meta-keyword\">include</span> <span class=\"meta-string\">&lt;iostream&gt;       // std::cout</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"meta-keyword\">include</span> <span class=\"meta-string\">&lt;thread&gt;         // std::thread</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"meta-keyword\">include</span> <span class=\"meta-string\">&lt;mutex&gt;          // std::mutex, std::unique_lock</span></span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"built_in\">std</span>::mutex mtx;           <span class=\"comment\">// mutex for critical section</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">void</span> <span class=\"title\">print_block</span> <span class=\"params\">(<span class=\"keyword\">int</span> n, <span class=\"keyword\">char</span> c)</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"comment\">// critical section (exclusive access to std::cout signaled by lifetime of lck):</span></span><br><span class=\"line\">    <span class=\"built_in\">std</span>::unique_lock&lt;<span class=\"built_in\">std</span>::mutex&gt; lck (mtx);</span><br><span class=\"line\">    <span class=\"keyword\">for</span> (<span class=\"keyword\">int</span> i=<span class=\"number\">0</span>; i&lt;n; ++i) &#123;</span><br><span class=\"line\">        <span class=\"built_in\">std</span>::<span class=\"built_in\">cout</span> &lt;&lt; c;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"built_in\">std</span>::<span class=\"built_in\">cout</span> &lt;&lt; <span class=\"string\">'\\n'</span>;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">int</span> <span class=\"title\">main</span> <span class=\"params\">()</span></span></span><br><span class=\"line\"><span class=\"function\"></span>&#123;</span><br><span class=\"line\">    <span class=\"built_in\">std</span>::<span class=\"function\">thread <span class=\"title\">th1</span> <span class=\"params\">(print_block,<span class=\"number\">50</span>,<span class=\"string\">'*'</span>)</span></span>;</span><br><span class=\"line\">    <span class=\"built_in\">std</span>::<span class=\"function\">thread <span class=\"title\">th2</span> <span class=\"params\">(print_block,<span class=\"number\">50</span>,<span class=\"string\">'$'</span>)</span></span>;</span><br><span class=\"line\"></span><br><span class=\"line\">    th1.join();</span><br><span class=\"line\">    th2.join();</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"number\">0</span>;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></div></figure>\n\n<p>è¾“å‡ºç»“æœï¼š</p>\n<figure class=\"highlight c++\"><div><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$g++ -lpthread -o main *.cpp</span><br><span class=\"line\">$main</span><br><span class=\"line\">**************************************************</span><br><span class=\"line\">$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$</span><br></pre></td></tr></table></div></figure>\n\n<p>å¥½äº†ï¼Œæœ¬æ–‡æš‚æ—¶è®²åˆ°è¿™é‡Œï¼Œè¿˜å‰©ä¸‹ std::try_lockï¼Œstd::lockï¼Œstd::call_once ä¸‰ä¸ªå‡½æ•°æ²¡æœ‰è®²åˆ°ï¼Œç•™åœ¨ä¸‹ä¸€ç¯‡åšå®¢ä¸­è®²å§ ;-)</p>\n","slug":"Mutexä»‹ç»","updated":"2019-06-26T01:57:03.838Z","comments":true,"link":"post/Mutexä»‹ç»","permalink":"https://shuntan.github.io/posts/Mutexä»‹ç»/","excerpt":"HeadMutex åˆç§°äº’æ–¥é‡ï¼ŒC++ 11ä¸­ä¸ Mutex ç›¸å…³çš„ç±»ï¼ˆåŒ…æ‹¬é”ç±»å‹ï¼‰å’Œå‡½æ•°éƒ½å£°æ˜åœ¨ å¤´æ–‡ä»¶ä¸­ï¼Œæ‰€ä»¥å¦‚æœä½ éœ€è¦ä½¿ç”¨ std::mutexï¼Œå°±å¿…é¡»åŒ…å« å¤´æ–‡ä»¶ã€‚ å¤´æ–‡ä»¶ä»‹ç»ewde2e Mutex ç³»åˆ—ç±»(å››ç§) std::mutexï¼Œæœ€åŸºæœ¬çš„ Mutex ç±»ã€‚ std::recursive_mutexï¼Œé€’å½’ Mutex ç±»ã€‚ std::time_mutexï¼Œå®šæ—¶ Mutex ç±»ã€‚ std::recursive_timed_mutexï¼Œå®šæ—¶é€’å½’ Mutex ç±»ã€‚","categories":[{"name":"C++","slug":"C","permalink":"https://shuntan.github.io/categories/C/"}],"tags":[{"name":"C++","slug":"C","permalink":"https://shuntan.github.io/tags/C/"},{"name":"Mutex","slug":"Mutex","permalink":"https://shuntan.github.io/tags/Mutex/"}]},{"title":"squidä»‹ç»åŠå…¶ç®€å•é…ç½®","date":"2019-05-15T07:15:30.000Z","path":"posts/squid/","text":"squidçš„æ¦‚å¿µsquidæ˜¯ä¸€ç§ç”¨æ¥ç¼“å­˜Internetæ•°æ®çš„è½¯ä»¶ã€‚æ¥å—æ¥è‡ªäººä»¬éœ€è¦ä¸‹è½½çš„ç›®æ ‡ï¼ˆobjectï¼‰çš„è¯·æ±‚å¹¶é€‚å½“çš„å¤„ç†è¿™äº›è¯·æ±‚ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œå¦‚æœä¸€ä¸ªäººæƒ³ä¸‹è½½ä¸€webç•Œé¢ï¼Œä»–è¯·æ±‚squidä¸ºä»–å–å¾—è¿™ä¸ªé¡µé¢ã€‚squidéšä¹‹è¿æ¥åˆ°è¿œç¨‹æœåŠ¡å™¨å¹¶å‘è¿™ä¸ªé¡µé¢å‘å‡ºè¯·æ±‚ã€‚ç„¶åï¼Œsquidæ˜¾å¼åœ°èšé›†æ•°æ®åˆ°å®¢æˆ·ç«¯æœºå™¨ï¼Œè€Œä¸”åŒæ—¶å¤åˆ¶ä¸€ä»½ã€‚å½“ä¸‹ä¸€æ¬¡æœ‰äººéœ€è¦åŒä¸€é¡µé¢æ—¶ï¼Œ squidå¯ä»¥ç®€å•çš„ä»ç£ç›˜ä¸­è¯»åˆ°å®ƒï¼Œé‚£æ ·æ•°æ®ä¼šç«‹å³ä¼ è¾“åˆ°å®¢æˆ·æœºä¸Šã€‚ ä¸‹è½½åœ°å€squid-cache å®˜ç½‘ http://www.squid-cache.org squidä»‹ç»åŠå…¶ç®€å•é…ç½® https://www.cnblogs.com/cherishry/p/5706736.html CentOS 7å®‰è£…squidä»£ç†æœåŠ¡å™¨ https://blog.csdn.net/ithomer/article/details/78136993 squidä»£ç†çš„ä½œç”¨ é€šè¿‡ç¼“å­˜çš„æ–¹å¼ä¸ºç”¨æˆ·æä¾›Webè®¿é—®åŠ é€Ÿ å¯¹ç”¨æˆ·çš„Webè®¿é—®è¿›è¡Œè¿‡æ»¤æ§åˆ¶ å·¥ä½œæµç¨‹å½“ä»£ç†æœåŠ¡å™¨ä¸­æœ‰å®¢æˆ·ç«¯éœ€è¦çš„æ•°æ®æ—¶ï¼š a.å®¢æˆ·ç«¯å‘ä»£ç†æœåŠ¡å™¨å‘é€æ•°æ®è¯·æ±‚ï¼› b.ä»£ç†æœåŠ¡å™¨æ£€æŸ¥è‡ªå·±çš„æ•°æ®ç¼“å­˜ï¼› c.ä»£ç†æœåŠ¡å™¨åœ¨ç¼“å­˜ä¸­æ‰¾åˆ°äº†ç”¨æˆ·æƒ³è¦çš„æ•°æ®ï¼Œå–å‡ºæ•°æ®ï¼› d.ä»£ç†æœåŠ¡å™¨å°†ä»ç¼“å­˜ä¸­å–å¾—çš„æ•°æ®è¿”å›ç»™å®¢æˆ·ç«¯ã€‚ å½“ä»£ç†æœåŠ¡å™¨ä¸­æ²¡æœ‰å®¢æˆ·ç«¯éœ€è¦çš„æ•°æ®æ—¶äº†ï¼š 1.å®¢æˆ·ç«¯å‘ä»£ç†æœåŠ¡å™¨å‘é€æ•°æ®è¯·æ±‚ï¼› 2.ä»£ç†æœåŠ¡å™¨æ£€æŸ¥è‡ªå·±çš„æ•°æ®ç¼“å­˜ï¼› 3.ä»£ç†æœåŠ¡å™¨åœ¨ç¼“å­˜ä¸­æ²¡æœ‰æ‰¾åˆ°ç”¨æˆ·æƒ³è¦çš„æ•°æ®ï¼› 4.ä»£ç†æœåŠ¡å™¨å‘Internet ä¸Šçš„è¿œç«¯æœåŠ¡å™¨å‘é€æ•°æ®è¯·æ±‚ï¼› 5.è¿œç«¯æœåŠ¡å™¨å“åº”ï¼Œè¿”å›ç›¸åº”çš„æ•°æ®ï¼› 6.ä»£ç†æœåŠ¡å™¨å–å¾—è¿œç«¯æœåŠ¡å™¨çš„æ•°æ®ï¼Œè¿”å›ç»™å®¢æˆ·ç«¯ï¼Œå¹¶ä¿ç•™ä¸€ä»½åˆ°è‡ªå·±çš„æ•°æ®ç¼“å­˜ä¸­ã€‚ Squidä»£ç†æœåŠ¡å™¨å·¥ä½œåœ¨TCP/IPåº”ç”¨å±‚ Squidå„ç§ä»£ç†çš„å®šä¹‰æ­£å‘ä»£ç†æ ‡å‡†çš„ä»£ç†ç¼“å†²æœåŠ¡å™¨ä¸€ä¸ªæ ‡å‡†çš„ä»£ç†ç¼“å†²æœåŠ¡è¢«ç”¨äºç¼“å­˜é™æ€çš„ç½‘é¡µåˆ°æœ¬åœ°ç½‘ç»œä¸Šçš„ä¸€å°ä¸»æœºä¸Šï¼ˆå³ä»£ç†æœåŠ¡å™¨ï¼‰ã€‚å½“è¢«ç¼“å­˜çš„é¡µé¢è¢«ç¬¬äºŒæ¬¡è®¿é—®çš„æ—¶å€™ï¼Œæµè§ˆå™¨å°†ç›´æ¥ä»æœ¬åœ°ä»£ç†æœåŠ¡å™¨é‚£é‡Œè·å–è¯·æ±‚æ•°æ®è€Œä¸å†å‘åŸwebç«™ç‚¹è¯·æ±‚æ•°æ®ã€‚è¿™æ ·å°±èŠ‚çœäº†å®è´µçš„ç½‘ç»œå¸¦å®½ï¼Œè€Œä¸”æé«˜äº†è®¿é—®é€Ÿåº¦ã€‚ä½†æ˜¯ï¼Œè¦æƒ³å®ç°è¿™ç§æ–¹å¼ï¼Œå¿…é¡»åœ¨æ¯ä¸€ä¸ªå†…éƒ¨ä¸»æœºçš„æµè§ˆå™¨ä¸Šæ˜ç¡®æŒ‡åä»£ç†æœåŠ¡å™¨çš„IPåœ°å€å’Œç«¯å£å·ã€‚å®¢æˆ·ç«¯ä¸Šç½‘æ—¶ï¼Œæ¯æ¬¡éƒ½æŠŠè¯·æ±‚å‘é€ç»™ä»£ç†æœåŠ¡å™¨å¤„ç†,ä»£ç†æœåŠ¡å™¨æ ¹æ®è¯·æ±‚ç¡®å®šæ˜¯å¦è¿æ¥åˆ°è¿œç¨‹webæœåŠ¡å™¨è·å–æ•°æ®ã€‚å¦‚æœåœ¨æœ¬åœ°ç¼“å†²åŒºæœ‰ç›®æ ‡æ–‡ä»¶ï¼Œåˆ™ç›´æ¥å°†æ–‡ä»¶ä¼ ç»™ç”¨æˆ·å³å¯ã€‚å¦‚æœæ²¡æœ‰çš„è¯åˆ™å…ˆå–å›æ–‡ä»¶ï¼Œå…ˆåœ¨æœ¬åœ°ä¿å­˜ä¸€ä»½ç¼“å†²ï¼Œç„¶åå°†æ–‡ä»¶å‘é€ç»™å®¢æˆ·ç«¯æµè§ˆå™¨ã€‚ é€æ˜ä»£ç†ç¼“å†²æœåŠ¡å™¨é€æ˜ä»£ç†ç¼“å†²æœåŠ¡å™¨å’Œæ ‡å‡†ä»£ç†æœåŠ¡å™¨çš„åŠŸèƒ½å®Œå…¨ç›¸åŒã€‚ä½†æ˜¯ï¼Œä»£ç†æ“ä½œå¯¹å®¢æˆ·ç«¯çš„æµè§ˆå™¨æ˜¯é€æ˜çš„ï¼ˆå³ä¸éœ€æŒ‡æ˜ä»£ç†æœåŠ¡å™¨çš„IPå’Œç«¯å£ï¼‰ã€‚é€æ˜ä»£ç†æœåŠ¡å™¨é˜»æ–­ç½‘ç»œé€šä¿¡ï¼Œå¹¶ä¸”è¿‡æ»¤å‡ºè®¿é—®å¤–éƒ¨çš„HTTPï¼ˆ80ç«¯å£ï¼‰æµé‡ã€‚å¦‚æœå®¢æˆ·ç«¯çš„è¯·æ±‚åœ¨æœ¬åœ°æœ‰ç¼“å†²åˆ™å°†ç¼“å†²çš„æ•°æ®ç›´æ¥å‘ç»™ç”¨æˆ·ï¼Œå¦‚æœåœ¨æœ¬åœ°æ²¡æœ‰ç¼“å†²åˆ™å‘è¿œç¨‹webæœåŠ¡å™¨å‘å‡ºè¯·æ±‚ï¼Œå…¶ä½™æ“ä½œå’Œæ ‡å‡†çš„ä»£ç†æœåŠ¡å™¨å®Œå…¨ç›¸åŒã€‚å¯¹äºlinuxæ“ä½œç³»ç»Ÿæ¥è¯´ï¼Œé€æ˜ä»£ç†ä½¿ç”¨Iptablesæˆ–è€…Ipchainså®ç°ã€‚å› æ­¤ä¸éœ€è¦å¯¹æµè§ˆå™¨ä½œä»»ä½•è®¾ç½®ï¼Œæ‰€ä»¥ï¼Œé€æ˜ä»£ç†å¯¹äºISPï¼ˆInternetæœåŠ¡å™¨æä¾›å•†ï¼‰ç‰¹åˆ«æœ‰ç”¨ã€‚ åå‘ä»£ç†åå‘ä»£ç†ç¼“å†²å™¨åå‘ä»£ç†æ˜¯å’Œå‰ä¸¤ç§ä»£ç†å®Œå…¨ä¸åŒçš„ä¸€ç§ä»£ç†æœåŠ¡ã€‚ä½¿ç”¨å®ƒå¯ä»¥é™ä½åŸå§‹WEBæœåŠ¡å™¨çš„è´Ÿè½½ã€‚åå‘ä»£ç†æœåŠ¡å™¨æ‰¿æ‹…äº†å¯¹åŸå§‹WEBæœåŠ¡å™¨çš„é™æ€é¡µé¢çš„è¯·æ±‚ï¼Œé˜²æ­¢åŸå§‹æœåŠ¡å™¨è¿‡è½½ã€‚å®ƒä½äºWEBæœåŠ¡å™¨å’ŒInternetä¹‹é—´ï¼Œå¤„ç†æ‰€æœ‰å¯¹WEBæœåŠ¡å™¨çš„è¯·æ±‚ï¼Œç»„ç»‡äº†WEBæœåŠ¡å™¨å’ŒInternetçš„ç›´æ¥é€šä¿¡ã€‚å¦‚æœäº’è”ç½‘ç”¨æˆ·è¯·æ±‚çš„é¡µé¢åœ¨ä»£ç†æœåŠ¡å™¨ä¸Šæœ‰ç¼“å†²çš„è¯ï¼Œä»£ç†æœåŠ¡å™¨ç›´æ¥å°†ç¼“å†²å†…å®¹å‘é€ç»™ç”¨æˆ·ã€‚å¦‚æœæ²¡æœ‰ç¼“å†²åˆ™å…ˆå‘WEBæœåŠ¡å™¨å‘å‡ºè¯·æ±‚ï¼Œå–å›æ•°æ®ï¼Œæœ¬åœ°ç¼“å­˜åå†å‘ç»™ç”¨æˆ·ã€‚è¿™ç§æ–¹å¼é€šè¿‡é™ä½äº†WEBæœåŠ¡å™¨çš„è¯·æ±‚æ•°ä»è€Œé™ä½äº†WEBæœåŠ¡å™¨çš„è´Ÿè½½ã€‚ æ­£å‘ä»£ç†ä¸åå‘ä»£ç†çš„åŒºåˆ«æ¦‚å¿µæ­£å‘ä»£ç†ï¼šå¯¹äºåŸå§‹æœåŠ¡å™¨è€Œè¨€ï¼Œå°±æ˜¯å®¢æˆ·ç«¯çš„ä»£è¨€äººåå‘ä»£ç†ï¼šå¯¹äºå®¢æˆ·ç«¯è€Œè¨€ï¼Œå°±åƒæ˜¯åŸå§‹æœåŠ¡å™¨ ç”¨é€”æ­£å‘ä»£ç†çš„å…¸å‹ç”¨é€”æ˜¯ä¸ºåœ¨é˜²ç«å¢™å†…çš„å±€åŸŸç½‘å®¢æˆ·ç«¯æä¾›è®¿é—®Internetçš„é€”å¾„ã€‚æ­£å‘ä»£ç†è¿˜å¯ä»¥ä½¿ç”¨ç¼“å†²ç‰¹æ€§å‡å°‘ç½‘ç»œä½¿ç”¨ç‡ã€‚åå‘ä»£ç†è¿˜å¯ä»¥ä¸ºåç«¯çš„å¤šå°æœåŠ¡å™¨æä¾›è´Ÿè½½å¹³è¡¡ï¼Œæˆ–ä¸ºåç«¯è¾ƒæ…¢çš„æœåŠ¡å™¨æä¾›ç¼“å†²æœåŠ¡ã€‚å¦å¤–ï¼Œåå‘ä»£ç†è¿˜å¯ä»¥å¯ç”¨é«˜çº§URLç­–ç•¥å’Œç®¡ç†æŠ€æœ¯ï¼Œä»è€Œä½¿å¤„äºä¸åŒwebæœåŠ¡å™¨ç³»ç»Ÿçš„webé¡µé¢åŒæ—¶å­˜åœ¨äºåŒä¸€ä¸ªURLç©ºé—´ä¸‹ã€‚ å®‰å…¨æ€§æ­£å‘ä»£ç†å…è®¸å®¢æˆ·ç«¯é€šè¿‡å®ƒè®¿é—®ä»»æ„ç½‘ç«™å¹¶ä¸”éšè—å®¢æˆ·ç«¯è‡ªèº«ï¼Œå› æ­¤ä½ å¿…é¡»é‡‡å–å®‰å…¨æªæ–½ä»¥ç¡®ä¿ä»…ä¸ºç»è¿‡æˆæƒçš„å®¢æˆ·ç«¯æä¾›æœåŠ¡ã€‚åå‘ä»£ç†å¯¹å¤–éƒ½æ˜¯é€æ˜çš„ï¼Œè®¿é—®è€…å¹¶ä¸çŸ¥é“è‡ªå·±è®¿é—®çš„æ˜¯ä¸€ä¸ªä»£ç†ã€‚ Squidä¸»è¦ç»„æˆéƒ¨åˆ†æœåŠ¡åï¼šsquidä¸»ç¨‹åºï¼š/usr/sbin/squidé…ç½®ç›®å½•ï¼š/etc/squidä¸»é…ç½®æ–‡ä»¶ï¼š/etc/squid/squid.confç›‘å¬tcpç«¯å£å·ï¼š3128é»˜è®¤è®¿é—®æ—¥å¿—æ–‡ä»¶ï¼š/var/log/squid/access.log squidå¸¸ç”¨é…ç½®é€‰é¡¹/etc/squid/squid.conf 123456789101112131415http_port 3128 (è¿˜å¯ä»¥åªç›‘å¬ä¸€ä¸ªIP http_port 192.168.0.1:3128)cache_mem 64MB #ç¼“å­˜å å†…å­˜å¤§å°maximum_object_size 4096KB #æœ€å¤§ç¼“å­˜å—reply_body_max_size 1024000 allow all #é™å®šä¸‹è½½æ–‡ä»¶å¤§å°access_log /var/log/squid/access.log #è®¿é—®æ—¥å¿—å­˜æ”¾çš„åœ°æ–¹visible_hostname proxy.test.xom #å¯è§çš„ä¸»æœºåcache_dir ufs /var/spool/squid 100 16 256 #ufs:ç¼“å­˜æ•°æ®çš„å­˜å‚¨æ ¼å¼#/var/spool/squid ç¼“å­˜ç›®å½•#100ï¼šç¼“å­˜ç›®å½•å ç£ç›˜ç©ºé—´å¤§å°ï¼ˆMï¼‰#16ï¼šç¼“å­˜ç©ºé—´ä¸€çº§å­ç›®å½•ä¸ªæ•°#256ï¼šç¼“å­˜ç©ºé—´äºŒçº§å­ç›®å½•ä¸ªæ•°cache_mgr webmaster@test.com #å®šä¹‰ç®¡ç†å‘˜é‚®ç®±http_access deny all #è®¿é—®æ§åˆ¶ squidä¸­çš„è®¿é—®æ§åˆ¶ ä½¿ç”¨è®¿é—®æ§åˆ¶ç‰¹æ€§ï¼Œå¯ä»¥æ§åˆ¶åœ¨è®¿é—®æ—¶æ ¹æ®ç‰¹å®šçš„æ—¶é—´é—´éš”è¿›è¡Œç¼“å­˜ã€è®¿é—®ç‰¹å®šç«™ç‚¹æˆ–ä¸€ç»„ç«™ç‚¹ç­‰ç­‰ã€‚squidè®¿é—®æ§åˆ¶æœ‰ä¸¤ä¸ªè¦ç´ ï¼šACLå…ƒç´ å’Œè®¿é—®åˆ—è¡¨ã€‚è®¿é—®åˆ—è¡¨å¯ä»¥å…è®¸æˆ–æ‹’ç»æŸäº›ç”¨æˆ·å¯¹æ­¤æœåŠ¡çš„è®¿é—®ã€‚ ACLå…ƒç´ ç±»å‹ srcï¼šæºåœ°å€ï¼ˆå³å®¢æˆ·æœºIPåœ°å€ï¼‰ dstï¼šç›®æ ‡åœ°å€ï¼ˆå³æœåŠ¡å™¨IPåœ°å€ï¼‰ srcdomainï¼šæºåç§°ï¼ˆå³å®¢æˆ·æœºåç§°ï¼‰ dstdomainï¼šç›®æ ‡åç§°ï¼ˆå³æœåŠ¡å™¨åç§°ï¼‰ timeï¼šä¸€å¤©ä¸­çš„æ—¶åˆ»å’Œä¸€å‘¨å†…çš„ä¸€å¤© url_regexï¼šURLè§„åˆ™è¡¨è¾¾å¼åŒ¹é… urlpath_regexï¼šURL-pathè§„åˆ™è¡¨è¾¾å¼åŒ¹é…ï¼Œç•¥å»åè®®å’Œä¸»æœºå proxy_authï¼šé€šè¿‡å¤–éƒ¨ç¨‹åºè¿›è¡Œç”¨æˆ·éªŒè¯ maxconnï¼šå•ä¸€IPçš„æœ€å¤§è¿æ¥æ•° ACLæ ¼å¼ä¸ºäº†ä½¿ç”¨æ§åˆ¶åŠŸèƒ½ï¼Œå¿…é¡»å…ˆè®¾ç½®ACLè§„åˆ™å¹¶åº”ç”¨ã€‚ACLå£°æ˜çš„æ ¼å¼å¦‚ä¸‹ï¼šæ³¨ï¼š acl_element_name å¯ä»¥æ˜¯ä»»ä¸€ä¸ªåœ¨ACLä¸­å®šä¹‰çš„åç§° ä»»ä½•ä¸¤ä¸ªACLå…ƒç´ ä¸èƒ½ç”¨ç›¸åŒçš„åå­— æ¯ä¸ªACLç”±åˆ—è¡¨å€¼ç»„æˆã€‚å½“è¿›è¡ŒåŒ¹é…æ£€æµ‹çš„æ—¶å€™ï¼Œå¤šä¸ªå€¼ç”±é€»è¾‘æˆ–è¿ç®—è¿æ¥ï¼›æ¢è¨€ä¹‹ï¼Œå³ä»»ä¸€ACLå…ƒç´ çš„å€¼è¢«åŒ¹é…ï¼Œåˆ™è¿™ä¸ªACLå…ƒç´ å³è¢«åŒ¹é…ã€‚ å¹¶ä¸æ˜¯æ‰€æœ‰ACLå…ƒç´ éƒ½èƒ½ä½¿ç”¨è®¿é—®åˆ—è¡¨ä¸­çš„å…¨éƒ¨ç±»å‹ ä¸åŒçš„ACLå…ƒç´ å†™åœ¨ä¸åŒè¡Œä¸­ï¼Œsquidå°†æŠŠä»–ä»¬ç»„åˆåœ¨ä¸€ä¸ªåˆ—è¡¨ä¸­ è®¿é—®æ¡ç›®æˆ‘ä»¬å¯ä»¥ä½¿ç”¨è®¸å¤šä¸åŒçš„è®¿é—®æ¡ç›®ã€‚ä¸‹é¢æ˜¯æˆ‘ä»¬å¸¸ç”¨çš„å‡ ä¸ªï¼š http_access:å…è®¸HTTPè®¿é—® no_cache:å®šä¹‰å¯¹ç¼“å­˜è¯·æ±‚çš„å“åº”ã€‚è®¿é—®åˆ—è¡¨çš„è§„åˆ™ç”±ä¸€äº›ç±»ä¼¼â€™allowâ€™æˆ–â€˜denyâ€™çš„å…³é”®å­—æ„æˆï¼Œç”¨ä»¥å…è®¸æˆ–æ‹’ç»å‘ç‰¹å®šæˆ–ä¸€ç»„ACLå…ƒç´ æä¾›æœåŠ¡ã€‚ ä¸€ä¸ªè®¿é—®åˆ—è¡¨å¯ä»¥ç”±å¤šæ¡è§„åˆ™ç»„æˆ å¦‚æœæ²¡æœ‰ä»»ä½•è§„åˆ™ä¸è®¿é—®è¯·æ±‚åŒ¹é…ï¼Œé»˜è®¤åŠ¨ä½œå°†ä¸åˆ—è¡¨ä¸­æœ€åä¸€æ¡è§„åˆ™å¯¹åº”ã€‚ ä¸€ä¸ªè®¿é—®æ¡ç›®ä¸­æ‰€æœ‰å…ƒç´ å°†ç”¨é€»è¾‘ä¸è¿ç®—è¿æ¥http_access Action å£°æ˜1 AND å£°æ˜2 AND å£°æ˜ OR.http_access Action å£°æ˜3å¤šä¸ªhttp_accessså£°æ˜é—´ç”¨æˆ–è¿ç®—è¿æ¥ï¼Œä½†æ¯ä¸ªè®¿é—®æ¡ç›®çš„å…ƒç´ é—´ç”¨ä¸è¿ç®—è¿æ¥ã€‚ åˆ—è¡¨ä¸­çš„è§„åˆ™æ€»æ˜¯éµå¾ªç”±ä¸Šè€Œä¸‹çš„é¡ºåº è¿™äº›è§„åˆ™æŒ‰ç…§ä»–ä»¬çš„æ’åˆ—é¡ºåºè¿›è¡ŒåŒ¹é…æ£€æµ‹ï¼Œä¸€æ—¦æ£€æµ‹åˆ°åŒ¹é…çš„è§„åˆ™ï¼ŒåŒ¹é…å°±ç«‹å³ç»“æŸã€‚ Squid.confé…ç½®æ–‡ä»¶è¯¦è§£123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129130131132133134135136137138139140141142143144145146147148149150151152153154155156#acl all src 0.0.0.0/0.0.0.0 and http_access allow allé€‰é¡¹å®šä¹‰äº†ä¸€ä¸ªè®¿é—®æ§åˆ¶åˆ—è¡¨ã€‚è¯¦ç»†æƒ…å†µå‚è§å’ŒSquidè½¯ä»¶#æºå¸¦çš„æ–‡æ¡£ã€‚è¿™é‡Œçš„è®¿é—®æ§åˆ¶åˆ—è¡¨å…è®¸æ‰€æœ‰å¯¹ä»£ç†æœåŠ¡çš„è®¿é—®ï¼Œå› ä¸ºè¿™é‡Œè¯¥ä»£ç†æ˜¯åŠ é€ŸwebæœåŠ¡å™¨ã€‚acl all src 0.0.0.0/0.0.0.0 #å…è®¸æ‰€æœ‰IPè®¿é—®acl manager proto http #manager urlåè®®ä¸ºhttpacl localhost src 127.0.0.1/255.255.255.255 #å…åˆæœ¬æœºIPacl to_localhost dst 127.0.0.1 #å…åˆç›®çš„åœ°å€ä¸ºæœ¬æœºIPacl Safe_ports port 80 # å…è®¸å®‰å…¨æ›´æ–°çš„ç«¯å£ä¸º80acl CONNECT method CONNECT #è¯·æ±‚æ–¹æ³•ä»¥CONNECThttp_access allow all #å…è®¸æ‰€æœ‰äººä½¿ç”¨è¯¥ä»£ç†.å› ä¸ºè¿™é‡Œæ˜¯ä»£ç†åŠ é€ŸwebæœåŠ¡å™¨http_reply_access allow all #å…è®¸æ‰€æœ‰å®¢æˆ·ç«¯ä½¿ç”¨è¯¥ä»£ç†acl OverConnLimit maxconn 16 #é™åˆ¶æ¯ä¸ªIPæœ€å¤§å…è®¸16ä¸ªè¿æ¥ï¼Œé˜²æ­¢æ”»å‡»http_access deny OverConnLimiticp_access deny all #ç¦æ­¢ä»é‚»å±…æœåŠ¡å™¨ç¼“å†²å†…å‘é€å’Œæ¥æ”¶ICPè¯·æ±‚.miss_access allow all #å…è®¸ç›´æ¥æ›´æ–°è¯·æ±‚ident_lookup_access deny all #ç¦æ­¢lookupæ£€æŸ¥DNShttp_port 8080 transparent #æŒ‡å®šSquidç›‘å¬æµè§ˆå™¨å®¢æˆ·è¯·æ±‚çš„ç«¯å£å·ã€‚hierarchy_stoplist cgi-bin ? #ç”¨æ¥å¼ºåˆ¶æŸäº›ç‰¹å®šçš„å¯¹è±¡ä¸è¢«ç¼“å­˜ï¼Œä¸»è¦æ˜¯å¤„äºå®‰å…¨çš„ç›®çš„ã€‚acl QUERY urlpath_regex cgi-bin \\?cache deny QUERYcache_mem 1 GB #è¿™æ˜¯ä¸€ä¸ªä¼˜åŒ–é€‰é¡¹ï¼Œå¢åŠ è¯¥å†…å­˜å€¼æœ‰åˆ©äºç¼“å­˜ã€‚åº”è¯¥æ³¨æ„çš„æ˜¯ï¼š #ä¸€èˆ¬æ¥è¯´å¦‚æœç³»ç»Ÿæœ‰å†…å­˜ï¼Œè®¾ç½®è¯¥å€¼ä¸º(n/)3Mã€‚ç°åœ¨æ˜¯3G æ‰€ä»¥è¿™é‡Œ1Gfqdncache_size 1024 #FQDN é«˜é€Ÿç¼“å­˜å¤§å°maximum_object_size_in_memory 2 MB #å…è®¸æœ€å¤§çš„æ–‡ä»¶è½½å…¥å†…å­˜memory_replacement_policy heap LFUDA #åŠ¨æ€ä½¿ç”¨æœ€å°çš„ï¼Œç§»å‡ºå†…å­˜cachecache_replacement_policy heap LFUDA #åŠ¨æ€ä½¿ç”¨æœ€å°çš„ï¼Œç§»å‡ºç¡¬ç›˜cachecache_dir ufs /home/cache 5000 32 512 #é«˜é€Ÿç¼“å­˜ç›®å½• ufs ç±»å‹ ä½¿ç”¨çš„ç¼“å†²å€¼æœ€å¤§å…åˆ1000MBç©ºé—´ï¼Œ#32ä¸ªä¸€çº§ç›®å½•ï¼Œ512ä¸ªäºŒçº§ç›®å½•max_open_disk_fds 0 #å…è®¸æœ€å¤§æ‰“å¼€æ–‡ä»¶æ•°é‡,0 æ— é™åˆ¶minimum_object_size 1 KB #å…åˆæœ€å°æ–‡ä»¶è¯·æ±‚ä½“å¤§å°maximum_object_size 20 MB #å…åˆæœ€å¤§æ–‡ä»¶è¯·æ±‚ä½“å¤§å°cache_swap_low 90 #æœ€å°å…è®¸ä½¿ç”¨swap 90%cache_swap_high 95 #æœ€å¤šå…è®¸ä½¿ç”¨swap 95%ipcache_size 2048 # IP åœ°å€é«˜é€Ÿç¼“å­˜å¤§å° 2Mipcache_low 90 #æœ€å°å…è®¸ipcacheä½¿ç”¨swap 90%ipcache_high 95 #æœ€å¤§å…è®¸ipcacheä½¿ç”¨swap 90%access_log /var/log/squid/access.log squid #å®šä¹‰æ—¥å¿—å­˜æ”¾è®°å½•cache_log /var/log/squid/cache.log squidcache_store_log none #ç¦æ­¢storeæ—¥å¿—emulate_httpd_log on #å°†ä½¿Squidä»¿ç…§WebæœåŠ¡å™¨çš„æ ¼å¼åˆ›å»ºè®¿é—®è®°å½•ã€‚å¦‚æœå¸Œæœ›ä½¿ç”¨ #Webè®¿é—®è®°å½•åˆ†æç¨‹åºï¼Œå°±éœ€è¦è®¾ç½®è¿™ä¸ªå‚æ•°ã€‚refresh_pattern . 0 20% 4320 override-expire override-lastmod reload-into-ims ignore-reload #æ›´æ–°cacheè§„åˆ™acl buggy_server url_regex ^http://.... http:// #åªå…è®¸httpçš„è¯·æ±‚broken_posts allow buggy_serveracl apache rep_header Server ^Apache #å…è®¸apacheçš„ç¼–ç broken_vary_encoding allow apacherequest_entities off #ç¦æ­¢éhttpçš„æ ‡åˆ†å‡†è¯·æ±‚ï¼Œé˜²æ­¢æ”»å‡»header_access header allow all #å…è®¸æ‰€æœ‰çš„httpæŠ¥å¤´relaxed_header_parser on #ä¸ä¸¥æ ¼åˆ†æhttpæŠ¥å¤´.client_lifetime 120 minute #æœ€å¤§å®¢æˆ·è¿æ¥æ—¶é—´ 120åˆ†é’Ÿcache_mgr sky@test.com #æŒ‡å®šå½“ç¼“å†²å‡ºç°é—®é¢˜æ—¶å‘ç¼“å†²ç®¡ç†è€…å‘é€å‘Šè­¦ä¿¡æ¯çš„åœ°å€ä¿¡æ¯ã€‚cache_effective_user squid #è¿™é‡Œä»¥ç”¨æˆ·squidçš„èº«ä»½SquidæœåŠ¡å™¨cache_effective_group squidicp_port 0 #æŒ‡å®šSquidä»é‚»å±…æœåŠ¡å™¨ç¼“å†²å†…å‘é€å’Œæ¥æ”¶ICPè¯·æ±‚çš„ç«¯å£å·ã€‚ #è¿™é‡Œè®¾ç½®ä¸º0æ˜¯å› ä¸ºè¿™é‡Œé…ç½®Squidä¸ºå†…éƒ¨WebæœåŠ¡å™¨çš„åŠ é€Ÿå™¨ï¼Œ #æ‰€ä»¥ä¸éœ€è¦ä½¿ç”¨é‚»å±…æœåŠ¡å™¨çš„ç¼“å†²ã€‚0æ˜¯ç¦ç”¨# cache_peer è®¾ç½®å…è®¸æ›´æ–°ç¼“å­˜çš„ä¸»æœºï¼Œå› æ˜¯æœ¬æœºæ‰€ä»¥127.0.0.1cache_peer 127.0.0.1 parent 80 0 no-query default multicast-responder no-netdb-exchangecache_peer_domain 127.0.0.1 hostname_aliases 127.0.0.1error_directory /usr/share/squid/errors/Simplify_Chinese #å®šä¹‰é”™è¯¯è·¯å¾„always_direct allow all # cacheä¸¢å¤±æˆ–ä¸å­˜åœ¨æ˜¯å…è®¸æ‰€æœ‰è¯·æ±‚ç›´æ¥è½¬å‘åˆ°åŸå§‹æœåŠ¡å™¨ignore_unknown_nameservers on #å¼€åDNSæŸ¥è¯¢ï¼Œå½“åŸŸååœ°å€ä¸ç›¸åŒæ—¶å€™ï¼Œç¦æ­¢è®¿é—®coredump_dir /var/log/squid #å®šä¹‰dumpçš„ç›®å½•max_filedesc 2048 #æœ€å¤§æ‰“å¼€çš„æ–‡ä»¶æè¿°half_closed_clients off #ä½¿Squidåœ¨å½“readä¸å†è¿”å›æ•°æ®æ—¶ç«‹å³å…³é—­å®¢æˆ·ç«¯çš„è¿æ¥ã€‚ #æœ‰æ—¶readä¸å†è¿”å›æ•°æ®æ˜¯ç”±äºæŸäº›å®¢æˆ·å…³é—­TCPçš„å‘é€æ•°æ® #è€Œä»ç„¶ä¿æŒæ¥æ”¶æ•°æ®ã€‚è€ŒSquidåˆ†è¾¨ä¸å‡ºTCPåŠå…³é—­å’Œå®Œå…¨å…³é—­ã€‚buffered_logs on #è‹¥æ‰“å¼€é€‰é¡¹â€œbuffered_logsâ€å¯ä»¥ç¨ç¨æé«˜åŠ é€ŸæŸäº›å¯¹æ—¥å¿—æ–‡ä»¶çš„å†™å…¥ï¼Œè¯¥é€‰é¡¹ä¸»è¦æ˜¯å®ç°ä¼˜åŒ–ç‰¹æ€§ã€‚#é˜²æ­¢å¤©æ¶¯ç›—é“¾ï¼Œè½¬å«ç»™ç™¾åº¦acl tianya referer_regex -i tianyahttp_access deny tianyadeny_info tianya#é˜»æ­¢baiduèœ˜è››acl baidu req_header User-Agent Baiduspiderhttp_access deny baidu#é™åˆ¶åŒä¸€IPå®¢æˆ·ç«¯çš„æœ€å¤§è¿æ¥æ•°acl OverConnLimit maxconn 128http_access deny OverConnLimit#é˜²æ­¢è¢«äººåˆ©ç”¨ä¸ºHTTPä»£ç†ï¼Œè®¾ç½®å…è®¸è®¿é—®çš„IPåœ°å€acl myip dst 222.18.63.37http_access deny !myip#å…è®¸æœ¬åœ°ç®¡ç†acl Manager proto cache_objectacl Localhost src 127.0.0.1 222.18.63.37http_access allow Manager Localhostcachemgr_passwd 53034338 allhttp_access deny Manager#ä»…ä»…å…è®¸80ç«¯å£çš„ä»£ç†acl all src 0.0.0.0/0.0.0.0acl Safe_ports port 80 # httphttp_access deny !Safe_portshttp_access allow all#Squidä¿¡æ¯è®¾ç½®visible_hostname happy.swjtu.edu.cncache_mgr ooopic2008@qq.com#åŸºæœ¬è®¾ç½®cache_effective_user squidcache_effective_group squidtcp_recv_bufsize 65535 bytes#2.6çš„åå‘ä»£ç†åŠ é€Ÿé…ç½®cache_peer 127.0.0.1 parent 80 0 no-query originserver#é”™è¯¯æ–‡æ¡£error_directory /usr/local/squid/share/errors/Simplify_Chinese#å•å°ä½¿ç”¨ï¼Œä¸ä½¿ç”¨è¯¥åŠŸèƒ½icp_port 0hierarchy_stoplist cgi-bin ?acl QUERY urlpath_regex cgi-bin \\? .php .cgi .avi .wmv .rm .ram .mpg .mpeg .zip .execache deny QUERYacl apache rep_header Server ^Apachebroken_vary_encoding allow apacherefresh_pattern ^ftp: 1440 20% 10080refresh_pattern ^gopher: 1440 0% 1440refresh_pattern . 0 20% 4320cache_store_log nonepid_filename /usr/local/squid/var/logs/squid.pidemulate_httpd_log on Squidå¸¸ç”¨å‘½ä»¤ åˆå§‹åŒ–åœ¨squid.confé‡Œé…ç½®çš„cacheç›®å½•squid -zå¦‚æœæœ‰é”™è¯¯æç¤ºï¼Œè¯·æ£€æŸ¥cacheç›®å½•çš„æƒé™ï¼Œå¯ä»¥æ›´æ”¹ç›®å½•æƒé™chown -R squid:squid /cacheç›®å½• å¯¹squid.confæ’é”™ï¼Œå³éªŒè¯squid.confçš„è¯­æ³•å’Œé…ç½®squid -k parseå¦‚æœåœ¨squid.confä¸­æœ‰è¯­æ³•æˆ–é…ç½®é”™è¯¯ï¼Œè¿™é‡Œä¼šè¿”å›æç¤ºï¼Œè‹¥æ— è¿”å›ï¼Œå°è¯•å¯åŠ¨squid å‰å°å¯åŠ¨squidï¼Œå¹¶è¾“å‡ºå¯åŠ¨è¿‡ç¨‹/usr/local/squid/sbin/squid -N -d1å¦‚æœæœ‰ready to server requesç›¸å…³ä¿¡æ¯ï¼Œè¯´æ˜squidå¯åŠ¨æˆåŠŸç„¶åctrl+c ,åœæ­¢squid,å¹¶ä»¥åå°è¿è¡Œçš„æ–¹å¼å¯åŠ¨å®ƒ å¯åŠ¨squidåœ¨åå°è¿è¡Œsquid -så¯ä»¥ä½¿ç”¨ps -ax | grep squid æ¥æŸ¥çœ‹squidè¿›ç¨‹æ˜¯å¦å­˜åœ¨ åœæ­¢squidsquid -k shutdown é‡æ–°å¼•å¯¼ä¿®æ”¹è¿‡çš„squid.confsquid -k reconfigure -f /XXX/squid.confå½“squidè¿›è¡Œé…ç½®æ›´æ”¹åï¼Œå¯ä»¥ä½¿ç”¨è¯¥å‘½ä»¤è¿›è¡Œsquidé…ç½®é‡è½½ æŠŠsquidæ·»åŠ åˆ°ç³»ç»Ÿå¯åŠ¨é¡¹vim /etc/rc.local/usr/local/squid/sbin/squid -s ä¿®æ”¹cacheç¼“å­˜ç›®å½•çš„æƒé™chown -R squid.squid /cacheç›®å½•cacheç¼“å­˜ç›®å½•æ ¹æ®è‡ªå·±çš„é…ç½®æ›´æ”¹ï¼Œsquidç”¨æˆ·å’Œç»„æ˜¯squidï¼Œsquid ä¿®æ”¹squidæ—¥å¿—ç›®å½•çš„æƒé™chown -R squid.squid å®šä¹‰çš„æ—¥å¿—æ–‡ä»¶æ‰€åœ¨ç›®å½•è¿™ä¸€æ­¥å¹¶ä¸æ˜¯é€‚åˆæ¯ä¸€ä¸ªä½¿ç”¨squidçš„ç”¨æˆ·ï¼Œæ„ä¸ºè®©squidæœ‰æƒé™åœ¨è¯¥ç›®å½•é‡Œè¿›è¡Œå†™æ“ä½œ æŸ¥çœ‹ä½ çš„æ—¥å¿—æ–‡æ¡£more /usr/local/squid/var/logs/access.log | grep TCP_MEM_HITè¯¥æŒ‡ä»¤å¯ä»¥çœ‹åˆ°åœ¨squidè¿è¡Œè¿‡ç¨‹ä¸­ï¼Œæœ‰é‚£äº›æ–‡ä»¶è¢«squidç¼“å­˜åˆ°å†…å­˜ä¸­ï¼Œå¹¶è¿”å›ç»™è®¿é—®ç”¨æˆ·ã€‚more /usr/local/squid/var/logs/access.log | grep TCP_HITè¯¥æŒ‡ä»¤å¯ä»¥çœ‹åˆ°åœ¨squidè¿è¡Œè¿‡ç¨‹ä¸­ï¼Œæœ‰é‚£äº›æ–‡ä»¶è¢«squidç¼“å­˜åˆ°cacheç›®å½•ä¸­ï¼Œå¹¶è¿”å›ç»™è®¿é—®ç”¨æˆ·ã€‚more /usr/local/squid/var/logs/access.log | grep TCP_MISSè¯¥æŒ‡ä»¤å¯ä»¥çœ‹åˆ°åœ¨squidè¿è¡Œè¿‡ç¨‹ä¸­ï¼Œæœ‰é‚£äº›æ–‡ä»¶æ²¡æœ‰è¢«squidç¼“å­˜ï¼Œè€Œæ˜¯ä»åŸå§‹æœåŠ¡å™¨è·å–å¹¶è¿”å›ç»™è®¿é—®ç”¨æˆ·ã€‚ Squidå‘½ä¸­ç‡åˆ†æ12/usr/local/squid/bin/squidclient -p 80 mgr:info/usr/local/squid/bin/squidclient -p 80 mgr:5min å¯ä»¥çœ‹åˆ°è¯¦ç»†çš„æ€§èƒ½æƒ…å†µ,å…¶ä¸­PORTæ˜¯ä½ çš„proxyçš„ç«¯å£ï¼Œ5minå¯ä»¥æ˜¯60minå–å¾—squidè¿è¡ŒçŠ¶æ€ä¿¡æ¯ï¼š 1squidclient -p 80 mgr:info å–å¾—squidå†…å­˜ä½¿ç”¨æƒ…å†µï¼š 1squidclient -p 80 mgr:mem å–å¾—squidå·²ç»ç¼“å­˜çš„åˆ—è¡¨ï¼š 1squidclient -p 80 mgr:bjects. use it carefully,it may crash å–å¾—squidçš„ç£ç›˜ä½¿ç”¨æƒ…å†µï¼š 1squidclient -p 80 mgr:diskd å¼ºåˆ¶æ›´æ–°æŸä¸ªurlï¼š 1squidclient -p 80 -m PURGE http://www.xxx.com/xxx.php æ›´å¤šçš„è¯·æŸ¥çœ‹ï¼šsquidclient-h æˆ–è€… squidclient -p 80 mgr:æŸ¥å‘½ä¸­ç‡ï¼š 1squidclient -h IP(å…·ä½“ä¾¦å¬IP) -p 80(å…·ä½“ä¾¦å¬ç«¯å£) mgr:info å®šæœŸæ¸…ç†swap.stateå†…æ— æ•ˆæ•°æ®123/path/to/squid/sbin/squid -k rotate -f /path/to/squid/conf_filevi /etc/crontab0 0 * * * root /usr/local/sbin/squid -k rotate -f /usr/local/etc/squid/squid1.conf å½“squidåº”ç”¨è¿è¡Œäº†ä¸€æ®µæ—¶é—´ä¹‹åï¼Œcache_dirå¯¹åº”çš„swap.stateæ–‡ä»¶å°±ä¼šå˜å¾—è¶Šæ¥è¶Šå¤§ï¼Œé‡Œé¢çš„æ— æ•ˆæ¥å£æ•°æ®è¶Šæ¥è¶Šå¤šï¼Œè¿™å¯èƒ½å½±å“squidçš„å“åº”æ—¶é—´ï¼Œå› æ­¤éœ€è¦ä½¿ç”¨squidæ¸…ç†swap.stateé‡Œé¢çš„æ— æ•ˆæ•°æ®ï¼Œå‡å°‘swap.stateçš„å¤§å°ã€‚","raw":"---\ntitle: squidä»‹ç»åŠå…¶ç®€å•é…ç½®\ncopyright: true\ntags:\n  - squid\n  - proxy\ncategories:\n  - Linux\nabbrlink: 55e3d16d\ndate: 2019-05-15 15:15:30\ntype:\nkeyword:\ntop:\ncomments:\npassword:\n---\n\n## squidçš„æ¦‚å¿µ\n\nsquidæ˜¯ä¸€ç§ç”¨æ¥ç¼“å­˜Internetæ•°æ®çš„è½¯ä»¶ã€‚æ¥å—æ¥è‡ªäººä»¬éœ€è¦ä¸‹è½½çš„ç›®æ ‡ï¼ˆobjectï¼‰çš„è¯·æ±‚å¹¶é€‚å½“çš„å¤„ç†è¿™äº›è¯·æ±‚ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œå¦‚æœä¸€ä¸ªäººæƒ³ä¸‹è½½ä¸€webç•Œé¢ï¼Œä»–è¯·æ±‚squidä¸ºä»–å–å¾—è¿™ä¸ªé¡µé¢ã€‚squidéšä¹‹è¿æ¥åˆ°è¿œç¨‹æœåŠ¡å™¨å¹¶å‘è¿™ä¸ªé¡µé¢å‘å‡ºè¯·æ±‚ã€‚ç„¶åï¼Œsquidæ˜¾å¼åœ°èšé›†æ•°æ®åˆ°å®¢æˆ·ç«¯æœºå™¨ï¼Œè€Œä¸”åŒæ—¶å¤åˆ¶ä¸€ä»½ã€‚å½“ä¸‹ä¸€æ¬¡æœ‰äººéœ€è¦åŒä¸€é¡µé¢æ—¶ï¼Œ squidå¯ä»¥ç®€å•çš„ä»ç£ç›˜ä¸­è¯»åˆ°å®ƒï¼Œé‚£æ ·æ•°æ®ä¼šç«‹å³ä¼ è¾“åˆ°å®¢æˆ·æœºä¸Šã€‚\n\n<!-- more -->\n\n## ä¸‹è½½åœ°å€\n\nsquid-cache å®˜ç½‘ http://www.squid-cache.org\n\nsquidä»‹ç»åŠå…¶ç®€å•é…ç½® https://www.cnblogs.com/cherishry/p/5706736.html\n\nCentOS 7å®‰è£…squidä»£ç†æœåŠ¡å™¨ https://blog.csdn.net/ithomer/article/details/78136993\n\n## squidä»£ç†çš„ä½œç”¨\n\n*   é€šè¿‡ç¼“å­˜çš„æ–¹å¼ä¸ºç”¨æˆ·æä¾›Webè®¿é—®åŠ é€Ÿ\n*   å¯¹ç”¨æˆ·çš„Webè®¿é—®è¿›è¡Œè¿‡æ»¤æ§åˆ¶\n\n## å·¥ä½œæµç¨‹\n\nå½“ä»£ç†æœåŠ¡å™¨ä¸­æœ‰å®¢æˆ·ç«¯éœ€è¦çš„æ•°æ®æ—¶ï¼š\n\na.å®¢æˆ·ç«¯å‘ä»£ç†æœåŠ¡å™¨å‘é€æ•°æ®è¯·æ±‚ï¼›\n\nb.ä»£ç†æœåŠ¡å™¨æ£€æŸ¥è‡ªå·±çš„æ•°æ®ç¼“å­˜ï¼›\n\nc.ä»£ç†æœåŠ¡å™¨åœ¨ç¼“å­˜ä¸­æ‰¾åˆ°äº†ç”¨æˆ·æƒ³è¦çš„æ•°æ®ï¼Œå–å‡ºæ•°æ®ï¼›\n\nd.ä»£ç†æœåŠ¡å™¨å°†ä»ç¼“å­˜ä¸­å–å¾—çš„æ•°æ®è¿”å›ç»™å®¢æˆ·ç«¯ã€‚\n\nå½“ä»£ç†æœåŠ¡å™¨ä¸­æ²¡æœ‰å®¢æˆ·ç«¯éœ€è¦çš„æ•°æ®æ—¶äº†ï¼š\n\n1.å®¢æˆ·ç«¯å‘ä»£ç†æœåŠ¡å™¨å‘é€æ•°æ®è¯·æ±‚ï¼›\n\n2.ä»£ç†æœåŠ¡å™¨æ£€æŸ¥è‡ªå·±çš„æ•°æ®ç¼“å­˜ï¼›\n\n3.ä»£ç†æœåŠ¡å™¨åœ¨ç¼“å­˜ä¸­æ²¡æœ‰æ‰¾åˆ°ç”¨æˆ·æƒ³è¦çš„æ•°æ®ï¼›\n\n4.ä»£ç†æœåŠ¡å™¨å‘Internet ä¸Šçš„è¿œç«¯æœåŠ¡å™¨å‘é€æ•°æ®è¯·æ±‚ï¼›\n\n5.è¿œç«¯æœåŠ¡å™¨å“åº”ï¼Œè¿”å›ç›¸åº”çš„æ•°æ®ï¼›\n\n6.ä»£ç†æœåŠ¡å™¨å–å¾—è¿œç«¯æœåŠ¡å™¨çš„æ•°æ®ï¼Œè¿”å›ç»™å®¢æˆ·ç«¯ï¼Œå¹¶ä¿ç•™ä¸€ä»½åˆ°è‡ªå·±çš„æ•°æ®ç¼“å­˜ä¸­ã€‚\n\n![](https://images2015.cnblogs.com/blog/872781/201607/872781-20160726112850919-758636566.jpg)\n\nSquidä»£ç†æœåŠ¡å™¨å·¥ä½œåœ¨TCP/IPåº”ç”¨å±‚\n\n![](https://images2015.cnblogs.com/blog/872781/201607/872781-20160726112935653-887103660.jpg)\n\n## Squidå„ç§ä»£ç†çš„å®šä¹‰\n\n### æ­£å‘ä»£ç†\n\n#### æ ‡å‡†çš„ä»£ç†ç¼“å†²æœåŠ¡å™¨\n\nä¸€ä¸ªæ ‡å‡†çš„ä»£ç†ç¼“å†²æœåŠ¡è¢«ç”¨äºç¼“å­˜é™æ€çš„ç½‘é¡µåˆ°æœ¬åœ°ç½‘ç»œä¸Šçš„ä¸€å°ä¸»æœºä¸Šï¼ˆå³ä»£ç†æœåŠ¡å™¨ï¼‰ã€‚å½“è¢«ç¼“å­˜çš„é¡µé¢è¢«ç¬¬äºŒæ¬¡è®¿é—®çš„æ—¶å€™ï¼Œæµè§ˆå™¨å°†ç›´æ¥ä»æœ¬åœ°ä»£ç†æœåŠ¡å™¨é‚£é‡Œè·å–è¯·æ±‚æ•°æ®è€Œä¸å†å‘åŸwebç«™ç‚¹è¯·æ±‚æ•°æ®ã€‚è¿™æ ·å°±èŠ‚çœäº†å®è´µçš„ç½‘ç»œå¸¦å®½ï¼Œè€Œä¸”æé«˜äº†è®¿é—®é€Ÿåº¦ã€‚ä½†æ˜¯ï¼Œè¦æƒ³å®ç°è¿™ç§æ–¹å¼ï¼Œå¿…é¡»åœ¨æ¯ä¸€ä¸ªå†…éƒ¨ä¸»æœºçš„æµè§ˆå™¨ä¸Šæ˜ç¡®æŒ‡åä»£ç†æœåŠ¡å™¨çš„IPåœ°å€å’Œç«¯å£å·ã€‚å®¢æˆ·ç«¯ä¸Šç½‘æ—¶ï¼Œæ¯æ¬¡éƒ½æŠŠè¯·æ±‚å‘é€ç»™ä»£ç†æœåŠ¡å™¨å¤„ç†,ä»£ç†æœåŠ¡å™¨æ ¹æ®è¯·æ±‚ç¡®å®šæ˜¯å¦è¿æ¥åˆ°è¿œç¨‹webæœåŠ¡å™¨è·å–æ•°æ®ã€‚å¦‚æœåœ¨æœ¬åœ°ç¼“å†²åŒºæœ‰ç›®æ ‡æ–‡ä»¶ï¼Œåˆ™ç›´æ¥å°†æ–‡ä»¶ä¼ ç»™ç”¨æˆ·å³å¯ã€‚å¦‚æœæ²¡æœ‰çš„è¯åˆ™å…ˆå–å›æ–‡ä»¶ï¼Œå…ˆåœ¨æœ¬åœ°ä¿å­˜ä¸€ä»½ç¼“å†²ï¼Œç„¶åå°†æ–‡ä»¶å‘é€ç»™å®¢æˆ·ç«¯æµè§ˆå™¨ã€‚\n\n#### é€æ˜ä»£ç†ç¼“å†²æœåŠ¡å™¨\n\né€æ˜ä»£ç†ç¼“å†²æœåŠ¡å™¨å’Œæ ‡å‡†ä»£ç†æœåŠ¡å™¨çš„åŠŸèƒ½å®Œå…¨ç›¸åŒã€‚ä½†æ˜¯ï¼Œä»£ç†æ“ä½œå¯¹å®¢æˆ·ç«¯çš„æµè§ˆå™¨æ˜¯é€æ˜çš„ï¼ˆå³ä¸éœ€æŒ‡æ˜ä»£ç†æœåŠ¡å™¨çš„IPå’Œç«¯å£ï¼‰ã€‚é€æ˜ä»£ç†æœåŠ¡å™¨é˜»æ–­ç½‘ç»œé€šä¿¡ï¼Œå¹¶ä¸”è¿‡æ»¤å‡ºè®¿é—®å¤–éƒ¨çš„HTTPï¼ˆ80ç«¯å£ï¼‰æµé‡ã€‚å¦‚æœå®¢æˆ·ç«¯çš„è¯·æ±‚åœ¨æœ¬åœ°æœ‰ç¼“å†²åˆ™å°†ç¼“å†²çš„æ•°æ®ç›´æ¥å‘ç»™ç”¨æˆ·ï¼Œå¦‚æœåœ¨æœ¬åœ°æ²¡æœ‰ç¼“å†²åˆ™å‘è¿œç¨‹webæœåŠ¡å™¨å‘å‡ºè¯·æ±‚ï¼Œå…¶ä½™æ“ä½œå’Œæ ‡å‡†çš„ä»£ç†æœåŠ¡å™¨å®Œå…¨ç›¸åŒã€‚å¯¹äºlinuxæ“ä½œç³»ç»Ÿæ¥è¯´ï¼Œé€æ˜ä»£ç†ä½¿ç”¨Iptablesæˆ–è€…Ipchainså®ç°ã€‚å› æ­¤ä¸éœ€è¦å¯¹æµè§ˆå™¨ä½œä»»ä½•è®¾ç½®ï¼Œæ‰€ä»¥ï¼Œé€æ˜ä»£ç†å¯¹äºISPï¼ˆInternetæœåŠ¡å™¨æä¾›å•†ï¼‰ç‰¹åˆ«æœ‰ç”¨ã€‚\n\n### åå‘ä»£ç†\n\n#### åå‘ä»£ç†ç¼“å†²å™¨\n\nåå‘ä»£ç†æ˜¯å’Œå‰ä¸¤ç§ä»£ç†å®Œå…¨ä¸åŒçš„ä¸€ç§ä»£ç†æœåŠ¡ã€‚ä½¿ç”¨å®ƒå¯ä»¥é™ä½åŸå§‹WEBæœåŠ¡å™¨çš„è´Ÿè½½ã€‚åå‘ä»£ç†æœåŠ¡å™¨æ‰¿æ‹…äº†å¯¹åŸå§‹WEBæœåŠ¡å™¨çš„é™æ€é¡µé¢çš„è¯·æ±‚ï¼Œé˜²æ­¢åŸå§‹æœåŠ¡å™¨è¿‡è½½ã€‚å®ƒä½äºWEBæœåŠ¡å™¨å’ŒInternetä¹‹é—´ï¼Œå¤„ç†æ‰€æœ‰å¯¹WEBæœåŠ¡å™¨çš„è¯·æ±‚ï¼Œç»„ç»‡äº†WEBæœåŠ¡å™¨å’ŒInternetçš„ç›´æ¥é€šä¿¡ã€‚å¦‚æœäº’è”ç½‘ç”¨æˆ·è¯·æ±‚çš„é¡µé¢åœ¨ä»£ç†æœåŠ¡å™¨ä¸Šæœ‰ç¼“å†²çš„è¯ï¼Œä»£ç†æœåŠ¡å™¨ç›´æ¥å°†ç¼“å†²å†…å®¹å‘é€ç»™ç”¨æˆ·ã€‚å¦‚æœæ²¡æœ‰ç¼“å†²åˆ™å…ˆå‘WEBæœåŠ¡å™¨å‘å‡ºè¯·æ±‚ï¼Œå–å›æ•°æ®ï¼Œæœ¬åœ°ç¼“å­˜åå†å‘ç»™ç”¨æˆ·ã€‚è¿™ç§æ–¹å¼é€šè¿‡é™ä½äº†WEBæœåŠ¡å™¨çš„è¯·æ±‚æ•°ä»è€Œé™ä½äº†WEBæœåŠ¡å™¨çš„è´Ÿè½½ã€‚\n\n### æ­£å‘ä»£ç†ä¸åå‘ä»£ç†çš„åŒºåˆ«\n\n### æ¦‚å¿µ\n\næ­£å‘ä»£ç†ï¼šå¯¹äºåŸå§‹æœåŠ¡å™¨è€Œè¨€ï¼Œå°±æ˜¯å®¢æˆ·ç«¯çš„ä»£è¨€äºº\nåå‘ä»£ç†ï¼šå¯¹äºå®¢æˆ·ç«¯è€Œè¨€ï¼Œå°±åƒæ˜¯åŸå§‹æœåŠ¡å™¨\n\n### ç”¨é€”\n\næ­£å‘ä»£ç†çš„å…¸å‹ç”¨é€”æ˜¯ä¸ºåœ¨é˜²ç«å¢™å†…çš„å±€åŸŸç½‘å®¢æˆ·ç«¯æä¾›è®¿é—®Internetçš„é€”å¾„ã€‚æ­£å‘ä»£ç†è¿˜å¯ä»¥ä½¿ç”¨ç¼“å†²ç‰¹æ€§å‡å°‘ç½‘ç»œä½¿ç”¨ç‡ã€‚\nåå‘ä»£ç†è¿˜å¯ä»¥ä¸ºåç«¯çš„å¤šå°æœåŠ¡å™¨æä¾›è´Ÿè½½å¹³è¡¡ï¼Œæˆ–ä¸ºåç«¯è¾ƒæ…¢çš„æœåŠ¡å™¨æä¾›ç¼“å†²æœåŠ¡ã€‚å¦å¤–ï¼Œåå‘ä»£ç†è¿˜å¯ä»¥å¯ç”¨é«˜çº§URLç­–ç•¥å’Œç®¡ç†æŠ€æœ¯ï¼Œä»è€Œä½¿å¤„äºä¸åŒwebæœåŠ¡å™¨ç³»ç»Ÿçš„webé¡µé¢åŒæ—¶å­˜åœ¨äºåŒä¸€ä¸ªURLç©ºé—´ä¸‹ã€‚\n\n### å®‰å…¨æ€§\n\næ­£å‘ä»£ç†å…è®¸å®¢æˆ·ç«¯é€šè¿‡å®ƒè®¿é—®ä»»æ„ç½‘ç«™å¹¶ä¸”éšè—å®¢æˆ·ç«¯è‡ªèº«ï¼Œå› æ­¤ä½ å¿…é¡»é‡‡å–å®‰å…¨æªæ–½ä»¥ç¡®ä¿ä»…ä¸ºç»è¿‡æˆæƒçš„å®¢æˆ·ç«¯æä¾›æœåŠ¡ã€‚\nåå‘ä»£ç†å¯¹å¤–éƒ½æ˜¯é€æ˜çš„ï¼Œè®¿é—®è€…å¹¶ä¸çŸ¥é“è‡ªå·±è®¿é—®çš„æ˜¯ä¸€ä¸ªä»£ç†ã€‚\n\n## Squidä¸»è¦ç»„æˆéƒ¨åˆ†\n\næœåŠ¡åï¼š`squid`\nä¸»ç¨‹åºï¼š`/usr/sbin/squid`\né…ç½®ç›®å½•ï¼š`/etc/squid`\nä¸»é…ç½®æ–‡ä»¶ï¼š`/etc/squid/squid.conf`\nç›‘å¬tcpç«¯å£å·ï¼š`3128`\né»˜è®¤è®¿é—®æ—¥å¿—æ–‡ä»¶ï¼š`/var/log/squid/access.log`\n\n## squidå¸¸ç”¨é…ç½®é€‰é¡¹\n\n`/etc/squid/squid.conf`\n\n```\n\nhttp_port 3128  (è¿˜å¯ä»¥åªç›‘å¬ä¸€ä¸ªIP http_port 192.168.0.1:3128)\ncache_mem 64MB  #ç¼“å­˜å å†…å­˜å¤§å°\nmaximum_object_size 4096KB  #æœ€å¤§ç¼“å­˜å—\nreply_body_max_size  1024000 allow all      #é™å®šä¸‹è½½æ–‡ä»¶å¤§å°\naccess_log /var/log/squid/access.log    #è®¿é—®æ—¥å¿—å­˜æ”¾çš„åœ°æ–¹\nvisible_hostname    proxy.test.xom  #å¯è§çš„ä¸»æœºå\ncache_dir ufs /var/spool/squid  100 16 256 \n#ufs:ç¼“å­˜æ•°æ®çš„å­˜å‚¨æ ¼å¼\n#/var/spool/squid    ç¼“å­˜ç›®å½•\n#100ï¼šç¼“å­˜ç›®å½•å ç£ç›˜ç©ºé—´å¤§å°ï¼ˆMï¼‰\n#16ï¼šç¼“å­˜ç©ºé—´ä¸€çº§å­ç›®å½•ä¸ªæ•°\n#256ï¼šç¼“å­˜ç©ºé—´äºŒçº§å­ç›®å½•ä¸ªæ•°\ncache_mgr webmaster@test.com    #å®šä¹‰ç®¡ç†å‘˜é‚®ç®±\nhttp_access deny all    #è®¿é—®æ§åˆ¶\n\n```\n## squidä¸­çš„è®¿é—®æ§åˆ¶\n\n  ä½¿ç”¨è®¿é—®æ§åˆ¶ç‰¹æ€§ï¼Œå¯ä»¥æ§åˆ¶åœ¨è®¿é—®æ—¶æ ¹æ®ç‰¹å®šçš„æ—¶é—´é—´éš”è¿›è¡Œç¼“å­˜ã€è®¿é—®ç‰¹å®šç«™ç‚¹æˆ–ä¸€ç»„ç«™ç‚¹ç­‰ç­‰ã€‚squidè®¿é—®æ§åˆ¶æœ‰ä¸¤ä¸ªè¦ç´ ï¼šACLå…ƒç´ å’Œè®¿é—®åˆ—è¡¨ã€‚è®¿é—®åˆ—è¡¨å¯ä»¥å…è®¸æˆ–æ‹’ç»æŸäº›ç”¨æˆ·å¯¹æ­¤æœåŠ¡çš„è®¿é—®ã€‚\n\n### ACLå…ƒç´ ç±»å‹\n\n*   srcï¼šæºåœ°å€ï¼ˆå³å®¢æˆ·æœºIPåœ°å€ï¼‰\n*   dstï¼šç›®æ ‡åœ°å€ï¼ˆå³æœåŠ¡å™¨IPåœ°å€ï¼‰\n*   srcdomainï¼šæºåç§°ï¼ˆå³å®¢æˆ·æœºåç§°ï¼‰\n*   dstdomainï¼šç›®æ ‡åç§°ï¼ˆå³æœåŠ¡å™¨åç§°ï¼‰\n*   timeï¼šä¸€å¤©ä¸­çš„æ—¶åˆ»å’Œä¸€å‘¨å†…çš„ä¸€å¤©\n*   url_regexï¼šURLè§„åˆ™è¡¨è¾¾å¼åŒ¹é…\n*   urlpath_regexï¼šURL-pathè§„åˆ™è¡¨è¾¾å¼åŒ¹é…ï¼Œç•¥å»åè®®å’Œä¸»æœºå\n*   proxy_authï¼šé€šè¿‡å¤–éƒ¨ç¨‹åºè¿›è¡Œç”¨æˆ·éªŒè¯\n*   maxconnï¼šå•ä¸€IPçš„æœ€å¤§è¿æ¥æ•°\n\n### ACLæ ¼å¼\n\n\tä¸ºäº†ä½¿ç”¨æ§åˆ¶åŠŸèƒ½ï¼Œå¿…é¡»å…ˆè®¾ç½®ACLè§„åˆ™å¹¶åº”ç”¨ã€‚ACLå£°æ˜çš„æ ¼å¼å¦‚ä¸‹ï¼š\n\næ³¨ï¼š\n\n*   acl_element_name å¯ä»¥æ˜¯ä»»ä¸€ä¸ªåœ¨ACLä¸­å®šä¹‰çš„åç§°\n*   ä»»ä½•ä¸¤ä¸ªACLå…ƒç´ ä¸èƒ½ç”¨ç›¸åŒçš„åå­—\n*   æ¯ä¸ªACLç”±åˆ—è¡¨å€¼ç»„æˆã€‚å½“è¿›è¡ŒåŒ¹é…æ£€æµ‹çš„æ—¶å€™ï¼Œå¤šä¸ªå€¼ç”±é€»è¾‘æˆ–è¿ç®—è¿æ¥ï¼›æ¢è¨€ä¹‹ï¼Œå³ä»»ä¸€ACLå…ƒç´ çš„å€¼è¢«åŒ¹é…ï¼Œåˆ™è¿™ä¸ªACLå…ƒç´ å³è¢«åŒ¹é…ã€‚\n*   å¹¶ä¸æ˜¯æ‰€æœ‰ACLå…ƒç´ éƒ½èƒ½ä½¿ç”¨è®¿é—®åˆ—è¡¨ä¸­çš„å…¨éƒ¨ç±»å‹\n*   ä¸åŒçš„ACLå…ƒç´ å†™åœ¨ä¸åŒè¡Œä¸­ï¼Œsquidå°†æŠŠä»–ä»¬ç»„åˆåœ¨ä¸€ä¸ªåˆ—è¡¨ä¸­\n\n### è®¿é—®æ¡ç›®\n\næˆ‘ä»¬å¯ä»¥ä½¿ç”¨è®¸å¤šä¸åŒçš„è®¿é—®æ¡ç›®ã€‚ä¸‹é¢æ˜¯æˆ‘ä»¬å¸¸ç”¨çš„å‡ ä¸ªï¼š\n\n*   http_access:å…è®¸HTTPè®¿é—®\n*   no_cache:å®šä¹‰å¯¹ç¼“å­˜è¯·æ±‚çš„å“åº”ã€‚\n    è®¿é—®åˆ—è¡¨çš„è§„åˆ™ç”±ä¸€äº›ç±»ä¼¼'allow'æˆ–â€˜denyâ€™çš„å…³é”®å­—æ„æˆï¼Œç”¨ä»¥å…è®¸æˆ–æ‹’ç»å‘ç‰¹å®šæˆ–ä¸€ç»„ACLå…ƒç´ æä¾›æœåŠ¡ã€‚\n\n1.  ä¸€ä¸ªè®¿é—®åˆ—è¡¨å¯ä»¥ç”±å¤šæ¡è§„åˆ™ç»„æˆ\n2.  å¦‚æœæ²¡æœ‰ä»»ä½•è§„åˆ™ä¸è®¿é—®è¯·æ±‚åŒ¹é…ï¼Œé»˜è®¤åŠ¨ä½œå°†ä¸åˆ—è¡¨ä¸­æœ€åä¸€æ¡è§„åˆ™å¯¹åº”ã€‚\n3.  ä¸€ä¸ªè®¿é—®æ¡ç›®ä¸­æ‰€æœ‰å…ƒç´ å°†ç”¨é€»è¾‘ä¸è¿ç®—è¿æ¥\n    http_access Action å£°æ˜1 AND å£°æ˜2 AND å£°æ˜ OR.\n    http_access Action å£°æ˜3\n    å¤šä¸ªhttp_accessså£°æ˜é—´ç”¨æˆ–è¿ç®—è¿æ¥ï¼Œä½†æ¯ä¸ªè®¿é—®æ¡ç›®çš„å…ƒç´ é—´ç”¨ä¸è¿ç®—è¿æ¥ã€‚\n4.  åˆ—è¡¨ä¸­çš„è§„åˆ™æ€»æ˜¯éµå¾ªç”±ä¸Šè€Œä¸‹çš„é¡ºåº\n5.  è¿™äº›è§„åˆ™æŒ‰ç…§ä»–ä»¬çš„æ’åˆ—é¡ºåºè¿›è¡ŒåŒ¹é…æ£€æµ‹ï¼Œä¸€æ—¦æ£€æµ‹åˆ°åŒ¹é…çš„è§„åˆ™ï¼ŒåŒ¹é…å°±ç«‹å³ç»“æŸã€‚\n\n## Squid.confé…ç½®æ–‡ä»¶è¯¦è§£\n\n```\n#acl all src 0.0.0.0/0.0.0.0 and http_access allow allé€‰é¡¹å®šä¹‰äº†ä¸€ä¸ªè®¿é—®æ§åˆ¶åˆ—è¡¨ã€‚è¯¦ç»†æƒ…å†µå‚è§å’ŒSquidè½¯ä»¶\n#æºå¸¦çš„æ–‡æ¡£ã€‚è¿™é‡Œçš„è®¿é—®æ§åˆ¶åˆ—è¡¨å…è®¸æ‰€æœ‰å¯¹ä»£ç†æœåŠ¡çš„è®¿é—®ï¼Œå› ä¸ºè¿™é‡Œè¯¥ä»£ç†æ˜¯åŠ é€ŸwebæœåŠ¡å™¨ã€‚\nacl all src 0.0.0.0/0.0.0.0                 #å…è®¸æ‰€æœ‰IPè®¿é—®\nacl manager proto http                 #manager urlåè®®ä¸ºhttp\nacl localhost src 127.0.0.1/255.255.255.255  #å…åˆæœ¬æœºIP\nacl to_localhost dst 127.0.0.1                 #å…åˆç›®çš„åœ°å€ä¸ºæœ¬æœºIP\nacl Safe_ports port 80                # å…è®¸å®‰å…¨æ›´æ–°çš„ç«¯å£ä¸º80\nacl CONNECT method CONNECT        #è¯·æ±‚æ–¹æ³•ä»¥CONNECT\nhttp_access allow all                #å…è®¸æ‰€æœ‰äººä½¿ç”¨è¯¥ä»£ç†.å› ä¸ºè¿™é‡Œæ˜¯ä»£ç†åŠ é€ŸwebæœåŠ¡å™¨\nhttp_reply_access allow all                #å…è®¸æ‰€æœ‰å®¢æˆ·ç«¯ä½¿ç”¨è¯¥ä»£ç†\n\nacl OverConnLimit maxconn 16        #é™åˆ¶æ¯ä¸ªIPæœ€å¤§å…è®¸16ä¸ªè¿æ¥ï¼Œé˜²æ­¢æ”»å‡»\nhttp_access deny OverConnLimit\n\nicp_access deny all                        #ç¦æ­¢ä»é‚»å±…æœåŠ¡å™¨ç¼“å†²å†…å‘é€å’Œæ¥æ”¶ICPè¯·æ±‚.\nmiss_access allow all                #å…è®¸ç›´æ¥æ›´æ–°è¯·æ±‚\nident_lookup_access deny all                                #ç¦æ­¢lookupæ£€æŸ¥DNS\nhttp_port 8080 transparent                                #æŒ‡å®šSquidç›‘å¬æµè§ˆå™¨å®¢æˆ·è¯·æ±‚çš„ç«¯å£å·ã€‚\n\nhierarchy_stoplist cgi-bin ?                #ç”¨æ¥å¼ºåˆ¶æŸäº›ç‰¹å®šçš„å¯¹è±¡ä¸è¢«ç¼“å­˜ï¼Œä¸»è¦æ˜¯å¤„äºå®‰å…¨çš„ç›®çš„ã€‚\nacl QUERY urlpath_regex cgi-bin \\?\ncache deny QUERY\n\ncache_mem 1 GB        #è¿™æ˜¯ä¸€ä¸ªä¼˜åŒ–é€‰é¡¹ï¼Œå¢åŠ è¯¥å†…å­˜å€¼æœ‰åˆ©äºç¼“å­˜ã€‚åº”è¯¥æ³¨æ„çš„æ˜¯ï¼š\n                     #ä¸€èˆ¬æ¥è¯´å¦‚æœç³»ç»Ÿæœ‰å†…å­˜ï¼Œè®¾ç½®è¯¥å€¼ä¸º(n/)3Mã€‚ç°åœ¨æ˜¯3G æ‰€ä»¥è¿™é‡Œ1G\nfqdncache_size 1024        #FQDN é«˜é€Ÿç¼“å­˜å¤§å°\nmaximum_object_size_in_memory 2 MB        #å…è®¸æœ€å¤§çš„æ–‡ä»¶è½½å…¥å†…å­˜\n\nmemory_replacement_policy heap LFUDA  #åŠ¨æ€ä½¿ç”¨æœ€å°çš„ï¼Œç§»å‡ºå†…å­˜cache\ncache_replacement_policy heap LFUDA         #åŠ¨æ€ä½¿ç”¨æœ€å°çš„ï¼Œç§»å‡ºç¡¬ç›˜cache\n\ncache_dir ufs /home/cache 5000 32 512  #é«˜é€Ÿç¼“å­˜ç›®å½• ufs ç±»å‹ ä½¿ç”¨çš„ç¼“å†²å€¼æœ€å¤§å…åˆ1000MBç©ºé—´ï¼Œ\n#32ä¸ªä¸€çº§ç›®å½•ï¼Œ512ä¸ªäºŒçº§ç›®å½•\n\nmax_open_disk_fds 0                                 #å…è®¸æœ€å¤§æ‰“å¼€æ–‡ä»¶æ•°é‡,0 æ— é™åˆ¶\nminimum_object_size 1 KB                         #å…åˆæœ€å°æ–‡ä»¶è¯·æ±‚ä½“å¤§å°\nmaximum_object_size 20 MB                 #å…åˆæœ€å¤§æ–‡ä»¶è¯·æ±‚ä½“å¤§å°\n\ncache_swap_low 90                            #æœ€å°å…è®¸ä½¿ç”¨swap 90%\ncache_swap_high 95                            #æœ€å¤šå…è®¸ä½¿ç”¨swap 95%\n\nipcache_size 2048                                # IP åœ°å€é«˜é€Ÿç¼“å­˜å¤§å° 2M\nipcache_low 90                                #æœ€å°å…è®¸ipcacheä½¿ç”¨swap 90%\nipcache_high 95                                  #æœ€å¤§å…è®¸ipcacheä½¿ç”¨swap 90%\n\n\naccess_log /var/log/squid/access.log squid        #å®šä¹‰æ—¥å¿—å­˜æ”¾è®°å½•\ncache_log /var/log/squid/cache.log squid\ncache_store_log none                        #ç¦æ­¢storeæ—¥å¿—\n\nemulate_httpd_log on        #å°†ä½¿Squidä»¿ç…§WebæœåŠ¡å™¨çš„æ ¼å¼åˆ›å»ºè®¿é—®è®°å½•ã€‚å¦‚æœå¸Œæœ›ä½¿ç”¨\n                                #Webè®¿é—®è®°å½•åˆ†æç¨‹åºï¼Œå°±éœ€è¦è®¾ç½®è¿™ä¸ªå‚æ•°ã€‚\n\nrefresh_pattern . 0 20% 4320 override-expire override-lastmod reload-into-ims ignore-reload   #æ›´æ–°cacheè§„åˆ™\n\nacl buggy_server url_regex ^http://.... http://          #åªå…è®¸httpçš„è¯·æ±‚\nbroken_posts allow buggy_server\n\nacl apache rep_header Server ^Apache                 #å…è®¸apacheçš„ç¼–ç \nbroken_vary_encoding allow apache\n\nrequest_entities off                                        #ç¦æ­¢éhttpçš„æ ‡åˆ†å‡†è¯·æ±‚ï¼Œé˜²æ­¢æ”»å‡»\nheader_access header allow all                        #å…è®¸æ‰€æœ‰çš„httpæŠ¥å¤´\nrelaxed_header_parser on                                #ä¸ä¸¥æ ¼åˆ†æhttpæŠ¥å¤´.\nclient_lifetime 120 minute                                #æœ€å¤§å®¢æˆ·è¿æ¥æ—¶é—´ 120åˆ†é’Ÿ\n\ncache_mgr sky@test.com                        #æŒ‡å®šå½“ç¼“å†²å‡ºç°é—®é¢˜æ—¶å‘ç¼“å†²ç®¡ç†è€…å‘é€å‘Šè­¦ä¿¡æ¯çš„åœ°å€ä¿¡æ¯ã€‚\n\ncache_effective_user squid                        #è¿™é‡Œä»¥ç”¨æˆ·squidçš„èº«ä»½SquidæœåŠ¡å™¨\ncache_effective_group squid\n\nicp_port 0                       #æŒ‡å®šSquidä»é‚»å±…æœåŠ¡å™¨ç¼“å†²å†…å‘é€å’Œæ¥æ”¶ICPè¯·æ±‚çš„ç«¯å£å·ã€‚\n                     #è¿™é‡Œè®¾ç½®ä¸º0æ˜¯å› ä¸ºè¿™é‡Œé…ç½®Squidä¸ºå†…éƒ¨WebæœåŠ¡å™¨çš„åŠ é€Ÿå™¨ï¼Œ\n                     #æ‰€ä»¥ä¸éœ€è¦ä½¿ç”¨é‚»å±…æœåŠ¡å™¨çš„ç¼“å†²ã€‚0æ˜¯ç¦ç”¨\n\n# cache_peer è®¾ç½®å…è®¸æ›´æ–°ç¼“å­˜çš„ä¸»æœºï¼Œå› æ˜¯æœ¬æœºæ‰€ä»¥127.0.0.1\ncache_peer 127.0.0.1 parent 80 0 no-query default multicast-responder no-netdb-exchange\ncache_peer_domain 127.0.0.1                                 \nhostname_aliases 127.0.0.1\n\nerror_directory /usr/share/squid/errors/Simplify_Chinese        #å®šä¹‰é”™è¯¯è·¯å¾„\n\nalways_direct allow all                # cacheä¸¢å¤±æˆ–ä¸å­˜åœ¨æ˜¯å…è®¸æ‰€æœ‰è¯·æ±‚ç›´æ¥è½¬å‘åˆ°åŸå§‹æœåŠ¡å™¨\nignore_unknown_nameservers on        #å¼€åDNSæŸ¥è¯¢ï¼Œå½“åŸŸååœ°å€ä¸ç›¸åŒæ—¶å€™ï¼Œç¦æ­¢è®¿é—®\ncoredump_dir  /var/log/squid                 #å®šä¹‰dumpçš„ç›®å½•\n\nmax_filedesc 2048                #æœ€å¤§æ‰“å¼€çš„æ–‡ä»¶æè¿°\n\nhalf_closed_clients off        #ä½¿Squidåœ¨å½“readä¸å†è¿”å›æ•°æ®æ—¶ç«‹å³å…³é—­å®¢æˆ·ç«¯çš„è¿æ¥ã€‚\n                                #æœ‰æ—¶readä¸å†è¿”å›æ•°æ®æ˜¯ç”±äºæŸäº›å®¢æˆ·å…³é—­TCPçš„å‘é€æ•°æ®\n                                #è€Œä»ç„¶ä¿æŒæ¥æ”¶æ•°æ®ã€‚è€ŒSquidåˆ†è¾¨ä¸å‡ºTCPåŠå…³é—­å’Œå®Œå…¨å…³é—­ã€‚\n\nbuffered_logs on #è‹¥æ‰“å¼€é€‰é¡¹â€œbuffered_logsâ€å¯ä»¥ç¨ç¨æé«˜åŠ é€ŸæŸäº›å¯¹æ—¥å¿—æ–‡ä»¶çš„å†™å…¥ï¼Œè¯¥é€‰é¡¹ä¸»è¦æ˜¯å®ç°ä¼˜åŒ–ç‰¹æ€§ã€‚\n\n#é˜²æ­¢å¤©æ¶¯ç›—é“¾ï¼Œè½¬å«ç»™ç™¾åº¦\nacl tianya referer_regex -i tianya\nhttp_access deny tianya\ndeny_info  tianya\n#é˜»æ­¢baiduèœ˜è››\nacl baidu req_header User-Agent Baiduspider\nhttp_access deny baidu\n#é™åˆ¶åŒä¸€IPå®¢æˆ·ç«¯çš„æœ€å¤§è¿æ¥æ•°\nacl OverConnLimit maxconn 128\nhttp_access deny OverConnLimit\n\n#é˜²æ­¢è¢«äººåˆ©ç”¨ä¸ºHTTPä»£ç†ï¼Œè®¾ç½®å…è®¸è®¿é—®çš„IPåœ°å€\nacl myip dst 222.18.63.37\nhttp_access deny !myip\n\n#å…è®¸æœ¬åœ°ç®¡ç†\nacl Manager proto cache_object\nacl Localhost src 127.0.0.1 222.18.63.37\nhttp_access allow Manager Localhost\ncachemgr_passwd 53034338 all\nhttp_access deny Manager\n\n#ä»…ä»…å…è®¸80ç«¯å£çš„ä»£ç†\nacl all src 0.0.0.0/0.0.0.0\nacl Safe_ports port 80 # http\nhttp_access deny !Safe_ports\nhttp_access allow all\n\n#Squidä¿¡æ¯è®¾ç½®\nvisible_hostname happy.swjtu.edu.cn\ncache_mgr  ooopic2008@qq.com\n\n#åŸºæœ¬è®¾ç½®\ncache_effective_user squid\ncache_effective_group squid\ntcp_recv_bufsize 65535 bytes\n\n#2.6çš„åå‘ä»£ç†åŠ é€Ÿé…ç½®\ncache_peer 127.0.0.1 parent 80 0 no-query originserver\n\n#é”™è¯¯æ–‡æ¡£\nerror_directory /usr/local/squid/share/errors/Simplify_Chinese\n\n#å•å°ä½¿ç”¨ï¼Œä¸ä½¿ç”¨è¯¥åŠŸèƒ½\nicp_port 0\n\nhierarchy_stoplist cgi-bin ?\n\nacl QUERY urlpath_regex cgi-bin \\? .php .cgi .avi .wmv .rm .ram .mpg .mpeg .zip .exe\ncache deny QUERY\n\nacl apache rep_header Server ^Apache\nbroken_vary_encoding allow apache\n\n\nrefresh_pattern ^ftp:           1440 20%     10080\nrefresh_pattern ^gopher:        1440 0%    1440\nrefresh_pattern .             0    20%     4320\n\ncache_store_log none\npid_filename /usr/local/squid/var/logs/squid.pid\nemulate_httpd_log on\n```\n\n## Squidå¸¸ç”¨å‘½ä»¤\n\n1.  åˆå§‹åŒ–åœ¨squid.confé‡Œé…ç½®çš„cacheç›®å½•\n    squid -z\n    å¦‚æœæœ‰é”™è¯¯æç¤ºï¼Œè¯·æ£€æŸ¥cacheç›®å½•çš„æƒé™ï¼Œå¯ä»¥æ›´æ”¹ç›®å½•æƒé™\n    chown -R squid:squid /cacheç›®å½•\n2.  å¯¹squid.confæ’é”™ï¼Œå³éªŒè¯squid.confçš„è¯­æ³•å’Œé…ç½®\n    squid -k parse\n    å¦‚æœåœ¨squid.confä¸­æœ‰è¯­æ³•æˆ–é…ç½®é”™è¯¯ï¼Œè¿™é‡Œä¼šè¿”å›æç¤ºï¼Œè‹¥æ— è¿”å›ï¼Œå°è¯•å¯åŠ¨squid\n3.  å‰å°å¯åŠ¨squidï¼Œå¹¶è¾“å‡ºå¯åŠ¨è¿‡ç¨‹\n    /usr/local/squid/sbin/squid -N -d1\n    å¦‚æœæœ‰ready to server requesç›¸å…³ä¿¡æ¯ï¼Œè¯´æ˜squidå¯åŠ¨æˆåŠŸ\n    ç„¶åctrl+c ,åœæ­¢squid,å¹¶ä»¥åå°è¿è¡Œçš„æ–¹å¼å¯åŠ¨å®ƒ\n4.  å¯åŠ¨squidåœ¨åå°è¿è¡Œ\n    squid -s\n    å¯ä»¥ä½¿ç”¨ps -ax | grep squid æ¥æŸ¥çœ‹squidè¿›ç¨‹æ˜¯å¦å­˜åœ¨\n5.  åœæ­¢squid\n    squid -k shutdown\n6.  é‡æ–°å¼•å¯¼ä¿®æ”¹è¿‡çš„squid.conf\n    squid -k reconfigure -f /XXX/squid.conf\n    å½“squidè¿›è¡Œé…ç½®æ›´æ”¹åï¼Œå¯ä»¥ä½¿ç”¨è¯¥å‘½ä»¤è¿›è¡Œsquidé…ç½®é‡è½½\n7.  æŠŠsquidæ·»åŠ åˆ°ç³»ç»Ÿå¯åŠ¨é¡¹\n    vim /etc/rc.local\n    /usr/local/squid/sbin/squid -s\n8.  ä¿®æ”¹cacheç¼“å­˜ç›®å½•çš„æƒé™\n    chown -R squid.squid /cacheç›®å½•\n    cacheç¼“å­˜ç›®å½•æ ¹æ®è‡ªå·±çš„é…ç½®æ›´æ”¹ï¼Œsquidç”¨æˆ·å’Œç»„æ˜¯squidï¼Œsquid\n9.  ä¿®æ”¹squidæ—¥å¿—ç›®å½•çš„æƒé™\n    chown -R squid.squid å®šä¹‰çš„æ—¥å¿—æ–‡ä»¶æ‰€åœ¨ç›®å½•\n    è¿™ä¸€æ­¥å¹¶ä¸æ˜¯é€‚åˆæ¯ä¸€ä¸ªä½¿ç”¨squidçš„ç”¨æˆ·ï¼Œæ„ä¸ºè®©squidæœ‰æƒé™åœ¨è¯¥ç›®å½•é‡Œè¿›è¡Œå†™æ“ä½œ\n10.  æŸ¥çœ‹ä½ çš„æ—¥å¿—æ–‡æ¡£\n    more /usr/local/squid/var/logs/access.log | grep TCP_MEM_HIT\n    è¯¥æŒ‡ä»¤å¯ä»¥çœ‹åˆ°åœ¨squidè¿è¡Œè¿‡ç¨‹ä¸­ï¼Œæœ‰é‚£äº›æ–‡ä»¶è¢«squidç¼“å­˜åˆ°å†…å­˜ä¸­ï¼Œå¹¶è¿”å›ç»™è®¿é—®ç”¨æˆ·ã€‚\n    more /usr/local/squid/var/logs/access.log | grep TCP_HIT\n    è¯¥æŒ‡ä»¤å¯ä»¥çœ‹åˆ°åœ¨squidè¿è¡Œè¿‡ç¨‹ä¸­ï¼Œæœ‰é‚£äº›æ–‡ä»¶è¢«squidç¼“å­˜åˆ°cacheç›®å½•ä¸­ï¼Œå¹¶è¿”å›ç»™è®¿é—®ç”¨æˆ·ã€‚\n    more /usr/local/squid/var/logs/access.log | grep TCP_MISS\n    è¯¥æŒ‡ä»¤å¯ä»¥çœ‹åˆ°åœ¨squidè¿è¡Œè¿‡ç¨‹ä¸­ï¼Œæœ‰é‚£äº›æ–‡ä»¶æ²¡æœ‰è¢«squidç¼“å­˜ï¼Œè€Œæ˜¯ä»åŸå§‹æœåŠ¡å™¨è·å–å¹¶è¿”å›ç»™è®¿é—®ç”¨æˆ·ã€‚\n\n## Squidå‘½ä¸­ç‡åˆ†æ\n\n```\n/usr/local/squid/bin/squidclient -p 80 mgr:info\n/usr/local/squid/bin/squidclient -p 80 mgr:5min\n```\nå¯ä»¥çœ‹åˆ°è¯¦ç»†çš„æ€§èƒ½æƒ…å†µ,å…¶ä¸­PORTæ˜¯ä½ çš„proxyçš„ç«¯å£ï¼Œ5minå¯ä»¥æ˜¯60min\nå–å¾—squidè¿è¡ŒçŠ¶æ€ä¿¡æ¯ï¼š\n\n```\n squidclient -p 80 mgr:info\n```\n\nå–å¾—squidå†…å­˜ä½¿ç”¨æƒ…å†µï¼š\n\n```\nsquidclient -p 80 mgr:mem\n```\n\nå–å¾—squidå·²ç»ç¼“å­˜çš„åˆ—è¡¨ï¼š\n\n```\nsquidclient -p 80 mgr:bjects. use it carefully,it may crash\n```\n\nå–å¾—squidçš„ç£ç›˜ä½¿ç”¨æƒ…å†µï¼š\n\n```\nsquidclient -p 80 mgr:diskd\n```\n\nå¼ºåˆ¶æ›´æ–°æŸä¸ªurlï¼š\n\n```\nsquidclient -p 80 -m PURGE http://www.xxx.com/xxx.php\n```\n\næ›´å¤šçš„è¯·æŸ¥çœ‹ï¼šsquidclient-h æˆ–è€… squidclient -p 80 mgr:\næŸ¥å‘½ä¸­ç‡ï¼š\n\n```\nsquidclient -h IP(å…·ä½“ä¾¦å¬IP) -p 80(å…·ä½“ä¾¦å¬ç«¯å£) mgr:info\n```\n\n## å®šæœŸæ¸…ç†swap.stateå†…æ— æ•ˆæ•°æ®\n\n```\n/path/to/squid/sbin/squid -k rotate -f /path/to/squid/conf_file\nvi /etc/crontab\n0        0       *       *       *       root    /usr/local/sbin/squid -k rotate -f /usr/local/etc/squid/squid1.conf\n```\n\nå½“squidåº”ç”¨è¿è¡Œäº†ä¸€æ®µæ—¶é—´ä¹‹åï¼Œcache_dirå¯¹åº”çš„swap.stateæ–‡ä»¶å°±ä¼šå˜å¾—è¶Šæ¥è¶Šå¤§ï¼Œé‡Œé¢çš„æ— æ•ˆæ¥å£æ•°æ®è¶Šæ¥è¶Šå¤šï¼Œè¿™å¯èƒ½å½±å“squidçš„å“åº”æ—¶é—´ï¼Œå› æ­¤éœ€è¦ä½¿ç”¨squidæ¸…ç†swap.stateé‡Œé¢çš„æ— æ•ˆæ•°æ®ï¼Œå‡å°‘swap.stateçš„å¤§å°ã€‚\n","content":"<h2 id=\"squidçš„æ¦‚å¿µ\">squidçš„æ¦‚å¿µ<a href=\"post/squid#squidçš„æ¦‚å¿µ\"></a></h2><p>squidæ˜¯ä¸€ç§ç”¨æ¥ç¼“å­˜Internetæ•°æ®çš„è½¯ä»¶ã€‚æ¥å—æ¥è‡ªäººä»¬éœ€è¦ä¸‹è½½çš„ç›®æ ‡ï¼ˆobjectï¼‰çš„è¯·æ±‚å¹¶é€‚å½“çš„å¤„ç†è¿™äº›è¯·æ±‚ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œå¦‚æœä¸€ä¸ªäººæƒ³ä¸‹è½½ä¸€webç•Œé¢ï¼Œä»–è¯·æ±‚squidä¸ºä»–å–å¾—è¿™ä¸ªé¡µé¢ã€‚squidéšä¹‹è¿æ¥åˆ°è¿œç¨‹æœåŠ¡å™¨å¹¶å‘è¿™ä¸ªé¡µé¢å‘å‡ºè¯·æ±‚ã€‚ç„¶åï¼Œsquidæ˜¾å¼åœ°èšé›†æ•°æ®åˆ°å®¢æˆ·ç«¯æœºå™¨ï¼Œè€Œä¸”åŒæ—¶å¤åˆ¶ä¸€ä»½ã€‚å½“ä¸‹ä¸€æ¬¡æœ‰äººéœ€è¦åŒä¸€é¡µé¢æ—¶ï¼Œ squidå¯ä»¥ç®€å•çš„ä»ç£ç›˜ä¸­è¯»åˆ°å®ƒï¼Œé‚£æ ·æ•°æ®ä¼šç«‹å³ä¼ è¾“åˆ°å®¢æˆ·æœºä¸Šã€‚</p>\n<a id=\"more\"></a>\n\n<h2 id=\"ä¸‹è½½åœ°å€\">ä¸‹è½½åœ°å€<a href=\"post/squid#ä¸‹è½½åœ°å€\"></a></h2><p>squid-cache å®˜ç½‘ <a href=\"http://www.squid-cache.org\" target=\"_blank\" rel=\"noopener\">http://www.squid-cache.org</a></p>\n<p>squidä»‹ç»åŠå…¶ç®€å•é…ç½® <a href=\"https://www.cnblogs.com/cherishry/p/5706736.html\" target=\"_blank\" rel=\"noopener\">https://www.cnblogs.com/cherishry/p/5706736.html</a></p>\n<p>CentOS 7å®‰è£…squidä»£ç†æœåŠ¡å™¨ <a href=\"https://blog.csdn.net/ithomer/article/details/78136993\" target=\"_blank\" rel=\"noopener\">https://blog.csdn.net/ithomer/article/details/78136993</a></p>\n<h2 id=\"squidä»£ç†çš„ä½œç”¨\">squidä»£ç†çš„ä½œç”¨<a href=\"post/squid#squidä»£ç†çš„ä½œç”¨\"></a></h2><ul>\n<li>é€šè¿‡ç¼“å­˜çš„æ–¹å¼ä¸ºç”¨æˆ·æä¾›Webè®¿é—®åŠ é€Ÿ</li>\n<li>å¯¹ç”¨æˆ·çš„Webè®¿é—®è¿›è¡Œè¿‡æ»¤æ§åˆ¶</li>\n</ul>\n<h2 id=\"å·¥ä½œæµç¨‹\">å·¥ä½œæµç¨‹<a href=\"post/squid#å·¥ä½œæµç¨‹\"></a></h2><p>å½“ä»£ç†æœåŠ¡å™¨ä¸­æœ‰å®¢æˆ·ç«¯éœ€è¦çš„æ•°æ®æ—¶ï¼š</p>\n<p>a.å®¢æˆ·ç«¯å‘ä»£ç†æœåŠ¡å™¨å‘é€æ•°æ®è¯·æ±‚ï¼›</p>\n<p>b.ä»£ç†æœåŠ¡å™¨æ£€æŸ¥è‡ªå·±çš„æ•°æ®ç¼“å­˜ï¼›</p>\n<p>c.ä»£ç†æœåŠ¡å™¨åœ¨ç¼“å­˜ä¸­æ‰¾åˆ°äº†ç”¨æˆ·æƒ³è¦çš„æ•°æ®ï¼Œå–å‡ºæ•°æ®ï¼›</p>\n<p>d.ä»£ç†æœåŠ¡å™¨å°†ä»ç¼“å­˜ä¸­å–å¾—çš„æ•°æ®è¿”å›ç»™å®¢æˆ·ç«¯ã€‚</p>\n<p>å½“ä»£ç†æœåŠ¡å™¨ä¸­æ²¡æœ‰å®¢æˆ·ç«¯éœ€è¦çš„æ•°æ®æ—¶äº†ï¼š</p>\n<p>1.å®¢æˆ·ç«¯å‘ä»£ç†æœåŠ¡å™¨å‘é€æ•°æ®è¯·æ±‚ï¼›</p>\n<p>2.ä»£ç†æœåŠ¡å™¨æ£€æŸ¥è‡ªå·±çš„æ•°æ®ç¼“å­˜ï¼›</p>\n<p>3.ä»£ç†æœåŠ¡å™¨åœ¨ç¼“å­˜ä¸­æ²¡æœ‰æ‰¾åˆ°ç”¨æˆ·æƒ³è¦çš„æ•°æ®ï¼›</p>\n<p>4.ä»£ç†æœåŠ¡å™¨å‘Internet ä¸Šçš„è¿œç«¯æœåŠ¡å™¨å‘é€æ•°æ®è¯·æ±‚ï¼›</p>\n<p>5.è¿œç«¯æœåŠ¡å™¨å“åº”ï¼Œè¿”å›ç›¸åº”çš„æ•°æ®ï¼›</p>\n<p>6.ä»£ç†æœåŠ¡å™¨å–å¾—è¿œç«¯æœåŠ¡å™¨çš„æ•°æ®ï¼Œè¿”å›ç»™å®¢æˆ·ç«¯ï¼Œå¹¶ä¿ç•™ä¸€ä»½åˆ°è‡ªå·±çš„æ•°æ®ç¼“å­˜ä¸­ã€‚</p>\n<div class=\"article-img\"><p><img src=\"https://images2015.cnblogs.com/blog/872781/201607/872781-20160726112850919-758636566.jpg\" alt=\"\" data-zoomable=\"\"></p></div>\n<p>Squidä»£ç†æœåŠ¡å™¨å·¥ä½œåœ¨TCP/IPåº”ç”¨å±‚</p>\n<div class=\"article-img\"><p><img src=\"https://images2015.cnblogs.com/blog/872781/201607/872781-20160726112935653-887103660.jpg\" alt=\"\" data-zoomable=\"\"></p></div>\n<h2 id=\"Squidå„ç§ä»£ç†çš„å®šä¹‰\">Squidå„ç§ä»£ç†çš„å®šä¹‰<a href=\"post/squid#Squidå„ç§ä»£ç†çš„å®šä¹‰\"></a></h2><h3 id=\"æ­£å‘ä»£ç†\">æ­£å‘ä»£ç†<a href=\"post/squid#æ­£å‘ä»£ç†\"></a></h3><h4 id=\"æ ‡å‡†çš„ä»£ç†ç¼“å†²æœåŠ¡å™¨\">æ ‡å‡†çš„ä»£ç†ç¼“å†²æœåŠ¡å™¨<a href=\"post/squid#æ ‡å‡†çš„ä»£ç†ç¼“å†²æœåŠ¡å™¨\"></a></h4><p>ä¸€ä¸ªæ ‡å‡†çš„ä»£ç†ç¼“å†²æœåŠ¡è¢«ç”¨äºç¼“å­˜é™æ€çš„ç½‘é¡µåˆ°æœ¬åœ°ç½‘ç»œä¸Šçš„ä¸€å°ä¸»æœºä¸Šï¼ˆå³ä»£ç†æœåŠ¡å™¨ï¼‰ã€‚å½“è¢«ç¼“å­˜çš„é¡µé¢è¢«ç¬¬äºŒæ¬¡è®¿é—®çš„æ—¶å€™ï¼Œæµè§ˆå™¨å°†ç›´æ¥ä»æœ¬åœ°ä»£ç†æœåŠ¡å™¨é‚£é‡Œè·å–è¯·æ±‚æ•°æ®è€Œä¸å†å‘åŸwebç«™ç‚¹è¯·æ±‚æ•°æ®ã€‚è¿™æ ·å°±èŠ‚çœäº†å®è´µçš„ç½‘ç»œå¸¦å®½ï¼Œè€Œä¸”æé«˜äº†è®¿é—®é€Ÿåº¦ã€‚ä½†æ˜¯ï¼Œè¦æƒ³å®ç°è¿™ç§æ–¹å¼ï¼Œå¿…é¡»åœ¨æ¯ä¸€ä¸ªå†…éƒ¨ä¸»æœºçš„æµè§ˆå™¨ä¸Šæ˜ç¡®æŒ‡åä»£ç†æœåŠ¡å™¨çš„IPåœ°å€å’Œç«¯å£å·ã€‚å®¢æˆ·ç«¯ä¸Šç½‘æ—¶ï¼Œæ¯æ¬¡éƒ½æŠŠè¯·æ±‚å‘é€ç»™ä»£ç†æœåŠ¡å™¨å¤„ç†,ä»£ç†æœåŠ¡å™¨æ ¹æ®è¯·æ±‚ç¡®å®šæ˜¯å¦è¿æ¥åˆ°è¿œç¨‹webæœåŠ¡å™¨è·å–æ•°æ®ã€‚å¦‚æœåœ¨æœ¬åœ°ç¼“å†²åŒºæœ‰ç›®æ ‡æ–‡ä»¶ï¼Œåˆ™ç›´æ¥å°†æ–‡ä»¶ä¼ ç»™ç”¨æˆ·å³å¯ã€‚å¦‚æœæ²¡æœ‰çš„è¯åˆ™å…ˆå–å›æ–‡ä»¶ï¼Œå…ˆåœ¨æœ¬åœ°ä¿å­˜ä¸€ä»½ç¼“å†²ï¼Œç„¶åå°†æ–‡ä»¶å‘é€ç»™å®¢æˆ·ç«¯æµè§ˆå™¨ã€‚</p>\n<h4 id=\"é€æ˜ä»£ç†ç¼“å†²æœåŠ¡å™¨\">é€æ˜ä»£ç†ç¼“å†²æœåŠ¡å™¨<a href=\"post/squid#é€æ˜ä»£ç†ç¼“å†²æœåŠ¡å™¨\"></a></h4><p>é€æ˜ä»£ç†ç¼“å†²æœåŠ¡å™¨å’Œæ ‡å‡†ä»£ç†æœåŠ¡å™¨çš„åŠŸèƒ½å®Œå…¨ç›¸åŒã€‚ä½†æ˜¯ï¼Œä»£ç†æ“ä½œå¯¹å®¢æˆ·ç«¯çš„æµè§ˆå™¨æ˜¯é€æ˜çš„ï¼ˆå³ä¸éœ€æŒ‡æ˜ä»£ç†æœåŠ¡å™¨çš„IPå’Œç«¯å£ï¼‰ã€‚é€æ˜ä»£ç†æœåŠ¡å™¨é˜»æ–­ç½‘ç»œé€šä¿¡ï¼Œå¹¶ä¸”è¿‡æ»¤å‡ºè®¿é—®å¤–éƒ¨çš„HTTPï¼ˆ80ç«¯å£ï¼‰æµé‡ã€‚å¦‚æœå®¢æˆ·ç«¯çš„è¯·æ±‚åœ¨æœ¬åœ°æœ‰ç¼“å†²åˆ™å°†ç¼“å†²çš„æ•°æ®ç›´æ¥å‘ç»™ç”¨æˆ·ï¼Œå¦‚æœåœ¨æœ¬åœ°æ²¡æœ‰ç¼“å†²åˆ™å‘è¿œç¨‹webæœåŠ¡å™¨å‘å‡ºè¯·æ±‚ï¼Œå…¶ä½™æ“ä½œå’Œæ ‡å‡†çš„ä»£ç†æœåŠ¡å™¨å®Œå…¨ç›¸åŒã€‚å¯¹äºlinuxæ“ä½œç³»ç»Ÿæ¥è¯´ï¼Œé€æ˜ä»£ç†ä½¿ç”¨Iptablesæˆ–è€…Ipchainså®ç°ã€‚å› æ­¤ä¸éœ€è¦å¯¹æµè§ˆå™¨ä½œä»»ä½•è®¾ç½®ï¼Œæ‰€ä»¥ï¼Œé€æ˜ä»£ç†å¯¹äºISPï¼ˆInternetæœåŠ¡å™¨æä¾›å•†ï¼‰ç‰¹åˆ«æœ‰ç”¨ã€‚</p>\n<h3 id=\"åå‘ä»£ç†\">åå‘ä»£ç†<a href=\"post/squid#åå‘ä»£ç†\"></a></h3><h4 id=\"åå‘ä»£ç†ç¼“å†²å™¨\">åå‘ä»£ç†ç¼“å†²å™¨<a href=\"post/squid#åå‘ä»£ç†ç¼“å†²å™¨\"></a></h4><p>åå‘ä»£ç†æ˜¯å’Œå‰ä¸¤ç§ä»£ç†å®Œå…¨ä¸åŒçš„ä¸€ç§ä»£ç†æœåŠ¡ã€‚ä½¿ç”¨å®ƒå¯ä»¥é™ä½åŸå§‹WEBæœåŠ¡å™¨çš„è´Ÿè½½ã€‚åå‘ä»£ç†æœåŠ¡å™¨æ‰¿æ‹…äº†å¯¹åŸå§‹WEBæœåŠ¡å™¨çš„é™æ€é¡µé¢çš„è¯·æ±‚ï¼Œé˜²æ­¢åŸå§‹æœåŠ¡å™¨è¿‡è½½ã€‚å®ƒä½äºWEBæœåŠ¡å™¨å’ŒInternetä¹‹é—´ï¼Œå¤„ç†æ‰€æœ‰å¯¹WEBæœåŠ¡å™¨çš„è¯·æ±‚ï¼Œç»„ç»‡äº†WEBæœåŠ¡å™¨å’ŒInternetçš„ç›´æ¥é€šä¿¡ã€‚å¦‚æœäº’è”ç½‘ç”¨æˆ·è¯·æ±‚çš„é¡µé¢åœ¨ä»£ç†æœåŠ¡å™¨ä¸Šæœ‰ç¼“å†²çš„è¯ï¼Œä»£ç†æœåŠ¡å™¨ç›´æ¥å°†ç¼“å†²å†…å®¹å‘é€ç»™ç”¨æˆ·ã€‚å¦‚æœæ²¡æœ‰ç¼“å†²åˆ™å…ˆå‘WEBæœåŠ¡å™¨å‘å‡ºè¯·æ±‚ï¼Œå–å›æ•°æ®ï¼Œæœ¬åœ°ç¼“å­˜åå†å‘ç»™ç”¨æˆ·ã€‚è¿™ç§æ–¹å¼é€šè¿‡é™ä½äº†WEBæœåŠ¡å™¨çš„è¯·æ±‚æ•°ä»è€Œé™ä½äº†WEBæœåŠ¡å™¨çš„è´Ÿè½½ã€‚</p>\n<h3 id=\"æ­£å‘ä»£ç†ä¸åå‘ä»£ç†çš„åŒºåˆ«\">æ­£å‘ä»£ç†ä¸åå‘ä»£ç†çš„åŒºåˆ«<a href=\"post/squid#æ­£å‘ä»£ç†ä¸åå‘ä»£ç†çš„åŒºåˆ«\"></a></h3><h3 id=\"æ¦‚å¿µ\">æ¦‚å¿µ<a href=\"post/squid#æ¦‚å¿µ\"></a></h3><p>æ­£å‘ä»£ç†ï¼šå¯¹äºåŸå§‹æœåŠ¡å™¨è€Œè¨€ï¼Œå°±æ˜¯å®¢æˆ·ç«¯çš„ä»£è¨€äºº<br>åå‘ä»£ç†ï¼šå¯¹äºå®¢æˆ·ç«¯è€Œè¨€ï¼Œå°±åƒæ˜¯åŸå§‹æœåŠ¡å™¨</p>\n<h3 id=\"ç”¨é€”\">ç”¨é€”<a href=\"post/squid#ç”¨é€”\"></a></h3><p>æ­£å‘ä»£ç†çš„å…¸å‹ç”¨é€”æ˜¯ä¸ºåœ¨é˜²ç«å¢™å†…çš„å±€åŸŸç½‘å®¢æˆ·ç«¯æä¾›è®¿é—®Internetçš„é€”å¾„ã€‚æ­£å‘ä»£ç†è¿˜å¯ä»¥ä½¿ç”¨ç¼“å†²ç‰¹æ€§å‡å°‘ç½‘ç»œä½¿ç”¨ç‡ã€‚<br>åå‘ä»£ç†è¿˜å¯ä»¥ä¸ºåç«¯çš„å¤šå°æœåŠ¡å™¨æä¾›è´Ÿè½½å¹³è¡¡ï¼Œæˆ–ä¸ºåç«¯è¾ƒæ…¢çš„æœåŠ¡å™¨æä¾›ç¼“å†²æœåŠ¡ã€‚å¦å¤–ï¼Œåå‘ä»£ç†è¿˜å¯ä»¥å¯ç”¨é«˜çº§URLç­–ç•¥å’Œç®¡ç†æŠ€æœ¯ï¼Œä»è€Œä½¿å¤„äºä¸åŒwebæœåŠ¡å™¨ç³»ç»Ÿçš„webé¡µé¢åŒæ—¶å­˜åœ¨äºåŒä¸€ä¸ªURLç©ºé—´ä¸‹ã€‚</p>\n<h3 id=\"å®‰å…¨æ€§\">å®‰å…¨æ€§<a href=\"post/squid#å®‰å…¨æ€§\"></a></h3><p>æ­£å‘ä»£ç†å…è®¸å®¢æˆ·ç«¯é€šè¿‡å®ƒè®¿é—®ä»»æ„ç½‘ç«™å¹¶ä¸”éšè—å®¢æˆ·ç«¯è‡ªèº«ï¼Œå› æ­¤ä½ å¿…é¡»é‡‡å–å®‰å…¨æªæ–½ä»¥ç¡®ä¿ä»…ä¸ºç»è¿‡æˆæƒçš„å®¢æˆ·ç«¯æä¾›æœåŠ¡ã€‚<br>åå‘ä»£ç†å¯¹å¤–éƒ½æ˜¯é€æ˜çš„ï¼Œè®¿é—®è€…å¹¶ä¸çŸ¥é“è‡ªå·±è®¿é—®çš„æ˜¯ä¸€ä¸ªä»£ç†ã€‚</p>\n<h2 id=\"Squidä¸»è¦ç»„æˆéƒ¨åˆ†\">Squidä¸»è¦ç»„æˆéƒ¨åˆ†<a href=\"post/squid#Squidä¸»è¦ç»„æˆéƒ¨åˆ†\"></a></h2><p>æœåŠ¡åï¼š<code>squid</code><br>ä¸»ç¨‹åºï¼š<code>/usr/sbin/squid</code><br>é…ç½®ç›®å½•ï¼š<code>/etc/squid</code><br>ä¸»é…ç½®æ–‡ä»¶ï¼š<code>/etc/squid/squid.conf</code><br>ç›‘å¬tcpç«¯å£å·ï¼š<code>3128</code><br>é»˜è®¤è®¿é—®æ—¥å¿—æ–‡ä»¶ï¼š<code>/var/log/squid/access.log</code></p>\n<h2 id=\"squidå¸¸ç”¨é…ç½®é€‰é¡¹\">squidå¸¸ç”¨é…ç½®é€‰é¡¹<a href=\"post/squid#squidå¸¸ç”¨é…ç½®é€‰é¡¹\"></a></h2><p><code>/etc/squid/squid.conf</code></p>\n<figure class=\"highlight glsl\"><div><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\">http_port <span class=\"number\">3128</span>  (è¿˜å¯ä»¥åªç›‘å¬ä¸€ä¸ªIP http_port <span class=\"number\">192.168</span><span class=\"number\">.0</span><span class=\"number\">.1</span>:<span class=\"number\">3128</span>)</span><br><span class=\"line\">cache_mem <span class=\"number\">64</span>MB  <span class=\"meta\">#ç¼“å­˜å å†…å­˜å¤§å°</span></span><br><span class=\"line\">maximum_object_size <span class=\"number\">4096</span>KB  <span class=\"meta\">#æœ€å¤§ç¼“å­˜å—</span></span><br><span class=\"line\">reply_body_max_size  <span class=\"number\">1024000</span> allow <span class=\"built_in\">all</span>      <span class=\"meta\">#é™å®šä¸‹è½½æ–‡ä»¶å¤§å°</span></span><br><span class=\"line\">access_log /var/<span class=\"built_in\">log</span>/squid/access.<span class=\"built_in\">log</span>    <span class=\"meta\">#è®¿é—®æ—¥å¿—å­˜æ”¾çš„åœ°æ–¹</span></span><br><span class=\"line\">visible_hostname    proxy.test.xom  <span class=\"meta\">#å¯è§çš„ä¸»æœºå</span></span><br><span class=\"line\">cache_dir ufs /var/spool/squid  <span class=\"number\">100</span> <span class=\"number\">16</span> <span class=\"number\">256</span> </span><br><span class=\"line\"><span class=\"meta\">#ufs:ç¼“å­˜æ•°æ®çš„å­˜å‚¨æ ¼å¼</span></span><br><span class=\"line\"><span class=\"meta\">#/var/spool/squid    ç¼“å­˜ç›®å½•</span></span><br><span class=\"line\"><span class=\"meta\">#100ï¼šç¼“å­˜ç›®å½•å ç£ç›˜ç©ºé—´å¤§å°ï¼ˆMï¼‰</span></span><br><span class=\"line\"><span class=\"meta\">#16ï¼šç¼“å­˜ç©ºé—´ä¸€çº§å­ç›®å½•ä¸ªæ•°</span></span><br><span class=\"line\"><span class=\"meta\">#256ï¼šç¼“å­˜ç©ºé—´äºŒçº§å­ç›®å½•ä¸ªæ•°</span></span><br><span class=\"line\">cache_mgr webmaster@test.com    <span class=\"meta\">#å®šä¹‰ç®¡ç†å‘˜é‚®ç®±</span></span><br><span class=\"line\">http_access deny <span class=\"built_in\">all</span>    <span class=\"meta\">#è®¿é—®æ§åˆ¶</span></span><br></pre></td></tr></table></div></figure>\n\n<h2 id=\"squidä¸­çš„è®¿é—®æ§åˆ¶\">squidä¸­çš„è®¿é—®æ§åˆ¶<a href=\"post/squid#squidä¸­çš„è®¿é—®æ§åˆ¶\"></a></h2><p>  ä½¿ç”¨è®¿é—®æ§åˆ¶ç‰¹æ€§ï¼Œå¯ä»¥æ§åˆ¶åœ¨è®¿é—®æ—¶æ ¹æ®ç‰¹å®šçš„æ—¶é—´é—´éš”è¿›è¡Œç¼“å­˜ã€è®¿é—®ç‰¹å®šç«™ç‚¹æˆ–ä¸€ç»„ç«™ç‚¹ç­‰ç­‰ã€‚squidè®¿é—®æ§åˆ¶æœ‰ä¸¤ä¸ªè¦ç´ ï¼šACLå…ƒç´ å’Œè®¿é—®åˆ—è¡¨ã€‚è®¿é—®åˆ—è¡¨å¯ä»¥å…è®¸æˆ–æ‹’ç»æŸäº›ç”¨æˆ·å¯¹æ­¤æœåŠ¡çš„è®¿é—®ã€‚</p>\n<h3 id=\"ACLå…ƒç´ ç±»å‹\">ACLå…ƒç´ ç±»å‹<a href=\"post/squid#ACLå…ƒç´ ç±»å‹\"></a></h3><ul>\n<li>srcï¼šæºåœ°å€ï¼ˆå³å®¢æˆ·æœºIPåœ°å€ï¼‰</li>\n<li>dstï¼šç›®æ ‡åœ°å€ï¼ˆå³æœåŠ¡å™¨IPåœ°å€ï¼‰</li>\n<li>srcdomainï¼šæºåç§°ï¼ˆå³å®¢æˆ·æœºåç§°ï¼‰</li>\n<li>dstdomainï¼šç›®æ ‡åç§°ï¼ˆå³æœåŠ¡å™¨åç§°ï¼‰</li>\n<li>timeï¼šä¸€å¤©ä¸­çš„æ—¶åˆ»å’Œä¸€å‘¨å†…çš„ä¸€å¤©</li>\n<li>url_regexï¼šURLè§„åˆ™è¡¨è¾¾å¼åŒ¹é…</li>\n<li>urlpath_regexï¼šURL-pathè§„åˆ™è¡¨è¾¾å¼åŒ¹é…ï¼Œç•¥å»åè®®å’Œä¸»æœºå</li>\n<li>proxy_authï¼šé€šè¿‡å¤–éƒ¨ç¨‹åºè¿›è¡Œç”¨æˆ·éªŒè¯</li>\n<li>maxconnï¼šå•ä¸€IPçš„æœ€å¤§è¿æ¥æ•°</li>\n</ul>\n<h3 id=\"ACLæ ¼å¼\">ACLæ ¼å¼<a href=\"post/squid#ACLæ ¼å¼\"></a></h3><pre><code>ä¸ºäº†ä½¿ç”¨æ§åˆ¶åŠŸèƒ½ï¼Œå¿…é¡»å…ˆè®¾ç½®ACLè§„åˆ™å¹¶åº”ç”¨ã€‚ACLå£°æ˜çš„æ ¼å¼å¦‚ä¸‹ï¼š</code></pre><p>æ³¨ï¼š</p>\n<ul>\n<li>acl_element_name å¯ä»¥æ˜¯ä»»ä¸€ä¸ªåœ¨ACLä¸­å®šä¹‰çš„åç§°</li>\n<li>ä»»ä½•ä¸¤ä¸ªACLå…ƒç´ ä¸èƒ½ç”¨ç›¸åŒçš„åå­—</li>\n<li>æ¯ä¸ªACLç”±åˆ—è¡¨å€¼ç»„æˆã€‚å½“è¿›è¡ŒåŒ¹é…æ£€æµ‹çš„æ—¶å€™ï¼Œå¤šä¸ªå€¼ç”±é€»è¾‘æˆ–è¿ç®—è¿æ¥ï¼›æ¢è¨€ä¹‹ï¼Œå³ä»»ä¸€ACLå…ƒç´ çš„å€¼è¢«åŒ¹é…ï¼Œåˆ™è¿™ä¸ªACLå…ƒç´ å³è¢«åŒ¹é…ã€‚</li>\n<li>å¹¶ä¸æ˜¯æ‰€æœ‰ACLå…ƒç´ éƒ½èƒ½ä½¿ç”¨è®¿é—®åˆ—è¡¨ä¸­çš„å…¨éƒ¨ç±»å‹</li>\n<li>ä¸åŒçš„ACLå…ƒç´ å†™åœ¨ä¸åŒè¡Œä¸­ï¼Œsquidå°†æŠŠä»–ä»¬ç»„åˆåœ¨ä¸€ä¸ªåˆ—è¡¨ä¸­</li>\n</ul>\n<h3 id=\"è®¿é—®æ¡ç›®\">è®¿é—®æ¡ç›®<a href=\"post/squid#è®¿é—®æ¡ç›®\"></a></h3><p>æˆ‘ä»¬å¯ä»¥ä½¿ç”¨è®¸å¤šä¸åŒçš„è®¿é—®æ¡ç›®ã€‚ä¸‹é¢æ˜¯æˆ‘ä»¬å¸¸ç”¨çš„å‡ ä¸ªï¼š</p>\n<ul>\n<li>http_access:å…è®¸HTTPè®¿é—®</li>\n<li>no_cache:å®šä¹‰å¯¹ç¼“å­˜è¯·æ±‚çš„å“åº”ã€‚<br>è®¿é—®åˆ—è¡¨çš„è§„åˆ™ç”±ä¸€äº›ç±»ä¼¼â€™allowâ€™æˆ–â€˜denyâ€™çš„å…³é”®å­—æ„æˆï¼Œç”¨ä»¥å…è®¸æˆ–æ‹’ç»å‘ç‰¹å®šæˆ–ä¸€ç»„ACLå…ƒç´ æä¾›æœåŠ¡ã€‚</li>\n</ul>\n<ol>\n<li>ä¸€ä¸ªè®¿é—®åˆ—è¡¨å¯ä»¥ç”±å¤šæ¡è§„åˆ™ç»„æˆ</li>\n<li>å¦‚æœæ²¡æœ‰ä»»ä½•è§„åˆ™ä¸è®¿é—®è¯·æ±‚åŒ¹é…ï¼Œé»˜è®¤åŠ¨ä½œå°†ä¸åˆ—è¡¨ä¸­æœ€åä¸€æ¡è§„åˆ™å¯¹åº”ã€‚</li>\n<li>ä¸€ä¸ªè®¿é—®æ¡ç›®ä¸­æ‰€æœ‰å…ƒç´ å°†ç”¨é€»è¾‘ä¸è¿ç®—è¿æ¥<br>http_access Action å£°æ˜1 AND å£°æ˜2 AND å£°æ˜ OR.<br>http_access Action å£°æ˜3<br>å¤šä¸ªhttp_accessså£°æ˜é—´ç”¨æˆ–è¿ç®—è¿æ¥ï¼Œä½†æ¯ä¸ªè®¿é—®æ¡ç›®çš„å…ƒç´ é—´ç”¨ä¸è¿ç®—è¿æ¥ã€‚</li>\n<li>åˆ—è¡¨ä¸­çš„è§„åˆ™æ€»æ˜¯éµå¾ªç”±ä¸Šè€Œä¸‹çš„é¡ºåº</li>\n<li>è¿™äº›è§„åˆ™æŒ‰ç…§ä»–ä»¬çš„æ’åˆ—é¡ºåºè¿›è¡ŒåŒ¹é…æ£€æµ‹ï¼Œä¸€æ—¦æ£€æµ‹åˆ°åŒ¹é…çš„è§„åˆ™ï¼ŒåŒ¹é…å°±ç«‹å³ç»“æŸã€‚</li>\n</ol>\n<h2 id=\"Squid-confé…ç½®æ–‡ä»¶è¯¦è§£\">Squid.confé…ç½®æ–‡ä»¶è¯¦è§£<a href=\"post/squid#Squid-confé…ç½®æ–‡ä»¶è¯¦è§£\"></a></h2><figure class=\"highlight sql\"><div><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br><span class=\"line\">117</span><br><span class=\"line\">118</span><br><span class=\"line\">119</span><br><span class=\"line\">120</span><br><span class=\"line\">121</span><br><span class=\"line\">122</span><br><span class=\"line\">123</span><br><span class=\"line\">124</span><br><span class=\"line\">125</span><br><span class=\"line\">126</span><br><span class=\"line\">127</span><br><span class=\"line\">128</span><br><span class=\"line\">129</span><br><span class=\"line\">130</span><br><span class=\"line\">131</span><br><span class=\"line\">132</span><br><span class=\"line\">133</span><br><span class=\"line\">134</span><br><span class=\"line\">135</span><br><span class=\"line\">136</span><br><span class=\"line\">137</span><br><span class=\"line\">138</span><br><span class=\"line\">139</span><br><span class=\"line\">140</span><br><span class=\"line\">141</span><br><span class=\"line\">142</span><br><span class=\"line\">143</span><br><span class=\"line\">144</span><br><span class=\"line\">145</span><br><span class=\"line\">146</span><br><span class=\"line\">147</span><br><span class=\"line\">148</span><br><span class=\"line\">149</span><br><span class=\"line\">150</span><br><span class=\"line\">151</span><br><span class=\"line\">152</span><br><span class=\"line\">153</span><br><span class=\"line\">154</span><br><span class=\"line\">155</span><br><span class=\"line\">156</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">#acl all src 0.0.0.0/0.0.0.0 and http_access allow allé€‰é¡¹å®šä¹‰äº†ä¸€ä¸ªè®¿é—®æ§åˆ¶åˆ—è¡¨ã€‚è¯¦ç»†æƒ…å†µå‚è§å’ŒSquidè½¯ä»¶</span></span><br><span class=\"line\"><span class=\"comment\">#æºå¸¦çš„æ–‡æ¡£ã€‚è¿™é‡Œçš„è®¿é—®æ§åˆ¶åˆ—è¡¨å…è®¸æ‰€æœ‰å¯¹ä»£ç†æœåŠ¡çš„è®¿é—®ï¼Œå› ä¸ºè¿™é‡Œè¯¥ä»£ç†æ˜¯åŠ é€ŸwebæœåŠ¡å™¨ã€‚</span></span><br><span class=\"line\">acl all src 0.0.0.0/0.0.0.0                 <span class=\"comment\">#å…è®¸æ‰€æœ‰IPè®¿é—®</span></span><br><span class=\"line\">acl manager proto http                 <span class=\"comment\">#manager urlåè®®ä¸ºhttp</span></span><br><span class=\"line\">acl localhost src 127.0.0.1/255.255.255.255  <span class=\"comment\">#å…åˆæœ¬æœºIP</span></span><br><span class=\"line\">acl to_localhost dst 127.0.0.1                 <span class=\"comment\">#å…åˆç›®çš„åœ°å€ä¸ºæœ¬æœºIP</span></span><br><span class=\"line\">acl Safe_ports port 80                <span class=\"comment\"># å…è®¸å®‰å…¨æ›´æ–°çš„ç«¯å£ä¸º80</span></span><br><span class=\"line\">acl CONNECT method CONNECT        <span class=\"comment\">#è¯·æ±‚æ–¹æ³•ä»¥CONNECT</span></span><br><span class=\"line\">http_access allow all                <span class=\"comment\">#å…è®¸æ‰€æœ‰äººä½¿ç”¨è¯¥ä»£ç†.å› ä¸ºè¿™é‡Œæ˜¯ä»£ç†åŠ é€ŸwebæœåŠ¡å™¨</span></span><br><span class=\"line\">http_reply_access allow all                <span class=\"comment\">#å…è®¸æ‰€æœ‰å®¢æˆ·ç«¯ä½¿ç”¨è¯¥ä»£ç†</span></span><br><span class=\"line\"></span><br><span class=\"line\">acl OverConnLimit maxconn 16        <span class=\"comment\">#é™åˆ¶æ¯ä¸ªIPæœ€å¤§å…è®¸16ä¸ªè¿æ¥ï¼Œé˜²æ­¢æ”»å‡»</span></span><br><span class=\"line\">http_access deny OverConnLimit</span><br><span class=\"line\"></span><br><span class=\"line\">icp_access deny all                        <span class=\"comment\">#ç¦æ­¢ä»é‚»å±…æœåŠ¡å™¨ç¼“å†²å†…å‘é€å’Œæ¥æ”¶ICPè¯·æ±‚.</span></span><br><span class=\"line\">miss_access allow all                <span class=\"comment\">#å…è®¸ç›´æ¥æ›´æ–°è¯·æ±‚</span></span><br><span class=\"line\">ident_lookup_access deny all                                <span class=\"comment\">#ç¦æ­¢lookupæ£€æŸ¥DNS</span></span><br><span class=\"line\">http_port 8080 transparent                                <span class=\"comment\">#æŒ‡å®šSquidç›‘å¬æµè§ˆå™¨å®¢æˆ·è¯·æ±‚çš„ç«¯å£å·ã€‚</span></span><br><span class=\"line\"></span><br><span class=\"line\">hierarchy_stoplist cgi-bin ?                <span class=\"comment\">#ç”¨æ¥å¼ºåˆ¶æŸäº›ç‰¹å®šçš„å¯¹è±¡ä¸è¢«ç¼“å­˜ï¼Œä¸»è¦æ˜¯å¤„äºå®‰å…¨çš„ç›®çš„ã€‚</span></span><br><span class=\"line\">acl QUERY urlpath_regex cgi-bin \\?</span><br><span class=\"line\"><span class=\"keyword\">cache</span> deny <span class=\"keyword\">QUERY</span></span><br><span class=\"line\"></span><br><span class=\"line\">cache_mem <span class=\"number\">1</span> GB        <span class=\"comment\">#è¿™æ˜¯ä¸€ä¸ªä¼˜åŒ–é€‰é¡¹ï¼Œå¢åŠ è¯¥å†…å­˜å€¼æœ‰åˆ©äºç¼“å­˜ã€‚åº”è¯¥æ³¨æ„çš„æ˜¯ï¼š</span></span><br><span class=\"line\">                     <span class=\"comment\">#ä¸€èˆ¬æ¥è¯´å¦‚æœç³»ç»Ÿæœ‰å†…å­˜ï¼Œè®¾ç½®è¯¥å€¼ä¸º(n/)3Mã€‚ç°åœ¨æ˜¯3G æ‰€ä»¥è¿™é‡Œ1G</span></span><br><span class=\"line\">fqdncache_size <span class=\"number\">1024</span>        <span class=\"comment\">#FQDN é«˜é€Ÿç¼“å­˜å¤§å°</span></span><br><span class=\"line\">maximum_object_size_in_memory <span class=\"number\">2</span> MB        <span class=\"comment\">#å…è®¸æœ€å¤§çš„æ–‡ä»¶è½½å…¥å†…å­˜</span></span><br><span class=\"line\"></span><br><span class=\"line\">memory_replacement_policy <span class=\"keyword\">heap</span> LFUDA  <span class=\"comment\">#åŠ¨æ€ä½¿ç”¨æœ€å°çš„ï¼Œç§»å‡ºå†…å­˜cache</span></span><br><span class=\"line\">cache_replacement_policy <span class=\"keyword\">heap</span> LFUDA         <span class=\"comment\">#åŠ¨æ€ä½¿ç”¨æœ€å°çš„ï¼Œç§»å‡ºç¡¬ç›˜cache</span></span><br><span class=\"line\"></span><br><span class=\"line\">cache_dir ufs /home/<span class=\"keyword\">cache</span> <span class=\"number\">5000</span> <span class=\"number\">32</span> <span class=\"number\">512</span>  <span class=\"comment\">#é«˜é€Ÿç¼“å­˜ç›®å½• ufs ç±»å‹ ä½¿ç”¨çš„ç¼“å†²å€¼æœ€å¤§å…åˆ1000MBç©ºé—´ï¼Œ</span></span><br><span class=\"line\"><span class=\"comment\">#32ä¸ªä¸€çº§ç›®å½•ï¼Œ512ä¸ªäºŒçº§ç›®å½•</span></span><br><span class=\"line\"></span><br><span class=\"line\">max_open_disk_fds <span class=\"number\">0</span>                                 <span class=\"comment\">#å…è®¸æœ€å¤§æ‰“å¼€æ–‡ä»¶æ•°é‡,0 æ— é™åˆ¶</span></span><br><span class=\"line\">minimum_object_size <span class=\"number\">1</span> KB                         <span class=\"comment\">#å…åˆæœ€å°æ–‡ä»¶è¯·æ±‚ä½“å¤§å°</span></span><br><span class=\"line\">maximum_object_size <span class=\"number\">20</span> MB                 <span class=\"comment\">#å…åˆæœ€å¤§æ–‡ä»¶è¯·æ±‚ä½“å¤§å°</span></span><br><span class=\"line\"></span><br><span class=\"line\">cache_swap_low <span class=\"number\">90</span>                            <span class=\"comment\">#æœ€å°å…è®¸ä½¿ç”¨swap 90%</span></span><br><span class=\"line\">cache_swap_high <span class=\"number\">95</span>                            <span class=\"comment\">#æœ€å¤šå…è®¸ä½¿ç”¨swap 95%</span></span><br><span class=\"line\"></span><br><span class=\"line\">ipcache_size <span class=\"number\">2048</span>                                <span class=\"comment\"># IP åœ°å€é«˜é€Ÿç¼“å­˜å¤§å° 2M</span></span><br><span class=\"line\">ipcache_low <span class=\"number\">90</span>                                <span class=\"comment\">#æœ€å°å…è®¸ipcacheä½¿ç”¨swap 90%</span></span><br><span class=\"line\">ipcache_high <span class=\"number\">95</span>                                  <span class=\"comment\">#æœ€å¤§å…è®¸ipcacheä½¿ç”¨swap 90%</span></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">access_log /<span class=\"keyword\">var</span>/<span class=\"keyword\">log</span>/squid/access.log squid        <span class=\"comment\">#å®šä¹‰æ—¥å¿—å­˜æ”¾è®°å½•</span></span><br><span class=\"line\">cache_log /<span class=\"keyword\">var</span>/<span class=\"keyword\">log</span>/squid/cache.log squid</span><br><span class=\"line\">cache_store_log <span class=\"keyword\">none</span>                        <span class=\"comment\">#ç¦æ­¢storeæ—¥å¿—</span></span><br><span class=\"line\"></span><br><span class=\"line\">emulate_httpd_log <span class=\"keyword\">on</span>        <span class=\"comment\">#å°†ä½¿Squidä»¿ç…§WebæœåŠ¡å™¨çš„æ ¼å¼åˆ›å»ºè®¿é—®è®°å½•ã€‚å¦‚æœå¸Œæœ›ä½¿ç”¨</span></span><br><span class=\"line\">                                <span class=\"comment\">#Webè®¿é—®è®°å½•åˆ†æç¨‹åºï¼Œå°±éœ€è¦è®¾ç½®è¿™ä¸ªå‚æ•°ã€‚</span></span><br><span class=\"line\"></span><br><span class=\"line\">refresh_pattern . <span class=\"number\">0</span> <span class=\"number\">20</span>% <span class=\"number\">4320</span> override-<span class=\"keyword\">expire</span> override-lastmod reload-<span class=\"keyword\">into</span>-ims <span class=\"keyword\">ignore</span>-reload   <span class=\"comment\">#æ›´æ–°cacheè§„åˆ™</span></span><br><span class=\"line\"></span><br><span class=\"line\">acl buggy_server url_regex ^<span class=\"keyword\">http</span>://.... <span class=\"keyword\">http</span>://          <span class=\"comment\">#åªå…è®¸httpçš„è¯·æ±‚</span></span><br><span class=\"line\">broken_posts <span class=\"keyword\">allow</span> buggy_server</span><br><span class=\"line\"></span><br><span class=\"line\">acl apache rep_header <span class=\"keyword\">Server</span> ^Apache                 <span class=\"comment\">#å…è®¸apacheçš„ç¼–ç </span></span><br><span class=\"line\">broken_vary_encoding <span class=\"keyword\">allow</span> apache</span><br><span class=\"line\"></span><br><span class=\"line\">request_entities <span class=\"keyword\">off</span>                                        <span class=\"comment\">#ç¦æ­¢éhttpçš„æ ‡åˆ†å‡†è¯·æ±‚ï¼Œé˜²æ­¢æ”»å‡»</span></span><br><span class=\"line\">header_access header <span class=\"keyword\">allow</span> all                        <span class=\"comment\">#å…è®¸æ‰€æœ‰çš„httpæŠ¥å¤´</span></span><br><span class=\"line\">relaxed_header_parser <span class=\"keyword\">on</span>                                <span class=\"comment\">#ä¸ä¸¥æ ¼åˆ†æhttpæŠ¥å¤´.</span></span><br><span class=\"line\">client_lifetime <span class=\"number\">120</span> <span class=\"keyword\">minute</span>                                <span class=\"comment\">#æœ€å¤§å®¢æˆ·è¿æ¥æ—¶é—´ 120åˆ†é’Ÿ</span></span><br><span class=\"line\"></span><br><span class=\"line\">cache_mgr sky@test.com                        <span class=\"comment\">#æŒ‡å®šå½“ç¼“å†²å‡ºç°é—®é¢˜æ—¶å‘ç¼“å†²ç®¡ç†è€…å‘é€å‘Šè­¦ä¿¡æ¯çš„åœ°å€ä¿¡æ¯ã€‚</span></span><br><span class=\"line\"></span><br><span class=\"line\">cache_effective_user squid                        <span class=\"comment\">#è¿™é‡Œä»¥ç”¨æˆ·squidçš„èº«ä»½SquidæœåŠ¡å™¨</span></span><br><span class=\"line\">cache_effective_group squid</span><br><span class=\"line\"></span><br><span class=\"line\">icp_port <span class=\"number\">0</span>                       <span class=\"comment\">#æŒ‡å®šSquidä»é‚»å±…æœåŠ¡å™¨ç¼“å†²å†…å‘é€å’Œæ¥æ”¶ICPè¯·æ±‚çš„ç«¯å£å·ã€‚</span></span><br><span class=\"line\">                     <span class=\"comment\">#è¿™é‡Œè®¾ç½®ä¸º0æ˜¯å› ä¸ºè¿™é‡Œé…ç½®Squidä¸ºå†…éƒ¨WebæœåŠ¡å™¨çš„åŠ é€Ÿå™¨ï¼Œ</span></span><br><span class=\"line\">                     <span class=\"comment\">#æ‰€ä»¥ä¸éœ€è¦ä½¿ç”¨é‚»å±…æœåŠ¡å™¨çš„ç¼“å†²ã€‚0æ˜¯ç¦ç”¨</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># cache_peer è®¾ç½®å…è®¸æ›´æ–°ç¼“å­˜çš„ä¸»æœºï¼Œå› æ˜¯æœ¬æœºæ‰€ä»¥127.0.0.1</span></span><br><span class=\"line\">cache_peer <span class=\"number\">127.0</span><span class=\"number\">.0</span><span class=\"number\">.1</span> <span class=\"keyword\">parent</span> <span class=\"number\">80</span> <span class=\"number\">0</span> <span class=\"keyword\">no</span>-<span class=\"keyword\">query</span> <span class=\"keyword\">default</span> multicast-responder <span class=\"keyword\">no</span>-netdb-<span class=\"keyword\">exchange</span></span><br><span class=\"line\">cache_peer_domain <span class=\"number\">127.0</span><span class=\"number\">.0</span><span class=\"number\">.1</span>                                 </span><br><span class=\"line\">hostname_aliases <span class=\"number\">127.0</span><span class=\"number\">.0</span><span class=\"number\">.1</span></span><br><span class=\"line\"></span><br><span class=\"line\">error_directory /usr/<span class=\"keyword\">share</span>/squid/<span class=\"keyword\">errors</span>/Simplify_Chinese        <span class=\"comment\">#å®šä¹‰é”™è¯¯è·¯å¾„</span></span><br><span class=\"line\"></span><br><span class=\"line\">always_direct <span class=\"keyword\">allow</span> all                <span class=\"comment\"># cacheä¸¢å¤±æˆ–ä¸å­˜åœ¨æ˜¯å…è®¸æ‰€æœ‰è¯·æ±‚ç›´æ¥è½¬å‘åˆ°åŸå§‹æœåŠ¡å™¨</span></span><br><span class=\"line\">ignore_unknown_nameservers <span class=\"keyword\">on</span>        <span class=\"comment\">#å¼€åDNSæŸ¥è¯¢ï¼Œå½“åŸŸååœ°å€ä¸ç›¸åŒæ—¶å€™ï¼Œç¦æ­¢è®¿é—®</span></span><br><span class=\"line\">coredump_dir  /<span class=\"keyword\">var</span>/<span class=\"keyword\">log</span>/squid                 <span class=\"comment\">#å®šä¹‰dumpçš„ç›®å½•</span></span><br><span class=\"line\"></span><br><span class=\"line\">max_filedesc <span class=\"number\">2048</span>                <span class=\"comment\">#æœ€å¤§æ‰“å¼€çš„æ–‡ä»¶æè¿°</span></span><br><span class=\"line\"></span><br><span class=\"line\">half_closed_clients <span class=\"keyword\">off</span>        <span class=\"comment\">#ä½¿Squidåœ¨å½“readä¸å†è¿”å›æ•°æ®æ—¶ç«‹å³å…³é—­å®¢æˆ·ç«¯çš„è¿æ¥ã€‚</span></span><br><span class=\"line\">                                <span class=\"comment\">#æœ‰æ—¶readä¸å†è¿”å›æ•°æ®æ˜¯ç”±äºæŸäº›å®¢æˆ·å…³é—­TCPçš„å‘é€æ•°æ®</span></span><br><span class=\"line\">                                <span class=\"comment\">#è€Œä»ç„¶ä¿æŒæ¥æ”¶æ•°æ®ã€‚è€ŒSquidåˆ†è¾¨ä¸å‡ºTCPåŠå…³é—­å’Œå®Œå…¨å…³é—­ã€‚</span></span><br><span class=\"line\"></span><br><span class=\"line\">buffered_logs <span class=\"keyword\">on</span> <span class=\"comment\">#è‹¥æ‰“å¼€é€‰é¡¹â€œbuffered_logsâ€å¯ä»¥ç¨ç¨æé«˜åŠ é€ŸæŸäº›å¯¹æ—¥å¿—æ–‡ä»¶çš„å†™å…¥ï¼Œè¯¥é€‰é¡¹ä¸»è¦æ˜¯å®ç°ä¼˜åŒ–ç‰¹æ€§ã€‚</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#é˜²æ­¢å¤©æ¶¯ç›—é“¾ï¼Œè½¬å«ç»™ç™¾åº¦</span></span><br><span class=\"line\">acl tianya referer_regex -i tianya</span><br><span class=\"line\">http_access deny tianya</span><br><span class=\"line\">deny_info  tianya</span><br><span class=\"line\"><span class=\"comment\">#é˜»æ­¢baiduèœ˜è››</span></span><br><span class=\"line\">acl baidu req_header <span class=\"keyword\">User</span>-<span class=\"keyword\">Agent</span> Baiduspider</span><br><span class=\"line\">http_access deny baidu</span><br><span class=\"line\"><span class=\"comment\">#é™åˆ¶åŒä¸€IPå®¢æˆ·ç«¯çš„æœ€å¤§è¿æ¥æ•°</span></span><br><span class=\"line\">acl OverConnLimit maxconn <span class=\"number\">128</span></span><br><span class=\"line\">http_access deny OverConnLimit</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#é˜²æ­¢è¢«äººåˆ©ç”¨ä¸ºHTTPä»£ç†ï¼Œè®¾ç½®å…è®¸è®¿é—®çš„IPåœ°å€</span></span><br><span class=\"line\">acl myip dst <span class=\"number\">222.18</span><span class=\"number\">.63</span><span class=\"number\">.37</span></span><br><span class=\"line\">http_access deny !myip</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#å…è®¸æœ¬åœ°ç®¡ç†</span></span><br><span class=\"line\">acl Manager proto cache_object</span><br><span class=\"line\">acl Localhost src <span class=\"number\">127.0</span><span class=\"number\">.0</span><span class=\"number\">.1</span> <span class=\"number\">222.18</span><span class=\"number\">.63</span><span class=\"number\">.37</span></span><br><span class=\"line\">http_access <span class=\"keyword\">allow</span> Manager Localhost</span><br><span class=\"line\">cachemgr_passwd <span class=\"number\">53034338</span> all</span><br><span class=\"line\">http_access deny Manager</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#ä»…ä»…å…è®¸80ç«¯å£çš„ä»£ç†</span></span><br><span class=\"line\">acl all src <span class=\"number\">0.0</span><span class=\"number\">.0</span><span class=\"number\">.0</span>/<span class=\"number\">0.0</span><span class=\"number\">.0</span><span class=\"number\">.0</span></span><br><span class=\"line\">acl Safe_ports port <span class=\"number\">80</span> <span class=\"comment\"># http</span></span><br><span class=\"line\">http_access deny !Safe_ports</span><br><span class=\"line\">http_access <span class=\"keyword\">allow</span> all</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#Squidä¿¡æ¯è®¾ç½®</span></span><br><span class=\"line\">visible_hostname happy.swjtu.edu.cn</span><br><span class=\"line\">cache_mgr  ooopic2008@qq.com</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#åŸºæœ¬è®¾ç½®</span></span><br><span class=\"line\">cache_effective_user squid</span><br><span class=\"line\">cache_effective_group squid</span><br><span class=\"line\">tcp_recv_bufsize <span class=\"number\">65535</span> <span class=\"keyword\">bytes</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#2.6çš„åå‘ä»£ç†åŠ é€Ÿé…ç½®</span></span><br><span class=\"line\">cache_peer <span class=\"number\">127.0</span><span class=\"number\">.0</span><span class=\"number\">.1</span> <span class=\"keyword\">parent</span> <span class=\"number\">80</span> <span class=\"number\">0</span> <span class=\"keyword\">no</span>-<span class=\"keyword\">query</span> originserver</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#é”™è¯¯æ–‡æ¡£</span></span><br><span class=\"line\">error_directory /usr/<span class=\"keyword\">local</span>/squid/<span class=\"keyword\">share</span>/<span class=\"keyword\">errors</span>/Simplify_Chinese</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#å•å°ä½¿ç”¨ï¼Œä¸ä½¿ç”¨è¯¥åŠŸèƒ½</span></span><br><span class=\"line\">icp_port <span class=\"number\">0</span></span><br><span class=\"line\"></span><br><span class=\"line\">hierarchy_stoplist cgi-<span class=\"keyword\">bin</span> ?</span><br><span class=\"line\"></span><br><span class=\"line\">acl <span class=\"keyword\">QUERY</span> urlpath_regex cgi-<span class=\"keyword\">bin</span> \\? .php .cgi .avi .wmv .rm .ram .mpg .mpeg .zip .exe</span><br><span class=\"line\"><span class=\"keyword\">cache</span> deny <span class=\"keyword\">QUERY</span></span><br><span class=\"line\"></span><br><span class=\"line\">acl apache rep_header <span class=\"keyword\">Server</span> ^Apache</span><br><span class=\"line\">broken_vary_encoding <span class=\"keyword\">allow</span> apache</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">refresh_pattern ^<span class=\"keyword\">ftp</span>:           <span class=\"number\">1440</span> <span class=\"number\">20</span>%     <span class=\"number\">10080</span></span><br><span class=\"line\">refresh_pattern ^gopher:        <span class=\"number\">1440</span> <span class=\"number\">0</span>%    <span class=\"number\">1440</span></span><br><span class=\"line\">refresh_pattern .             <span class=\"number\">0</span>    <span class=\"number\">20</span>%     <span class=\"number\">4320</span></span><br><span class=\"line\"></span><br><span class=\"line\">cache_store_log <span class=\"keyword\">none</span></span><br><span class=\"line\">pid_filename /usr/<span class=\"keyword\">local</span>/squid/<span class=\"keyword\">var</span>/<span class=\"keyword\">logs</span>/squid.pid</span><br><span class=\"line\">emulate_httpd_log <span class=\"keyword\">on</span></span><br></pre></td></tr></table></div></figure>\n\n<h2 id=\"Squidå¸¸ç”¨å‘½ä»¤\">Squidå¸¸ç”¨å‘½ä»¤<a href=\"post/squid#Squidå¸¸ç”¨å‘½ä»¤\"></a></h2><ol>\n<li>åˆå§‹åŒ–åœ¨squid.confé‡Œé…ç½®çš„cacheç›®å½•<br>squid -z<br>å¦‚æœæœ‰é”™è¯¯æç¤ºï¼Œè¯·æ£€æŸ¥cacheç›®å½•çš„æƒé™ï¼Œå¯ä»¥æ›´æ”¹ç›®å½•æƒé™<br>chown -R squid:squid /cacheç›®å½•</li>\n<li>å¯¹squid.confæ’é”™ï¼Œå³éªŒè¯squid.confçš„è¯­æ³•å’Œé…ç½®<br>squid -k parse<br>å¦‚æœåœ¨squid.confä¸­æœ‰è¯­æ³•æˆ–é…ç½®é”™è¯¯ï¼Œè¿™é‡Œä¼šè¿”å›æç¤ºï¼Œè‹¥æ— è¿”å›ï¼Œå°è¯•å¯åŠ¨squid</li>\n<li>å‰å°å¯åŠ¨squidï¼Œå¹¶è¾“å‡ºå¯åŠ¨è¿‡ç¨‹<br>/usr/local/squid/sbin/squid -N -d1<br>å¦‚æœæœ‰ready to server requesç›¸å…³ä¿¡æ¯ï¼Œè¯´æ˜squidå¯åŠ¨æˆåŠŸ<br>ç„¶åctrl+c ,åœæ­¢squid,å¹¶ä»¥åå°è¿è¡Œçš„æ–¹å¼å¯åŠ¨å®ƒ</li>\n<li>å¯åŠ¨squidåœ¨åå°è¿è¡Œ<br>squid -s<br>å¯ä»¥ä½¿ç”¨ps -ax | grep squid æ¥æŸ¥çœ‹squidè¿›ç¨‹æ˜¯å¦å­˜åœ¨</li>\n<li>åœæ­¢squid<br>squid -k shutdown</li>\n<li>é‡æ–°å¼•å¯¼ä¿®æ”¹è¿‡çš„squid.conf<br>squid -k reconfigure -f /XXX/squid.conf<br>å½“squidè¿›è¡Œé…ç½®æ›´æ”¹åï¼Œå¯ä»¥ä½¿ç”¨è¯¥å‘½ä»¤è¿›è¡Œsquidé…ç½®é‡è½½</li>\n<li>æŠŠsquidæ·»åŠ åˆ°ç³»ç»Ÿå¯åŠ¨é¡¹<br>vim /etc/rc.local<br>/usr/local/squid/sbin/squid -s</li>\n<li>ä¿®æ”¹cacheç¼“å­˜ç›®å½•çš„æƒé™<br>chown -R squid.squid /cacheç›®å½•<br>cacheç¼“å­˜ç›®å½•æ ¹æ®è‡ªå·±çš„é…ç½®æ›´æ”¹ï¼Œsquidç”¨æˆ·å’Œç»„æ˜¯squidï¼Œsquid</li>\n<li>ä¿®æ”¹squidæ—¥å¿—ç›®å½•çš„æƒé™<br>chown -R squid.squid å®šä¹‰çš„æ—¥å¿—æ–‡ä»¶æ‰€åœ¨ç›®å½•<br>è¿™ä¸€æ­¥å¹¶ä¸æ˜¯é€‚åˆæ¯ä¸€ä¸ªä½¿ç”¨squidçš„ç”¨æˆ·ï¼Œæ„ä¸ºè®©squidæœ‰æƒé™åœ¨è¯¥ç›®å½•é‡Œè¿›è¡Œå†™æ“ä½œ</li>\n<li>æŸ¥çœ‹ä½ çš„æ—¥å¿—æ–‡æ¡£<br>more /usr/local/squid/var/logs/access.log | grep TCP_MEM_HIT<br>è¯¥æŒ‡ä»¤å¯ä»¥çœ‹åˆ°åœ¨squidè¿è¡Œè¿‡ç¨‹ä¸­ï¼Œæœ‰é‚£äº›æ–‡ä»¶è¢«squidç¼“å­˜åˆ°å†…å­˜ä¸­ï¼Œå¹¶è¿”å›ç»™è®¿é—®ç”¨æˆ·ã€‚<br>more /usr/local/squid/var/logs/access.log | grep TCP_HIT<br>è¯¥æŒ‡ä»¤å¯ä»¥çœ‹åˆ°åœ¨squidè¿è¡Œè¿‡ç¨‹ä¸­ï¼Œæœ‰é‚£äº›æ–‡ä»¶è¢«squidç¼“å­˜åˆ°cacheç›®å½•ä¸­ï¼Œå¹¶è¿”å›ç»™è®¿é—®ç”¨æˆ·ã€‚<br>more /usr/local/squid/var/logs/access.log | grep TCP_MISS<br>è¯¥æŒ‡ä»¤å¯ä»¥çœ‹åˆ°åœ¨squidè¿è¡Œè¿‡ç¨‹ä¸­ï¼Œæœ‰é‚£äº›æ–‡ä»¶æ²¡æœ‰è¢«squidç¼“å­˜ï¼Œè€Œæ˜¯ä»åŸå§‹æœåŠ¡å™¨è·å–å¹¶è¿”å›ç»™è®¿é—®ç”¨æˆ·ã€‚</li>\n</ol>\n<h2 id=\"Squidå‘½ä¸­ç‡åˆ†æ\">Squidå‘½ä¸­ç‡åˆ†æ<a href=\"post/squid#Squidå‘½ä¸­ç‡åˆ†æ\"></a></h2><figure class=\"highlight groovy\"><div><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"regexp\">/usr/</span>local<span class=\"regexp\">/squid/</span>bin/squidclient -p <span class=\"number\">80</span> <span class=\"string\">mgr:</span>info</span><br><span class=\"line\"><span class=\"regexp\">/usr/</span>local<span class=\"regexp\">/squid/</span>bin/squidclient -p <span class=\"number\">80</span> <span class=\"string\">mgr:</span><span class=\"number\">5</span>min</span><br></pre></td></tr></table></div></figure>\n\n<p>å¯ä»¥çœ‹åˆ°è¯¦ç»†çš„æ€§èƒ½æƒ…å†µ,å…¶ä¸­PORTæ˜¯ä½ çš„proxyçš„ç«¯å£ï¼Œ5minå¯ä»¥æ˜¯60min<br>å–å¾—squidè¿è¡ŒçŠ¶æ€ä¿¡æ¯ï¼š</p>\n<figure class=\"highlight nginx\"><div><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attribute\">squidclient</span> -p <span class=\"number\">80</span> mgr:<span class=\"literal\">info</span></span><br></pre></td></tr></table></div></figure>\n\n<p>å–å¾—squidå†…å­˜ä½¿ç”¨æƒ…å†µï¼š</p>\n<figure class=\"highlight stylus\"><div><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">squidclient -<span class=\"selector-tag\">p</span> <span class=\"number\">80</span> mgr:mem</span><br></pre></td></tr></table></div></figure>\n\n<p>å–å¾—squidå·²ç»ç¼“å­˜çš„åˆ—è¡¨ï¼š</p>\n<figure class=\"highlight armasm\"><div><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"symbol\">squidclient</span> -p <span class=\"number\">80</span> mgr:<span class=\"keyword\">bjects. </span>use <span class=\"keyword\">it </span>carefully,<span class=\"keyword\">it </span>may crash</span><br></pre></td></tr></table></div></figure>\n\n<p>å–å¾—squidçš„ç£ç›˜ä½¿ç”¨æƒ…å†µï¼š</p>\n<figure class=\"highlight stylus\"><div><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">squidclient -<span class=\"selector-tag\">p</span> <span class=\"number\">80</span> mgr:diskd</span><br></pre></td></tr></table></div></figure>\n\n<p>å¼ºåˆ¶æ›´æ–°æŸä¸ªurlï¼š</p>\n<figure class=\"highlight stylus\"><div><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">squidclient -<span class=\"selector-tag\">p</span> <span class=\"number\">80</span> -m PURGE http:<span class=\"comment\">//www.xxx.com/xxx.php</span></span><br></pre></td></tr></table></div></figure>\n\n<p>æ›´å¤šçš„è¯·æŸ¥çœ‹ï¼šsquidclient-h æˆ–è€… squidclient -p 80 mgr:<br>æŸ¥å‘½ä¸­ç‡ï¼š</p>\n<figure class=\"highlight armasm\"><div><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"symbol\">squidclient</span> -h <span class=\"built_in\">IP</span>(å…·ä½“ä¾¦å¬<span class=\"built_in\">IP</span>) -p <span class=\"number\">80</span>(å…·ä½“ä¾¦å¬ç«¯å£) mgr:<span class=\"meta\">info</span></span><br></pre></td></tr></table></div></figure>\n\n<h2 id=\"å®šæœŸæ¸…ç†swap-stateå†…æ— æ•ˆæ•°æ®\">å®šæœŸæ¸…ç†swap.stateå†…æ— æ•ˆæ•°æ®<a href=\"post/squid#å®šæœŸæ¸…ç†swap-stateå†…æ— æ•ˆæ•°æ®\"></a></h2><figure class=\"highlight dts\"><div><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta-keyword\">/path/</span>to<span class=\"meta-keyword\">/squid/</span>sbin/squid -k rotate -f <span class=\"meta-keyword\">/path/</span>to<span class=\"meta-keyword\">/squid/</span>conf_file</span><br><span class=\"line\">vi <span class=\"meta-keyword\">/etc/</span>crontab</span><br><span class=\"line\"><span class=\"number\">0</span>        <span class=\"number\">0</span>       *       *       *       root    <span class=\"meta-keyword\">/usr/</span>local<span class=\"meta-keyword\">/sbin/</span>squid -k rotate -f <span class=\"meta-keyword\">/usr/</span>local<span class=\"meta-keyword\">/etc/</span>squid/squid1.conf</span><br></pre></td></tr></table></div></figure>\n\n<p>å½“squidåº”ç”¨è¿è¡Œäº†ä¸€æ®µæ—¶é—´ä¹‹åï¼Œcache_dirå¯¹åº”çš„swap.stateæ–‡ä»¶å°±ä¼šå˜å¾—è¶Šæ¥è¶Šå¤§ï¼Œé‡Œé¢çš„æ— æ•ˆæ¥å£æ•°æ®è¶Šæ¥è¶Šå¤šï¼Œè¿™å¯èƒ½å½±å“squidçš„å“åº”æ—¶é—´ï¼Œå› æ­¤éœ€è¦ä½¿ç”¨squidæ¸…ç†swap.stateé‡Œé¢çš„æ— æ•ˆæ•°æ®ï¼Œå‡å°‘swap.stateçš„å¤§å°ã€‚</p>\n","slug":"squid","updated":"2019-06-26T02:42:28.427Z","comments":true,"link":"post/squid","permalink":"https://shuntan.github.io/posts/squid/","excerpt":"squidçš„æ¦‚å¿µsquidæ˜¯ä¸€ç§ç”¨æ¥ç¼“å­˜Internetæ•°æ®çš„è½¯ä»¶ã€‚æ¥å—æ¥è‡ªäººä»¬éœ€è¦ä¸‹è½½çš„ç›®æ ‡ï¼ˆobjectï¼‰çš„è¯·æ±‚å¹¶é€‚å½“çš„å¤„ç†è¿™äº›è¯·æ±‚ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œå¦‚æœä¸€ä¸ªäººæƒ³ä¸‹è½½ä¸€webç•Œé¢ï¼Œä»–è¯·æ±‚squidä¸ºä»–å–å¾—è¿™ä¸ªé¡µé¢ã€‚squidéšä¹‹è¿æ¥åˆ°è¿œç¨‹æœåŠ¡å™¨å¹¶å‘è¿™ä¸ªé¡µé¢å‘å‡ºè¯·æ±‚ã€‚ç„¶åï¼Œsquidæ˜¾å¼åœ°èšé›†æ•°æ®åˆ°å®¢æˆ·ç«¯æœºå™¨ï¼Œè€Œä¸”åŒæ—¶å¤åˆ¶ä¸€ä»½ã€‚å½“ä¸‹ä¸€æ¬¡æœ‰äººéœ€è¦åŒä¸€é¡µé¢æ—¶ï¼Œ squidå¯ä»¥ç®€å•çš„ä»ç£ç›˜ä¸­è¯»åˆ°å®ƒï¼Œé‚£æ ·æ•°æ®ä¼šç«‹å³ä¼ è¾“åˆ°å®¢æˆ·æœºä¸Šã€‚","categories":[{"name":"Linux","slug":"Linux","permalink":"https://shuntan.github.io/categories/Linux/"}],"tags":[{"name":"squid","slug":"squid","permalink":"https://shuntan.github.io/tags/squid/"},{"name":"proxy","slug":"proxy","permalink":"https://shuntan.github.io/tags/proxy/"}]}]}