[{"title":"test TOC","date":"2019-06-22T06:16:57.000Z","updated":"2019-06-29T01:44:03.501Z","content":"This is H1\ntest H1\nThis is H1ff\ntest H1\nThis is H2\ntest H2\nThis is  H3\n\n\nstd::mutex\n\n\nstd::recursive_mutex\n\n\nstd::time_mutex\n\n\nstd::recursive_timed_mutex\n\n\n\nThis is  H4\ntest H4\n","plink":"https://shuntan.github.io/post/test/"},{"title":"mutexå¤´æ–‡ä»¶ä»‹ç»","date":"2019-06-14T03:00:47.000Z","updated":"2019-06-26T01:57:03.838Z","content":"Head\nMutex åˆç§°äº’æ–¥é‡ï¼ŒC++ 11ä¸­ä¸ Mutex ç›¸å…³çš„ç±»ï¼ˆåŒ…æ‹¬é”ç±»å‹ï¼‰å’Œå‡½æ•°éƒ½å£°æ˜åœ¨  å¤´æ–‡ä»¶ä¸­ï¼Œæ‰€ä»¥å¦‚æœä½ éœ€è¦ä½¿ç”¨ std::mutexï¼Œå°±å¿…é¡»åŒ…å«  å¤´æ–‡ä»¶ã€‚\n å¤´æ–‡ä»¶ä»‹ç»\newde2e\nMutex ç³»åˆ—ç±»(å››ç§)\n\n\nstd::mutexï¼Œæœ€åŸºæœ¬çš„ Mutex ç±»ã€‚\n\n\nstd::recursive_mutexï¼Œé€’å½’ Mutex ç±»ã€‚\n\n\nstd::time_mutexï¼Œå®šæ—¶ Mutex ç±»ã€‚\n\n\nstd::recursive_timed_mutexï¼Œå®šæ—¶é€’å½’ Mutex ç±»ã€‚\n\n\n\nLock ç±»ï¼ˆä¸¤ç§ï¼‰\n\nstd::lock_guardï¼Œä¸ Mutex RAII ç›¸å…³ï¼Œæ–¹ä¾¿çº¿ç¨‹å¯¹äº’æ–¥é‡ä¸Šé”ã€‚\nstd::unique_lockï¼Œä¸ Mutex RAII ç›¸å…³ï¼Œæ–¹ä¾¿çº¿ç¨‹å¯¹äº’æ–¥é‡ä¸Šé”ï¼Œä½†æä¾›äº†æ›´å¥½çš„ä¸Šé”å’Œè§£é”æ§åˆ¶ã€‚\n\nå…¶ä»–ç±»å‹\n\nstd::once_flag\nstd::adopt_lock_t\nstd::defer_lock_t\nstd::try_to_lock_t\n\nå‡½æ•°\n\nstd::try_lockï¼Œå°è¯•åŒæ—¶å¯¹å¤šä¸ªäº’æ–¥é‡ä¸Šé”ã€‚\nstd::lockï¼Œå¯ä»¥åŒæ—¶å¯¹å¤šä¸ªäº’æ–¥é‡ä¸Šé”ã€‚\nstd::call_onceï¼Œå¦‚æœå¤šä¸ªçº¿ç¨‹éœ€è¦åŒæ—¶è°ƒç”¨æŸä¸ªå‡½æ•°ï¼Œcall_once å¯ä»¥ä¿è¯å¤šä¸ªçº¿ç¨‹å¯¹è¯¥å‡½æ•°åªè°ƒç”¨ä¸€æ¬¡ã€‚\n\nstd::mutex ä»‹ç»\nä¸‹é¢ä»¥ std::mutex ä¸ºä¾‹ä»‹ç» C++11 ä¸­çš„äº’æ–¥é‡ç”¨æ³•ã€‚\nstd::mutex æ˜¯C++11 ä¸­æœ€åŸºæœ¬çš„äº’æ–¥é‡ï¼Œstd::mutex å¯¹è±¡æä¾›äº†ç‹¬å æ‰€æœ‰æƒçš„ç‰¹æ€§â€”â€”å³ä¸æ”¯æŒé€’å½’åœ°å¯¹ std::mutex å¯¹è±¡ä¸Šé”ï¼Œè€Œ std::recursive_lock åˆ™å¯ä»¥é€’å½’åœ°å¯¹äº’æ–¥é‡å¯¹è±¡ä¸Šé”ã€‚\nstd::mutex çš„æˆå‘˜å‡½æ•°\n\næ„é€ å‡½æ•°ï¼Œstd::mutexä¸å…è®¸æ‹·è´æ„é€ ï¼Œä¹Ÿä¸å…è®¸ move æ‹·è´ï¼Œæœ€åˆäº§ç”Ÿçš„ mutex å¯¹è±¡æ˜¯å¤„äº unlocked çŠ¶æ€çš„ã€‚\nlock()ï¼Œè°ƒç”¨çº¿ç¨‹å°†é”ä½è¯¥äº’æ–¥é‡ã€‚çº¿ç¨‹è°ƒç”¨è¯¥å‡½æ•°ä¼šå‘ç”Ÿä¸‹é¢ 3 ç§æƒ…å†µï¼š(1). å¦‚æœè¯¥äº’æ–¥é‡å½“å‰æ²¡æœ‰è¢«é”ä½ï¼Œåˆ™è°ƒç”¨çº¿ç¨‹å°†è¯¥äº’æ–¥é‡é”ä½ï¼Œç›´åˆ°è°ƒç”¨ unlockä¹‹å‰ï¼Œè¯¥çº¿ç¨‹ä¸€ç›´æ‹¥æœ‰è¯¥é”ã€‚(2). å¦‚æœå½“å‰äº’æ–¥é‡è¢«å…¶ä»–çº¿ç¨‹é”ä½ï¼Œåˆ™å½“å‰çš„è°ƒç”¨çº¿ç¨‹è¢«é˜»å¡ä½ã€‚(3). å¦‚æœå½“å‰äº’æ–¥é‡è¢«å½“å‰è°ƒç”¨çº¿ç¨‹é”ä½ï¼Œåˆ™ä¼šäº§ç”Ÿæ­»é”(deadlock)ã€‚\nunlock()ï¼Œ è§£é”ï¼Œé‡Šæ”¾å¯¹äº’æ–¥é‡çš„æ‰€æœ‰æƒã€‚\ntry_lock()ï¼Œå°è¯•é”ä½äº’æ–¥é‡ï¼Œå¦‚æœäº’æ–¥é‡è¢«å…¶ä»–çº¿ç¨‹å æœ‰ï¼Œåˆ™å½“å‰çº¿ç¨‹ä¹Ÿä¸ä¼šè¢«é˜»å¡ã€‚çº¿ç¨‹è°ƒç”¨è¯¥å‡½æ•°ä¹Ÿä¼šå‡ºç°ä¸‹é¢ 3 ç§æƒ…å†µï¼Œ(1). å¦‚æœå½“å‰äº’æ–¥é‡æ²¡æœ‰è¢«å…¶ä»–çº¿ç¨‹å æœ‰ï¼Œåˆ™è¯¥çº¿ç¨‹é”ä½äº’æ–¥é‡ï¼Œç›´åˆ°è¯¥çº¿ç¨‹è°ƒç”¨ unlock é‡Šæ”¾äº’æ–¥é‡ã€‚(2). å¦‚æœå½“å‰äº’æ–¥é‡è¢«å…¶ä»–çº¿ç¨‹é”ä½ï¼Œåˆ™å½“å‰è°ƒç”¨çº¿ç¨‹è¿”å› falseï¼Œè€Œå¹¶ä¸ä¼šè¢«é˜»å¡æ‰ã€‚(3). å¦‚æœå½“å‰äº’æ–¥é‡è¢«å½“å‰è°ƒç”¨çº¿ç¨‹é”ä½ï¼Œåˆ™ä¼šäº§ç”Ÿæ­»é”(deadlock)ã€‚\n\nä¸‹é¢ç»™å‡ºä¸€ä¸ªä¸ std::mutex çš„å°ä¾‹å­ï¼ˆå‚è€ƒï¼‰\n1234567891011121314151617181920212223242526#include &lt;iostream&gt;       // std::cout#include &lt;thread&gt;         // std::thread#include &lt;mutex&gt;          // std::mutexvolatile int counter(0); // non-atomic counterstd::mutex mtx;           // locks access to countervoid attempt_10k_increases() &#123;    for (int i=0; i&lt;10000; ++i) &#123;        if (mtx.try_lock()) &#123;   // only increase if currently not locked:            ++counter;            mtx.unlock();        &#125;    &#125;&#125;int main (int argc, const char* argv[]) &#123;    std::thread threads[10];    for (int i=0; i&lt;10; ++i)        threads[i] = std::thread(attempt_10k_increases);    for (auto&amp; th : threads) th.join();    std::cout &lt;&lt; counter &lt;&lt; \" successful increases of the counter.\\n\";    return 0;&#125;\nè¾“å‡ºç»“æœï¼š\n123$g++ -lpthread -std=c++11 -o main *.cpp$main9012 successful increases of the counter.\n\nå¯ä»¥çœ‹å‡ºæœ‰å¾ˆå¤šæ¬¡mtx.try_lock()è¿”å›äº†falseï¼Œå¹¶æ²¡æœ‰æ‰§è¡Œ++counteræ“ä½œã€‚\nå¦‚æœæŠŠmtx.try_lock()æ”¹æˆmtx.lock()ï¼Œåˆ™å¿…å®šä¼šé˜»å¡å…¶ä»–çº¿ç¨‹ã€‚\n\nè¾“å‡ºç»“æœ2:\n123$g++ -lpthread -std=c++11 -o main *.cpp$main100000 successful increases of the counter.\nstd::recursive_mutex ä»‹ç»\nstd::recursive_mutex ä¸ std::mutex ä¸€æ ·ï¼Œä¹Ÿæ˜¯ä¸€ç§å¯ä»¥è¢«ä¸Šé”çš„å¯¹è±¡ï¼Œä½†æ˜¯å’Œ std::mutex ä¸åŒçš„æ˜¯ï¼Œstd::recursive_mutex å…è®¸åŒä¸€ä¸ªçº¿ç¨‹å¯¹äº’æ–¥é‡å¤šæ¬¡ä¸Šé”ï¼ˆå³é€’å½’ä¸Šé”ï¼‰ï¼Œæ¥è·å¾—å¯¹äº’æ–¥é‡å¯¹è±¡çš„å¤šå±‚æ‰€æœ‰æƒï¼Œstd::recursive_mutex é‡Šæ”¾äº’æ–¥é‡æ—¶éœ€è¦è°ƒç”¨ä¸è¯¥é”å±‚æ¬¡æ·±åº¦ç›¸åŒæ¬¡æ•°çš„ unlock()ï¼Œå¯ç†è§£ä¸º lock() æ¬¡æ•°å’Œ unlock() æ¬¡æ•°ç›¸åŒï¼Œé™¤æ­¤ä¹‹å¤–ï¼Œstd::recursive_mutex çš„ç‰¹æ€§å’Œ std::mutex å¤§è‡´ç›¸åŒã€‚\n12345678910111213141516171819202122232425#include &lt;iostream&gt;       // std::cout#include &lt;thread&gt;         // std::thread#include &lt;mutex&gt;          // std::mutexvolatile int counter(0); // non-atomic counterstd::recursive_mutex  rmtx;           // locks access to countervoid attempt_1k_increases() &#123;    for (int i=0; i&lt;10000; ++i) &#123;        rmtx.lock();           ++counter;     &#125;    for (int i=0; i&lt;10000; ++i) &#123;         counter-=2;         rmtx.unlock();    &#125;&#125;int main (int argc, const char* argv[]) &#123;    auto th = std::thread(attempt_1k_increases);    th.join();    std::cout &lt;&lt; counter &lt;&lt; \" successful increases of the counter.\\n\";    return 0;&#125;\nè¾“å‡ºç»“æœï¼š\n123$g++ -lpthread -o main *.cpp$main-10000 successful increases of the counter.\nstd::time_mutex ä»‹ç»\nstd::time_mutex æ¯” std::mutex å¤šäº†ä¸¤ä¸ªæˆå‘˜å‡½æ•°ï¼Œtry_lock_for()ï¼Œtry_lock_until()ã€‚\ntry_lock_for å‡½æ•°æ¥å—ä¸€ä¸ªæ—¶é—´èŒƒå›´ï¼Œè¡¨ç¤ºåœ¨è¿™ä¸€æ®µæ—¶é—´èŒƒå›´ä¹‹å†…çº¿ç¨‹å¦‚æœæ²¡æœ‰è·å¾—é”åˆ™è¢«é˜»å¡ä½ï¼ˆä¸ std::mutex çš„ try_lock() ä¸åŒï¼Œtry_lock å¦‚æœè¢«è°ƒç”¨æ—¶æ²¡æœ‰è·å¾—é”åˆ™ç›´æ¥è¿”å› falseï¼‰ï¼Œå¦‚æœåœ¨æ­¤æœŸé—´å…¶ä»–çº¿ç¨‹é‡Šæ”¾äº†é”ï¼Œåˆ™è¯¥çº¿ç¨‹å¯ä»¥è·å¾—å¯¹äº’æ–¥é‡çš„é”ï¼Œå¦‚æœè¶…æ—¶ï¼ˆå³åœ¨æŒ‡å®šæ—¶é—´å†…è¿˜æ˜¯æ²¡æœ‰è·å¾—é”ï¼‰ï¼Œåˆ™è¿”å› falseã€‚\ntry_lock_until å‡½æ•°åˆ™æ¥å—ä¸€ä¸ªæ—¶é—´ç‚¹ä½œä¸ºå‚æ•°ï¼Œåœ¨æŒ‡å®šæ—¶é—´ç‚¹æœªåˆ°æ¥ä¹‹å‰çº¿ç¨‹å¦‚æœæ²¡æœ‰è·å¾—é”åˆ™è¢«é˜»å¡ä½ï¼Œå¦‚æœåœ¨æ­¤æœŸé—´å…¶ä»–çº¿ç¨‹é‡Šæ”¾äº†é”ï¼Œåˆ™è¯¥çº¿ç¨‹å¯ä»¥è·å¾—å¯¹äº’æ–¥é‡çš„é”ï¼Œå¦‚æœè¶…æ—¶ï¼ˆå³åœ¨æŒ‡å®šæ—¶é—´å†…è¿˜æ˜¯æ²¡æœ‰è·å¾—é”ï¼‰ï¼Œåˆ™è¿”å› falseã€‚\nä¸‹é¢çš„å°ä¾‹å­è¯´æ˜äº† std::time_mutex çš„ç”¨æ³•ï¼ˆå‚è€ƒï¼‰ã€‚\n1234567891011121314151617181920212223242526272829#include &lt;iostream&gt;       // std::cout#include &lt;chrono&gt;         // std::chrono::milliseconds#include &lt;thread&gt;         // std::thread#include &lt;mutex&gt;          // std::timed_mutexstd::timed_mutex mtx;void fireworks() &#123;  // waiting to get a lock: each thread prints \"-\" every 200ms:  while (!mtx.try_lock_for(std::chrono::milliseconds(200))) &#123;    std::cout &lt;&lt; \"-\";  &#125;  // got a lock! - wait for 1s, then this thread prints \"*\"  std::this_thread::sleep_for(std::chrono::milliseconds(1000));  std::cout &lt;&lt; \"*\\n\";  mtx.unlock();&#125;int main ()&#123;  std::thread threads[10];  // spawn 10 threads:  for (int i=0; i&lt;10; ++i)    threads[i] = std::thread(fireworks);  for (auto&amp; th : threads) th.join();  return 0;&#125;\nè¾“å‡ºç»“æœï¼š\n\nçº¿ç¨‹è¾“å‡º*è¡¨ç¤ºè¯¥çº¿ç¨‹å·²ç»æ­£å¸¸é€€å‡ºï¼Œå¹¶ä¸”é‡Šæ”¾è¯¥é”ã€‚å¦åˆ™å°†æ¯200mså°è¯•è·å–mutexğŸ”’ï¼Œç›´åˆ°æˆåŠŸä¸ºæ­¢ã€‚\n\nstd::recursive_timed_mutex ä»‹ç»\nå’Œ std:recursive_mutex ä¸ std::mutex çš„å…³ç³»ä¸€æ ·ï¼Œstd::recursive_timed_mutex çš„ç‰¹æ€§ä¹Ÿå¯ä»¥ä» std::timed_mutex æ¨å¯¼å‡ºæ¥ï¼Œæ„Ÿå…´è¶£çš„åŒé‹å¯ä»¥è‡ªè¡ŒæŸ¥é˜…ã€‚ ;-)\nstd::lock_guard ä»‹ç»\nä¸ Mutex RAII ç›¸å…³ï¼Œæ–¹ä¾¿çº¿ç¨‹å¯¹äº’æ–¥é‡ä¸Šé”ã€‚ä¾‹å­ï¼ˆå‚è€ƒï¼‰:\n\n1.std::lock_guard åœ¨æ„é€ å‡½æ•°ä¸­è¿›è¡ŒåŠ é”ï¼Œææ„å‡½æ•°ä¸­è¿›è¡Œè§£é”ã€‚\n2.é”åœ¨å¤šçº¿ç¨‹ç¼–ç¨‹ä¸­ï¼Œä½¿ç”¨è¾ƒå¤šï¼Œå› æ­¤c++11æä¾›äº†lock_guardæ¨¡æ¿ç±»ï¼›åœ¨å®é™…ç¼–ç¨‹ä¸­ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥æ ¹æ®è‡ªå·±çš„åœºæ™¯ç¼–å†™resource_guard RAIIç±»ï¼Œé¿å…å¿˜æ‰é‡Šæ”¾èµ„æºã€‚\n\n12345678910111213141516171819202122232425262728293031323334#include &lt;iostream&gt;       // std::cout#include &lt;thread&gt;         // std::thread#include &lt;mutex&gt;          // std::mutex, std::lock_guard#include &lt;stdexcept&gt;      // std::logic_errorstd::mutex mtx;void print_even (int x) &#123;    if (x%2==0) std::cout &lt;&lt; x &lt;&lt; \" is even\\n\";    else throw (std::logic_error(\"not even\"));&#125;void print_thread_id (int id) &#123;    try &#123;        // using a local lock_guard to lock mtx guarantees unlocking on destruction / exception:        std::lock_guard&lt;std::mutex&gt; lck (mtx);        print_even(id);    &#125;    catch (std::logic_error&amp;) &#123;        std::cout &lt;&lt; \"[exception caught]\\n\";    &#125;&#125;int main ()&#123;    std::thread threads[10];    // spawn 10 threads:    for (int i=0; i&lt;10; ++i)        threads[i] = std::thread(print_thread_id,i+1);    for (auto&amp; th : threads) th.join();    return 0;&#125;\nè¾“å‡ºç»“æœï¼š\n123456789101112$g++ -lpthread -o main *.cpp$main[exception caught]4 is even[exception caught]2 is even[exception caught]6 is even8 is even[exception caught][exception caught]10 is even\nstd::unique_lock ä»‹ç»\nä¸ Mutex RAII ç›¸å…³ï¼Œæ–¹ä¾¿çº¿ç¨‹å¯¹äº’æ–¥é‡ä¸Šé”ï¼Œä½†æä¾›äº†æ›´å¥½çš„ä¸Šé”å’Œè§£é”æ§åˆ¶ã€‚ä¾‹å­ï¼ˆå‚è€ƒï¼‰ï¼š\n\n1.ç±» unique_lock æ˜¯é€šç”¨äº’æ–¥åŒ…è£…å™¨ï¼Œå…è®¸å»¶è¿Ÿé”å®šã€é”å®šçš„æœ‰æ—¶é™å°è¯•ã€é€’å½’é”å®šã€æ‰€æœ‰æƒè½¬ç§»å’Œä¸æ¡ä»¶å˜é‡ä¸€åŒä½¿ç”¨ã€‚\n2.unique_lockæ¯”lock_guardä½¿ç”¨æ›´åŠ çµæ´»ï¼ŒåŠŸèƒ½æ›´åŠ å¼ºå¤§ã€‚\nä½¿ç”¨unique_lockéœ€è¦ä»˜å‡ºæ›´å¤šçš„æ—¶é—´ã€æ€§èƒ½æˆæœ¬ã€‚\n\n12345678910111213141516171819202122232425#include &lt;iostream&gt;       // std::cout#include &lt;thread&gt;         // std::thread#include &lt;mutex&gt;          // std::mutex, std::unique_lockstd::mutex mtx;           // mutex for critical sectionvoid print_block (int n, char c) &#123;    // critical section (exclusive access to std::cout signaled by lifetime of lck):    std::unique_lock&lt;std::mutex&gt; lck (mtx);    for (int i=0; i&lt;n; ++i) &#123;        std::cout &lt;&lt; c;    &#125;    std::cout &lt;&lt; '\\n';&#125;int main ()&#123;    std::thread th1 (print_block,50,'*');    std::thread th2 (print_block,50,'$');    th1.join();    th2.join();    return 0;&#125;\nè¾“å‡ºç»“æœï¼š\n1234$g++ -lpthread -o main *.cpp$main**************************************************$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$\nå¥½äº†ï¼Œæœ¬æ–‡æš‚æ—¶è®²åˆ°è¿™é‡Œï¼Œè¿˜å‰©ä¸‹ std::try_lockï¼Œstd::lockï¼Œstd::call_once ä¸‰ä¸ªå‡½æ•°æ²¡æœ‰è®²åˆ°ï¼Œç•™åœ¨ä¸‹ä¸€ç¯‡åšå®¢ä¸­è®²å§ ;-)\n","thumbnail":"images/background.jpg","plink":"https://shuntan.github.io/post/Mutexä»‹ç»/"},{"title":"squidä»‹ç»åŠå…¶ç®€å•é…ç½®","date":"2019-05-15T07:15:30.000Z","updated":"2019-06-26T02:42:28.427Z","content":"squidçš„æ¦‚å¿µ\nsquidæ˜¯ä¸€ç§ç”¨æ¥ç¼“å­˜Internetæ•°æ®çš„è½¯ä»¶ã€‚æ¥å—æ¥è‡ªäººä»¬éœ€è¦ä¸‹è½½çš„ç›®æ ‡ï¼ˆobjectï¼‰çš„è¯·æ±‚å¹¶é€‚å½“çš„å¤„ç†è¿™äº›è¯·æ±‚ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œå¦‚æœä¸€ä¸ªäººæƒ³ä¸‹è½½ä¸€webç•Œé¢ï¼Œä»–è¯·æ±‚squidä¸ºä»–å–å¾—è¿™ä¸ªé¡µé¢ã€‚squidéšä¹‹è¿æ¥åˆ°è¿œç¨‹æœåŠ¡å™¨å¹¶å‘è¿™ä¸ªé¡µé¢å‘å‡ºè¯·æ±‚ã€‚ç„¶åï¼Œsquidæ˜¾å¼åœ°èšé›†æ•°æ®åˆ°å®¢æˆ·ç«¯æœºå™¨ï¼Œè€Œä¸”åŒæ—¶å¤åˆ¶ä¸€ä»½ã€‚å½“ä¸‹ä¸€æ¬¡æœ‰äººéœ€è¦åŒä¸€é¡µé¢æ—¶ï¼Œ squidå¯ä»¥ç®€å•çš„ä»ç£ç›˜ä¸­è¯»åˆ°å®ƒï¼Œé‚£æ ·æ•°æ®ä¼šç«‹å³ä¼ è¾“åˆ°å®¢æˆ·æœºä¸Šã€‚\n\nä¸‹è½½åœ°å€\nsquid-cache å®˜ç½‘ http://www.squid-cache.org\nsquidä»‹ç»åŠå…¶ç®€å•é…ç½® https://www.cnblogs.com/cherishry/p/5706736.html\nCentOS 7å®‰è£…squidä»£ç†æœåŠ¡å™¨ https://blog.csdn.net/ithomer/article/details/78136993\nsquidä»£ç†çš„ä½œç”¨\n\né€šè¿‡ç¼“å­˜çš„æ–¹å¼ä¸ºç”¨æˆ·æä¾›Webè®¿é—®åŠ é€Ÿ\nå¯¹ç”¨æˆ·çš„Webè®¿é—®è¿›è¡Œè¿‡æ»¤æ§åˆ¶\n\nå·¥ä½œæµç¨‹\nå½“ä»£ç†æœåŠ¡å™¨ä¸­æœ‰å®¢æˆ·ç«¯éœ€è¦çš„æ•°æ®æ—¶ï¼š\na.å®¢æˆ·ç«¯å‘ä»£ç†æœåŠ¡å™¨å‘é€æ•°æ®è¯·æ±‚ï¼›\nb.ä»£ç†æœåŠ¡å™¨æ£€æŸ¥è‡ªå·±çš„æ•°æ®ç¼“å­˜ï¼›\nc.ä»£ç†æœåŠ¡å™¨åœ¨ç¼“å­˜ä¸­æ‰¾åˆ°äº†ç”¨æˆ·æƒ³è¦çš„æ•°æ®ï¼Œå–å‡ºæ•°æ®ï¼›\nd.ä»£ç†æœåŠ¡å™¨å°†ä»ç¼“å­˜ä¸­å–å¾—çš„æ•°æ®è¿”å›ç»™å®¢æˆ·ç«¯ã€‚\nå½“ä»£ç†æœåŠ¡å™¨ä¸­æ²¡æœ‰å®¢æˆ·ç«¯éœ€è¦çš„æ•°æ®æ—¶äº†ï¼š\n1.å®¢æˆ·ç«¯å‘ä»£ç†æœåŠ¡å™¨å‘é€æ•°æ®è¯·æ±‚ï¼›\n2.ä»£ç†æœåŠ¡å™¨æ£€æŸ¥è‡ªå·±çš„æ•°æ®ç¼“å­˜ï¼›\n3.ä»£ç†æœåŠ¡å™¨åœ¨ç¼“å­˜ä¸­æ²¡æœ‰æ‰¾åˆ°ç”¨æˆ·æƒ³è¦çš„æ•°æ®ï¼›\n4.ä»£ç†æœåŠ¡å™¨å‘Internet ä¸Šçš„è¿œç«¯æœåŠ¡å™¨å‘é€æ•°æ®è¯·æ±‚ï¼›\n5.è¿œç«¯æœåŠ¡å™¨å“åº”ï¼Œè¿”å›ç›¸åº”çš„æ•°æ®ï¼›\n6.ä»£ç†æœåŠ¡å™¨å–å¾—è¿œç«¯æœåŠ¡å™¨çš„æ•°æ®ï¼Œè¿”å›ç»™å®¢æˆ·ç«¯ï¼Œå¹¶ä¿ç•™ä¸€ä»½åˆ°è‡ªå·±çš„æ•°æ®ç¼“å­˜ä¸­ã€‚\n\nSquidä»£ç†æœåŠ¡å™¨å·¥ä½œåœ¨TCP/IPåº”ç”¨å±‚\n\nSquidå„ç§ä»£ç†çš„å®šä¹‰\næ­£å‘ä»£ç†\næ ‡å‡†çš„ä»£ç†ç¼“å†²æœåŠ¡å™¨\nä¸€ä¸ªæ ‡å‡†çš„ä»£ç†ç¼“å†²æœåŠ¡è¢«ç”¨äºç¼“å­˜é™æ€çš„ç½‘é¡µåˆ°æœ¬åœ°ç½‘ç»œä¸Šçš„ä¸€å°ä¸»æœºä¸Šï¼ˆå³ä»£ç†æœåŠ¡å™¨ï¼‰ã€‚å½“è¢«ç¼“å­˜çš„é¡µé¢è¢«ç¬¬äºŒæ¬¡è®¿é—®çš„æ—¶å€™ï¼Œæµè§ˆå™¨å°†ç›´æ¥ä»æœ¬åœ°ä»£ç†æœåŠ¡å™¨é‚£é‡Œè·å–è¯·æ±‚æ•°æ®è€Œä¸å†å‘åŸwebç«™ç‚¹è¯·æ±‚æ•°æ®ã€‚è¿™æ ·å°±èŠ‚çœäº†å®è´µçš„ç½‘ç»œå¸¦å®½ï¼Œè€Œä¸”æé«˜äº†è®¿é—®é€Ÿåº¦ã€‚ä½†æ˜¯ï¼Œè¦æƒ³å®ç°è¿™ç§æ–¹å¼ï¼Œå¿…é¡»åœ¨æ¯ä¸€ä¸ªå†…éƒ¨ä¸»æœºçš„æµè§ˆå™¨ä¸Šæ˜ç¡®æŒ‡åä»£ç†æœåŠ¡å™¨çš„IPåœ°å€å’Œç«¯å£å·ã€‚å®¢æˆ·ç«¯ä¸Šç½‘æ—¶ï¼Œæ¯æ¬¡éƒ½æŠŠè¯·æ±‚å‘é€ç»™ä»£ç†æœåŠ¡å™¨å¤„ç†,ä»£ç†æœåŠ¡å™¨æ ¹æ®è¯·æ±‚ç¡®å®šæ˜¯å¦è¿æ¥åˆ°è¿œç¨‹webæœåŠ¡å™¨è·å–æ•°æ®ã€‚å¦‚æœåœ¨æœ¬åœ°ç¼“å†²åŒºæœ‰ç›®æ ‡æ–‡ä»¶ï¼Œåˆ™ç›´æ¥å°†æ–‡ä»¶ä¼ ç»™ç”¨æˆ·å³å¯ã€‚å¦‚æœæ²¡æœ‰çš„è¯åˆ™å…ˆå–å›æ–‡ä»¶ï¼Œå…ˆåœ¨æœ¬åœ°ä¿å­˜ä¸€ä»½ç¼“å†²ï¼Œç„¶åå°†æ–‡ä»¶å‘é€ç»™å®¢æˆ·ç«¯æµè§ˆå™¨ã€‚\né€æ˜ä»£ç†ç¼“å†²æœåŠ¡å™¨\né€æ˜ä»£ç†ç¼“å†²æœåŠ¡å™¨å’Œæ ‡å‡†ä»£ç†æœåŠ¡å™¨çš„åŠŸèƒ½å®Œå…¨ç›¸åŒã€‚ä½†æ˜¯ï¼Œä»£ç†æ“ä½œå¯¹å®¢æˆ·ç«¯çš„æµè§ˆå™¨æ˜¯é€æ˜çš„ï¼ˆå³ä¸éœ€æŒ‡æ˜ä»£ç†æœåŠ¡å™¨çš„IPå’Œç«¯å£ï¼‰ã€‚é€æ˜ä»£ç†æœåŠ¡å™¨é˜»æ–­ç½‘ç»œé€šä¿¡ï¼Œå¹¶ä¸”è¿‡æ»¤å‡ºè®¿é—®å¤–éƒ¨çš„HTTPï¼ˆ80ç«¯å£ï¼‰æµé‡ã€‚å¦‚æœå®¢æˆ·ç«¯çš„è¯·æ±‚åœ¨æœ¬åœ°æœ‰ç¼“å†²åˆ™å°†ç¼“å†²çš„æ•°æ®ç›´æ¥å‘ç»™ç”¨æˆ·ï¼Œå¦‚æœåœ¨æœ¬åœ°æ²¡æœ‰ç¼“å†²åˆ™å‘è¿œç¨‹webæœåŠ¡å™¨å‘å‡ºè¯·æ±‚ï¼Œå…¶ä½™æ“ä½œå’Œæ ‡å‡†çš„ä»£ç†æœåŠ¡å™¨å®Œå…¨ç›¸åŒã€‚å¯¹äºlinuxæ“ä½œç³»ç»Ÿæ¥è¯´ï¼Œé€æ˜ä»£ç†ä½¿ç”¨Iptablesæˆ–è€…Ipchainså®ç°ã€‚å› æ­¤ä¸éœ€è¦å¯¹æµè§ˆå™¨ä½œä»»ä½•è®¾ç½®ï¼Œæ‰€ä»¥ï¼Œé€æ˜ä»£ç†å¯¹äºISPï¼ˆInternetæœåŠ¡å™¨æä¾›å•†ï¼‰ç‰¹åˆ«æœ‰ç”¨ã€‚\nåå‘ä»£ç†\nåå‘ä»£ç†ç¼“å†²å™¨\nåå‘ä»£ç†æ˜¯å’Œå‰ä¸¤ç§ä»£ç†å®Œå…¨ä¸åŒçš„ä¸€ç§ä»£ç†æœåŠ¡ã€‚ä½¿ç”¨å®ƒå¯ä»¥é™ä½åŸå§‹WEBæœåŠ¡å™¨çš„è´Ÿè½½ã€‚åå‘ä»£ç†æœåŠ¡å™¨æ‰¿æ‹…äº†å¯¹åŸå§‹WEBæœåŠ¡å™¨çš„é™æ€é¡µé¢çš„è¯·æ±‚ï¼Œé˜²æ­¢åŸå§‹æœåŠ¡å™¨è¿‡è½½ã€‚å®ƒä½äºWEBæœåŠ¡å™¨å’ŒInternetä¹‹é—´ï¼Œå¤„ç†æ‰€æœ‰å¯¹WEBæœåŠ¡å™¨çš„è¯·æ±‚ï¼Œç»„ç»‡äº†WEBæœåŠ¡å™¨å’ŒInternetçš„ç›´æ¥é€šä¿¡ã€‚å¦‚æœäº’è”ç½‘ç”¨æˆ·è¯·æ±‚çš„é¡µé¢åœ¨ä»£ç†æœåŠ¡å™¨ä¸Šæœ‰ç¼“å†²çš„è¯ï¼Œä»£ç†æœåŠ¡å™¨ç›´æ¥å°†ç¼“å†²å†…å®¹å‘é€ç»™ç”¨æˆ·ã€‚å¦‚æœæ²¡æœ‰ç¼“å†²åˆ™å…ˆå‘WEBæœåŠ¡å™¨å‘å‡ºè¯·æ±‚ï¼Œå–å›æ•°æ®ï¼Œæœ¬åœ°ç¼“å­˜åå†å‘ç»™ç”¨æˆ·ã€‚è¿™ç§æ–¹å¼é€šè¿‡é™ä½äº†WEBæœåŠ¡å™¨çš„è¯·æ±‚æ•°ä»è€Œé™ä½äº†WEBæœåŠ¡å™¨çš„è´Ÿè½½ã€‚\næ­£å‘ä»£ç†ä¸åå‘ä»£ç†çš„åŒºåˆ«\næ¦‚å¿µ\næ­£å‘ä»£ç†ï¼šå¯¹äºåŸå§‹æœåŠ¡å™¨è€Œè¨€ï¼Œå°±æ˜¯å®¢æˆ·ç«¯çš„ä»£è¨€äºº\nåå‘ä»£ç†ï¼šå¯¹äºå®¢æˆ·ç«¯è€Œè¨€ï¼Œå°±åƒæ˜¯åŸå§‹æœåŠ¡å™¨\nç”¨é€”\næ­£å‘ä»£ç†çš„å…¸å‹ç”¨é€”æ˜¯ä¸ºåœ¨é˜²ç«å¢™å†…çš„å±€åŸŸç½‘å®¢æˆ·ç«¯æä¾›è®¿é—®Internetçš„é€”å¾„ã€‚æ­£å‘ä»£ç†è¿˜å¯ä»¥ä½¿ç”¨ç¼“å†²ç‰¹æ€§å‡å°‘ç½‘ç»œä½¿ç”¨ç‡ã€‚\nåå‘ä»£ç†è¿˜å¯ä»¥ä¸ºåç«¯çš„å¤šå°æœåŠ¡å™¨æä¾›è´Ÿè½½å¹³è¡¡ï¼Œæˆ–ä¸ºåç«¯è¾ƒæ…¢çš„æœåŠ¡å™¨æä¾›ç¼“å†²æœåŠ¡ã€‚å¦å¤–ï¼Œåå‘ä»£ç†è¿˜å¯ä»¥å¯ç”¨é«˜çº§URLç­–ç•¥å’Œç®¡ç†æŠ€æœ¯ï¼Œä»è€Œä½¿å¤„äºä¸åŒwebæœåŠ¡å™¨ç³»ç»Ÿçš„webé¡µé¢åŒæ—¶å­˜åœ¨äºåŒä¸€ä¸ªURLç©ºé—´ä¸‹ã€‚\nå®‰å…¨æ€§\næ­£å‘ä»£ç†å…è®¸å®¢æˆ·ç«¯é€šè¿‡å®ƒè®¿é—®ä»»æ„ç½‘ç«™å¹¶ä¸”éšè—å®¢æˆ·ç«¯è‡ªèº«ï¼Œå› æ­¤ä½ å¿…é¡»é‡‡å–å®‰å…¨æªæ–½ä»¥ç¡®ä¿ä»…ä¸ºç»è¿‡æˆæƒçš„å®¢æˆ·ç«¯æä¾›æœåŠ¡ã€‚\nåå‘ä»£ç†å¯¹å¤–éƒ½æ˜¯é€æ˜çš„ï¼Œè®¿é—®è€…å¹¶ä¸çŸ¥é“è‡ªå·±è®¿é—®çš„æ˜¯ä¸€ä¸ªä»£ç†ã€‚\nSquidä¸»è¦ç»„æˆéƒ¨åˆ†\næœåŠ¡åï¼šsquid\nä¸»ç¨‹åºï¼š/usr/sbin/squid\né…ç½®ç›®å½•ï¼š/etc/squid\nä¸»é…ç½®æ–‡ä»¶ï¼š/etc/squid/squid.conf\nç›‘å¬tcpç«¯å£å·ï¼š3128\né»˜è®¤è®¿é—®æ—¥å¿—æ–‡ä»¶ï¼š/var/log/squid/access.log\nsquidå¸¸ç”¨é…ç½®é€‰é¡¹\n/etc/squid/squid.conf\n123456789101112131415http_port 3128  (è¿˜å¯ä»¥åªç›‘å¬ä¸€ä¸ªIP http_port 192.168.0.1:3128)cache_mem 64MB  #ç¼“å­˜å å†…å­˜å¤§å°maximum_object_size 4096KB  #æœ€å¤§ç¼“å­˜å—reply_body_max_size  1024000 allow all      #é™å®šä¸‹è½½æ–‡ä»¶å¤§å°access_log /var/log/squid/access.log    #è®¿é—®æ—¥å¿—å­˜æ”¾çš„åœ°æ–¹visible_hostname    proxy.test.xom  #å¯è§çš„ä¸»æœºåcache_dir ufs /var/spool/squid  100 16 256 #ufs:ç¼“å­˜æ•°æ®çš„å­˜å‚¨æ ¼å¼#/var/spool/squid    ç¼“å­˜ç›®å½•#100ï¼šç¼“å­˜ç›®å½•å ç£ç›˜ç©ºé—´å¤§å°ï¼ˆMï¼‰#16ï¼šç¼“å­˜ç©ºé—´ä¸€çº§å­ç›®å½•ä¸ªæ•°#256ï¼šç¼“å­˜ç©ºé—´äºŒçº§å­ç›®å½•ä¸ªæ•°cache_mgr webmaster@test.com    #å®šä¹‰ç®¡ç†å‘˜é‚®ç®±http_access deny all    #è®¿é—®æ§åˆ¶\nsquidä¸­çš„è®¿é—®æ§åˆ¶\nä½¿ç”¨è®¿é—®æ§åˆ¶ç‰¹æ€§ï¼Œå¯ä»¥æ§åˆ¶åœ¨è®¿é—®æ—¶æ ¹æ®ç‰¹å®šçš„æ—¶é—´é—´éš”è¿›è¡Œç¼“å­˜ã€è®¿é—®ç‰¹å®šç«™ç‚¹æˆ–ä¸€ç»„ç«™ç‚¹ç­‰ç­‰ã€‚squidè®¿é—®æ§åˆ¶æœ‰ä¸¤ä¸ªè¦ç´ ï¼šACLå…ƒç´ å’Œè®¿é—®åˆ—è¡¨ã€‚è®¿é—®åˆ—è¡¨å¯ä»¥å…è®¸æˆ–æ‹’ç»æŸäº›ç”¨æˆ·å¯¹æ­¤æœåŠ¡çš„è®¿é—®ã€‚\nACLå…ƒç´ ç±»å‹\n\nsrcï¼šæºåœ°å€ï¼ˆå³å®¢æˆ·æœºIPåœ°å€ï¼‰\ndstï¼šç›®æ ‡åœ°å€ï¼ˆå³æœåŠ¡å™¨IPåœ°å€ï¼‰\nsrcdomainï¼šæºåç§°ï¼ˆå³å®¢æˆ·æœºåç§°ï¼‰\ndstdomainï¼šç›®æ ‡åç§°ï¼ˆå³æœåŠ¡å™¨åç§°ï¼‰\ntimeï¼šä¸€å¤©ä¸­çš„æ—¶åˆ»å’Œä¸€å‘¨å†…çš„ä¸€å¤©\nurl_regexï¼šURLè§„åˆ™è¡¨è¾¾å¼åŒ¹é…\nurlpath_regexï¼šURL-pathè§„åˆ™è¡¨è¾¾å¼åŒ¹é…ï¼Œç•¥å»åè®®å’Œä¸»æœºå\nproxy_authï¼šé€šè¿‡å¤–éƒ¨ç¨‹åºè¿›è¡Œç”¨æˆ·éªŒè¯\nmaxconnï¼šå•ä¸€IPçš„æœ€å¤§è¿æ¥æ•°\n\nACLæ ¼å¼\nä¸ºäº†ä½¿ç”¨æ§åˆ¶åŠŸèƒ½ï¼Œå¿…é¡»å…ˆè®¾ç½®ACLè§„åˆ™å¹¶åº”ç”¨ã€‚ACLå£°æ˜çš„æ ¼å¼å¦‚ä¸‹ï¼š\n\næ³¨ï¼š\n\nacl_element_name å¯ä»¥æ˜¯ä»»ä¸€ä¸ªåœ¨ACLä¸­å®šä¹‰çš„åç§°\nä»»ä½•ä¸¤ä¸ªACLå…ƒç´ ä¸èƒ½ç”¨ç›¸åŒçš„åå­—\næ¯ä¸ªACLç”±åˆ—è¡¨å€¼ç»„æˆã€‚å½“è¿›è¡ŒåŒ¹é…æ£€æµ‹çš„æ—¶å€™ï¼Œå¤šä¸ªå€¼ç”±é€»è¾‘æˆ–è¿ç®—è¿æ¥ï¼›æ¢è¨€ä¹‹ï¼Œå³ä»»ä¸€ACLå…ƒç´ çš„å€¼è¢«åŒ¹é…ï¼Œåˆ™è¿™ä¸ªACLå…ƒç´ å³è¢«åŒ¹é…ã€‚\nå¹¶ä¸æ˜¯æ‰€æœ‰ACLå…ƒç´ éƒ½èƒ½ä½¿ç”¨è®¿é—®åˆ—è¡¨ä¸­çš„å…¨éƒ¨ç±»å‹\nä¸åŒçš„ACLå…ƒç´ å†™åœ¨ä¸åŒè¡Œä¸­ï¼Œsquidå°†æŠŠä»–ä»¬ç»„åˆåœ¨ä¸€ä¸ªåˆ—è¡¨ä¸­\n\nè®¿é—®æ¡ç›®\næˆ‘ä»¬å¯ä»¥ä½¿ç”¨è®¸å¤šä¸åŒçš„è®¿é—®æ¡ç›®ã€‚ä¸‹é¢æ˜¯æˆ‘ä»¬å¸¸ç”¨çš„å‡ ä¸ªï¼š\n\nhttp_access:å…è®¸HTTPè®¿é—®\nno_cache:å®šä¹‰å¯¹ç¼“å­˜è¯·æ±‚çš„å“åº”ã€‚\nè®¿é—®åˆ—è¡¨çš„è§„åˆ™ç”±ä¸€äº›ç±»ä¼¼â€™allowâ€™æˆ–â€˜denyâ€™çš„å…³é”®å­—æ„æˆï¼Œç”¨ä»¥å…è®¸æˆ–æ‹’ç»å‘ç‰¹å®šæˆ–ä¸€ç»„ACLå…ƒç´ æä¾›æœåŠ¡ã€‚\n\n\nä¸€ä¸ªè®¿é—®åˆ—è¡¨å¯ä»¥ç”±å¤šæ¡è§„åˆ™ç»„æˆ\nå¦‚æœæ²¡æœ‰ä»»ä½•è§„åˆ™ä¸è®¿é—®è¯·æ±‚åŒ¹é…ï¼Œé»˜è®¤åŠ¨ä½œå°†ä¸åˆ—è¡¨ä¸­æœ€åä¸€æ¡è§„åˆ™å¯¹åº”ã€‚\nä¸€ä¸ªè®¿é—®æ¡ç›®ä¸­æ‰€æœ‰å…ƒç´ å°†ç”¨é€»è¾‘ä¸è¿ç®—è¿æ¥\nhttp_access Action å£°æ˜1 AND å£°æ˜2 AND å£°æ˜ OR.\nhttp_access Action å£°æ˜3\nå¤šä¸ªhttp_accessså£°æ˜é—´ç”¨æˆ–è¿ç®—è¿æ¥ï¼Œä½†æ¯ä¸ªè®¿é—®æ¡ç›®çš„å…ƒç´ é—´ç”¨ä¸è¿ç®—è¿æ¥ã€‚\nåˆ—è¡¨ä¸­çš„è§„åˆ™æ€»æ˜¯éµå¾ªç”±ä¸Šè€Œä¸‹çš„é¡ºåº\nè¿™äº›è§„åˆ™æŒ‰ç…§ä»–ä»¬çš„æ’åˆ—é¡ºåºè¿›è¡ŒåŒ¹é…æ£€æµ‹ï¼Œä¸€æ—¦æ£€æµ‹åˆ°åŒ¹é…çš„è§„åˆ™ï¼ŒåŒ¹é…å°±ç«‹å³ç»“æŸã€‚\n\nSquid.confé…ç½®æ–‡ä»¶è¯¦è§£\n123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129130131132133134135136137138139140141142143144145146147148149150151152153154155156#acl all src 0.0.0.0/0.0.0.0 and http_access allow allé€‰é¡¹å®šä¹‰äº†ä¸€ä¸ªè®¿é—®æ§åˆ¶åˆ—è¡¨ã€‚è¯¦ç»†æƒ…å†µå‚è§å’ŒSquidè½¯ä»¶#æºå¸¦çš„æ–‡æ¡£ã€‚è¿™é‡Œçš„è®¿é—®æ§åˆ¶åˆ—è¡¨å…è®¸æ‰€æœ‰å¯¹ä»£ç†æœåŠ¡çš„è®¿é—®ï¼Œå› ä¸ºè¿™é‡Œè¯¥ä»£ç†æ˜¯åŠ é€ŸwebæœåŠ¡å™¨ã€‚acl all src 0.0.0.0/0.0.0.0                 #å…è®¸æ‰€æœ‰IPè®¿é—®acl manager proto http                 #manager urlåè®®ä¸ºhttpacl localhost src 127.0.0.1/255.255.255.255  #å…åˆæœ¬æœºIPacl to_localhost dst 127.0.0.1                 #å…åˆç›®çš„åœ°å€ä¸ºæœ¬æœºIPacl Safe_ports port 80                # å…è®¸å®‰å…¨æ›´æ–°çš„ç«¯å£ä¸º80acl CONNECT method CONNECT        #è¯·æ±‚æ–¹æ³•ä»¥CONNECThttp_access allow all                #å…è®¸æ‰€æœ‰äººä½¿ç”¨è¯¥ä»£ç†.å› ä¸ºè¿™é‡Œæ˜¯ä»£ç†åŠ é€ŸwebæœåŠ¡å™¨http_reply_access allow all                #å…è®¸æ‰€æœ‰å®¢æˆ·ç«¯ä½¿ç”¨è¯¥ä»£ç†acl OverConnLimit maxconn 16        #é™åˆ¶æ¯ä¸ªIPæœ€å¤§å…è®¸16ä¸ªè¿æ¥ï¼Œé˜²æ­¢æ”»å‡»http_access deny OverConnLimiticp_access deny all                        #ç¦æ­¢ä»é‚»å±…æœåŠ¡å™¨ç¼“å†²å†…å‘é€å’Œæ¥æ”¶ICPè¯·æ±‚.miss_access allow all                #å…è®¸ç›´æ¥æ›´æ–°è¯·æ±‚ident_lookup_access deny all                                #ç¦æ­¢lookupæ£€æŸ¥DNShttp_port 8080 transparent                                #æŒ‡å®šSquidç›‘å¬æµè§ˆå™¨å®¢æˆ·è¯·æ±‚çš„ç«¯å£å·ã€‚hierarchy_stoplist cgi-bin ?                #ç”¨æ¥å¼ºåˆ¶æŸäº›ç‰¹å®šçš„å¯¹è±¡ä¸è¢«ç¼“å­˜ï¼Œä¸»è¦æ˜¯å¤„äºå®‰å…¨çš„ç›®çš„ã€‚acl QUERY urlpath_regex cgi-bin \\?cache deny QUERYcache_mem 1 GB        #è¿™æ˜¯ä¸€ä¸ªä¼˜åŒ–é€‰é¡¹ï¼Œå¢åŠ è¯¥å†…å­˜å€¼æœ‰åˆ©äºç¼“å­˜ã€‚åº”è¯¥æ³¨æ„çš„æ˜¯ï¼š                     #ä¸€èˆ¬æ¥è¯´å¦‚æœç³»ç»Ÿæœ‰å†…å­˜ï¼Œè®¾ç½®è¯¥å€¼ä¸º(n/)3Mã€‚ç°åœ¨æ˜¯3G æ‰€ä»¥è¿™é‡Œ1Gfqdncache_size 1024        #FQDN é«˜é€Ÿç¼“å­˜å¤§å°maximum_object_size_in_memory 2 MB        #å…è®¸æœ€å¤§çš„æ–‡ä»¶è½½å…¥å†…å­˜memory_replacement_policy heap LFUDA  #åŠ¨æ€ä½¿ç”¨æœ€å°çš„ï¼Œç§»å‡ºå†…å­˜cachecache_replacement_policy heap LFUDA         #åŠ¨æ€ä½¿ç”¨æœ€å°çš„ï¼Œç§»å‡ºç¡¬ç›˜cachecache_dir ufs /home/cache 5000 32 512  #é«˜é€Ÿç¼“å­˜ç›®å½• ufs ç±»å‹ ä½¿ç”¨çš„ç¼“å†²å€¼æœ€å¤§å…åˆ1000MBç©ºé—´ï¼Œ#32ä¸ªä¸€çº§ç›®å½•ï¼Œ512ä¸ªäºŒçº§ç›®å½•max_open_disk_fds 0                                 #å…è®¸æœ€å¤§æ‰“å¼€æ–‡ä»¶æ•°é‡,0 æ— é™åˆ¶minimum_object_size 1 KB                         #å…åˆæœ€å°æ–‡ä»¶è¯·æ±‚ä½“å¤§å°maximum_object_size 20 MB                 #å…åˆæœ€å¤§æ–‡ä»¶è¯·æ±‚ä½“å¤§å°cache_swap_low 90                            #æœ€å°å…è®¸ä½¿ç”¨swap 90%cache_swap_high 95                            #æœ€å¤šå…è®¸ä½¿ç”¨swap 95%ipcache_size 2048                                # IP åœ°å€é«˜é€Ÿç¼“å­˜å¤§å° 2Mipcache_low 90                                #æœ€å°å…è®¸ipcacheä½¿ç”¨swap 90%ipcache_high 95                                  #æœ€å¤§å…è®¸ipcacheä½¿ç”¨swap 90%access_log /var/log/squid/access.log squid        #å®šä¹‰æ—¥å¿—å­˜æ”¾è®°å½•cache_log /var/log/squid/cache.log squidcache_store_log none                        #ç¦æ­¢storeæ—¥å¿—emulate_httpd_log on        #å°†ä½¿Squidä»¿ç…§WebæœåŠ¡å™¨çš„æ ¼å¼åˆ›å»ºè®¿é—®è®°å½•ã€‚å¦‚æœå¸Œæœ›ä½¿ç”¨                                #Webè®¿é—®è®°å½•åˆ†æç¨‹åºï¼Œå°±éœ€è¦è®¾ç½®è¿™ä¸ªå‚æ•°ã€‚refresh_pattern . 0 20% 4320 override-expire override-lastmod reload-into-ims ignore-reload   #æ›´æ–°cacheè§„åˆ™acl buggy_server url_regex ^http://.... http://          #åªå…è®¸httpçš„è¯·æ±‚broken_posts allow buggy_serveracl apache rep_header Server ^Apache                 #å…è®¸apacheçš„ç¼–ç broken_vary_encoding allow apacherequest_entities off                                        #ç¦æ­¢éhttpçš„æ ‡åˆ†å‡†è¯·æ±‚ï¼Œé˜²æ­¢æ”»å‡»header_access header allow all                        #å…è®¸æ‰€æœ‰çš„httpæŠ¥å¤´relaxed_header_parser on                                #ä¸ä¸¥æ ¼åˆ†æhttpæŠ¥å¤´.client_lifetime 120 minute                                #æœ€å¤§å®¢æˆ·è¿æ¥æ—¶é—´ 120åˆ†é’Ÿcache_mgr sky@test.com                        #æŒ‡å®šå½“ç¼“å†²å‡ºç°é—®é¢˜æ—¶å‘ç¼“å†²ç®¡ç†è€…å‘é€å‘Šè­¦ä¿¡æ¯çš„åœ°å€ä¿¡æ¯ã€‚cache_effective_user squid                        #è¿™é‡Œä»¥ç”¨æˆ·squidçš„èº«ä»½SquidæœåŠ¡å™¨cache_effective_group squidicp_port 0                       #æŒ‡å®šSquidä»é‚»å±…æœåŠ¡å™¨ç¼“å†²å†…å‘é€å’Œæ¥æ”¶ICPè¯·æ±‚çš„ç«¯å£å·ã€‚                     #è¿™é‡Œè®¾ç½®ä¸º0æ˜¯å› ä¸ºè¿™é‡Œé…ç½®Squidä¸ºå†…éƒ¨WebæœåŠ¡å™¨çš„åŠ é€Ÿå™¨ï¼Œ                     #æ‰€ä»¥ä¸éœ€è¦ä½¿ç”¨é‚»å±…æœåŠ¡å™¨çš„ç¼“å†²ã€‚0æ˜¯ç¦ç”¨# cache_peer è®¾ç½®å…è®¸æ›´æ–°ç¼“å­˜çš„ä¸»æœºï¼Œå› æ˜¯æœ¬æœºæ‰€ä»¥127.0.0.1cache_peer 127.0.0.1 parent 80 0 no-query default multicast-responder no-netdb-exchangecache_peer_domain 127.0.0.1                                 hostname_aliases 127.0.0.1error_directory /usr/share/squid/errors/Simplify_Chinese        #å®šä¹‰é”™è¯¯è·¯å¾„always_direct allow all                # cacheä¸¢å¤±æˆ–ä¸å­˜åœ¨æ˜¯å…è®¸æ‰€æœ‰è¯·æ±‚ç›´æ¥è½¬å‘åˆ°åŸå§‹æœåŠ¡å™¨ignore_unknown_nameservers on        #å¼€åDNSæŸ¥è¯¢ï¼Œå½“åŸŸååœ°å€ä¸ç›¸åŒæ—¶å€™ï¼Œç¦æ­¢è®¿é—®coredump_dir  /var/log/squid                 #å®šä¹‰dumpçš„ç›®å½•max_filedesc 2048                #æœ€å¤§æ‰“å¼€çš„æ–‡ä»¶æè¿°half_closed_clients off        #ä½¿Squidåœ¨å½“readä¸å†è¿”å›æ•°æ®æ—¶ç«‹å³å…³é—­å®¢æˆ·ç«¯çš„è¿æ¥ã€‚                                #æœ‰æ—¶readä¸å†è¿”å›æ•°æ®æ˜¯ç”±äºæŸäº›å®¢æˆ·å…³é—­TCPçš„å‘é€æ•°æ®                                #è€Œä»ç„¶ä¿æŒæ¥æ”¶æ•°æ®ã€‚è€ŒSquidåˆ†è¾¨ä¸å‡ºTCPåŠå…³é—­å’Œå®Œå…¨å…³é—­ã€‚buffered_logs on #è‹¥æ‰“å¼€é€‰é¡¹â€œbuffered_logsâ€å¯ä»¥ç¨ç¨æé«˜åŠ é€ŸæŸäº›å¯¹æ—¥å¿—æ–‡ä»¶çš„å†™å…¥ï¼Œè¯¥é€‰é¡¹ä¸»è¦æ˜¯å®ç°ä¼˜åŒ–ç‰¹æ€§ã€‚#é˜²æ­¢å¤©æ¶¯ç›—é“¾ï¼Œè½¬å«ç»™ç™¾åº¦acl tianya referer_regex -i tianyahttp_access deny tianyadeny_info  tianya#é˜»æ­¢baiduèœ˜è››acl baidu req_header User-Agent Baiduspiderhttp_access deny baidu#é™åˆ¶åŒä¸€IPå®¢æˆ·ç«¯çš„æœ€å¤§è¿æ¥æ•°acl OverConnLimit maxconn 128http_access deny OverConnLimit#é˜²æ­¢è¢«äººåˆ©ç”¨ä¸ºHTTPä»£ç†ï¼Œè®¾ç½®å…è®¸è®¿é—®çš„IPåœ°å€acl myip dst 222.18.63.37http_access deny !myip#å…è®¸æœ¬åœ°ç®¡ç†acl Manager proto cache_objectacl Localhost src 127.0.0.1 222.18.63.37http_access allow Manager Localhostcachemgr_passwd 53034338 allhttp_access deny Manager#ä»…ä»…å…è®¸80ç«¯å£çš„ä»£ç†acl all src 0.0.0.0/0.0.0.0acl Safe_ports port 80 # httphttp_access deny !Safe_portshttp_access allow all#Squidä¿¡æ¯è®¾ç½®visible_hostname happy.swjtu.edu.cncache_mgr  ooopic2008@qq.com#åŸºæœ¬è®¾ç½®cache_effective_user squidcache_effective_group squidtcp_recv_bufsize 65535 bytes#2.6çš„åå‘ä»£ç†åŠ é€Ÿé…ç½®cache_peer 127.0.0.1 parent 80 0 no-query originserver#é”™è¯¯æ–‡æ¡£error_directory /usr/local/squid/share/errors/Simplify_Chinese#å•å°ä½¿ç”¨ï¼Œä¸ä½¿ç”¨è¯¥åŠŸèƒ½icp_port 0hierarchy_stoplist cgi-bin ?acl QUERY urlpath_regex cgi-bin \\? .php .cgi .avi .wmv .rm .ram .mpg .mpeg .zip .execache deny QUERYacl apache rep_header Server ^Apachebroken_vary_encoding allow apacherefresh_pattern ^ftp:           1440 20%     10080refresh_pattern ^gopher:        1440 0%    1440refresh_pattern .             0    20%     4320cache_store_log nonepid_filename /usr/local/squid/var/logs/squid.pidemulate_httpd_log on\nSquidå¸¸ç”¨å‘½ä»¤\n\nåˆå§‹åŒ–åœ¨squid.confé‡Œé…ç½®çš„cacheç›®å½•\nsquid -z\nå¦‚æœæœ‰é”™è¯¯æç¤ºï¼Œè¯·æ£€æŸ¥cacheç›®å½•çš„æƒé™ï¼Œå¯ä»¥æ›´æ”¹ç›®å½•æƒé™\nchown -R squid:squid /cacheç›®å½•\nå¯¹squid.confæ’é”™ï¼Œå³éªŒè¯squid.confçš„è¯­æ³•å’Œé…ç½®\nsquid -k parse\nå¦‚æœåœ¨squid.confä¸­æœ‰è¯­æ³•æˆ–é…ç½®é”™è¯¯ï¼Œè¿™é‡Œä¼šè¿”å›æç¤ºï¼Œè‹¥æ— è¿”å›ï¼Œå°è¯•å¯åŠ¨squid\nå‰å°å¯åŠ¨squidï¼Œå¹¶è¾“å‡ºå¯åŠ¨è¿‡ç¨‹\n/usr/local/squid/sbin/squid -N -d1\nå¦‚æœæœ‰ready to server requesç›¸å…³ä¿¡æ¯ï¼Œè¯´æ˜squidå¯åŠ¨æˆåŠŸ\nç„¶åctrl+c ,åœæ­¢squid,å¹¶ä»¥åå°è¿è¡Œçš„æ–¹å¼å¯åŠ¨å®ƒ\nå¯åŠ¨squidåœ¨åå°è¿è¡Œ\nsquid -s\nå¯ä»¥ä½¿ç”¨ps -ax | grep squid æ¥æŸ¥çœ‹squidè¿›ç¨‹æ˜¯å¦å­˜åœ¨\nåœæ­¢squid\nsquid -k shutdown\né‡æ–°å¼•å¯¼ä¿®æ”¹è¿‡çš„squid.conf\nsquid -k reconfigure -f /XXX/squid.conf\nå½“squidè¿›è¡Œé…ç½®æ›´æ”¹åï¼Œå¯ä»¥ä½¿ç”¨è¯¥å‘½ä»¤è¿›è¡Œsquidé…ç½®é‡è½½\næŠŠsquidæ·»åŠ åˆ°ç³»ç»Ÿå¯åŠ¨é¡¹\nvim /etc/rc.local\n/usr/local/squid/sbin/squid -s\nä¿®æ”¹cacheç¼“å­˜ç›®å½•çš„æƒé™\nchown -R squid.squid /cacheç›®å½•\ncacheç¼“å­˜ç›®å½•æ ¹æ®è‡ªå·±çš„é…ç½®æ›´æ”¹ï¼Œsquidç”¨æˆ·å’Œç»„æ˜¯squidï¼Œsquid\nä¿®æ”¹squidæ—¥å¿—ç›®å½•çš„æƒé™\nchown -R squid.squid å®šä¹‰çš„æ—¥å¿—æ–‡ä»¶æ‰€åœ¨ç›®å½•\nè¿™ä¸€æ­¥å¹¶ä¸æ˜¯é€‚åˆæ¯ä¸€ä¸ªä½¿ç”¨squidçš„ç”¨æˆ·ï¼Œæ„ä¸ºè®©squidæœ‰æƒé™åœ¨è¯¥ç›®å½•é‡Œè¿›è¡Œå†™æ“ä½œ\næŸ¥çœ‹ä½ çš„æ—¥å¿—æ–‡æ¡£\nmore /usr/local/squid/var/logs/access.log | grep TCP_MEM_HIT\nè¯¥æŒ‡ä»¤å¯ä»¥çœ‹åˆ°åœ¨squidè¿è¡Œè¿‡ç¨‹ä¸­ï¼Œæœ‰é‚£äº›æ–‡ä»¶è¢«squidç¼“å­˜åˆ°å†…å­˜ä¸­ï¼Œå¹¶è¿”å›ç»™è®¿é—®ç”¨æˆ·ã€‚\nmore /usr/local/squid/var/logs/access.log | grep TCP_HIT\nè¯¥æŒ‡ä»¤å¯ä»¥çœ‹åˆ°åœ¨squidè¿è¡Œè¿‡ç¨‹ä¸­ï¼Œæœ‰é‚£äº›æ–‡ä»¶è¢«squidç¼“å­˜åˆ°cacheç›®å½•ä¸­ï¼Œå¹¶è¿”å›ç»™è®¿é—®ç”¨æˆ·ã€‚\nmore /usr/local/squid/var/logs/access.log | grep TCP_MISS\nè¯¥æŒ‡ä»¤å¯ä»¥çœ‹åˆ°åœ¨squidè¿è¡Œè¿‡ç¨‹ä¸­ï¼Œæœ‰é‚£äº›æ–‡ä»¶æ²¡æœ‰è¢«squidç¼“å­˜ï¼Œè€Œæ˜¯ä»åŸå§‹æœåŠ¡å™¨è·å–å¹¶è¿”å›ç»™è®¿é—®ç”¨æˆ·ã€‚\n\nSquidå‘½ä¸­ç‡åˆ†æ\n12/usr/local/squid/bin/squidclient -p 80 mgr:info/usr/local/squid/bin/squidclient -p 80 mgr:5min\nå¯ä»¥çœ‹åˆ°è¯¦ç»†çš„æ€§èƒ½æƒ…å†µ,å…¶ä¸­PORTæ˜¯ä½ çš„proxyçš„ç«¯å£ï¼Œ5minå¯ä»¥æ˜¯60min\nå–å¾—squidè¿è¡ŒçŠ¶æ€ä¿¡æ¯ï¼š\n1squidclient -p 80 mgr:info\nå–å¾—squidå†…å­˜ä½¿ç”¨æƒ…å†µï¼š\n1squidclient -p 80 mgr:mem\nå–å¾—squidå·²ç»ç¼“å­˜çš„åˆ—è¡¨ï¼š\n1squidclient -p 80 mgr:bjects. use it carefully,it may crash\nå–å¾—squidçš„ç£ç›˜ä½¿ç”¨æƒ…å†µï¼š\n1squidclient -p 80 mgr:diskd\nå¼ºåˆ¶æ›´æ–°æŸä¸ªurlï¼š\n1squidclient -p 80 -m PURGE http://www.xxx.com/xxx.php\næ›´å¤šçš„è¯·æŸ¥çœ‹ï¼šsquidclient-h æˆ–è€… squidclient -p 80 mgr:\næŸ¥å‘½ä¸­ç‡ï¼š\n1squidclient -h IP(å…·ä½“ä¾¦å¬IP) -p 80(å…·ä½“ä¾¦å¬ç«¯å£) mgr:info\nå®šæœŸæ¸…ç†swap.stateå†…æ— æ•ˆæ•°æ®\n123/path/to/squid/sbin/squid -k rotate -f /path/to/squid/conf_filevi /etc/crontab0        0       *       *       *       root    /usr/local/sbin/squid -k rotate -f /usr/local/etc/squid/squid1.conf\nå½“squidåº”ç”¨è¿è¡Œäº†ä¸€æ®µæ—¶é—´ä¹‹åï¼Œcache_dirå¯¹åº”çš„swap.stateæ–‡ä»¶å°±ä¼šå˜å¾—è¶Šæ¥è¶Šå¤§ï¼Œé‡Œé¢çš„æ— æ•ˆæ¥å£æ•°æ®è¶Šæ¥è¶Šå¤šï¼Œè¿™å¯èƒ½å½±å“squidçš„å“åº”æ—¶é—´ï¼Œå› æ­¤éœ€è¦ä½¿ç”¨squidæ¸…ç†swap.stateé‡Œé¢çš„æ— æ•ˆæ•°æ®ï¼Œå‡å°‘swap.stateçš„å¤§å°ã€‚\n","plink":"https://shuntan.github.io/post/squid/"},{"title":"test","date":"2019-06-21T08:42:38.000Z","updated":"2019-06-21T08:49:37.909Z","content":"","plink":"https://shuntan.github.io/about/"}]